<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Route inspector</title>
    <script type="importmap">
      {
        "imports": {
          "preact": "https://esm.sh/preact@10.23.1",
          "preact/": "https://esm.sh/preact@10.23.1/",
          "@preact/signals": "https://esm.sh/@preact/signals@1.3.0?external=preact",
          "htm/preact": "https://esm.sh/htm@3.1.1/preact?external=preact"
        }
      }
    </script>
    <script src="/@jsenv/server/src/services/route_inspector/client/code_block.js?inline"></script>
    <script src="/@jsenv/server/src/services/autoreload_on_server_restart/client/autoreload_on_server_restart.js?inline"></script>
  </head>
  <body>
    <style>
      :root {
        --background-color: #fff;
        --text-color: #333;
        --border-color: #e0e0e0;
        --primary-color: #1976d2;
        --secondary-color: #f5f5f5;
        --success-color: #4caf50;
        --warning-color: #ff9800;
        --method-get-color: #61affe;
        --method-post-color: #49cc90;
        --method-put-color: #ff9800;
        --method-delete-color: #f44336;
        --method-patch-color: #9c27b0;
        --method-options-color: #607d8b;
        --method-head-color: #00bcd4;
      }

      :root[data-theme="light"] {
        --background-color: #fff;
        --text-color: #333;
        --border-color: #e0e0e0;
        --primary-color: #1976d2;
        --secondary-color: #f5f5f5;
      }
      :root[data-theme="dark"] {
        --background-color: #121212;
        --text-color: #e0e0e0;
        --border-color: #333;
        --primary-color: #4f9eff;
        --secondary-color: #1e1e1e;
      }

      :root[data-theme="dark"] a {
        color: dodgerblue;
      }

      html {
        scrollbar-gutter: stable both-edges;
      }

      body {
        margin: 0;
        color: var(--text-color);
        font-family:
          system-ui,
          -apple-system,
          BlinkMacSystemFont,
          "Segoe UI",
          Roboto,
          Arial,
          sans-serif;
        line-height: 1.5;
        background-color: var(--background-color);

        transition:
          background-color 0.3s ease,
          color 0.3s ease;
      }

      .container {
        display: flex;
        flex-direction: row;
      }
      aside {
        position: fixed;
        width: 250px;
        height: 100%;
        margin-right: 20px;
        flex-shrink: 0;
        transition:
          width 0.3s ease,
          margin-left 0.3s ease;
      }
      main {
        min-width: 0;
        margin-left: 280px;
        padding-top: 20px;
        padding-right: 20px;
        flex-grow: 1;
        flex-basis: 0;
        transition: margin-left 0.3s ease;
      }

      .header_row {
        display: flex;
        align-items: flex-start;
        gap: 10px;
      }
      .header_title {
        display: flex;
        margin: 0;
        align-items: center;
        gap: 10px;
        line-height: 1;
      }
      .note_button_open {
        height: 24px;
        padding: 0;
        color: var(--text-color);
        background: none;
        border: none;
        border-radius: 50%;
        opacity: 0.7;
        transition: background-color 0.2s;
        cursor: pointer;
      }
      .note_button_open:hover {
        background-color: color-mix(
          in srgb,
          var(--primary-color) 15%,
          transparent
        );
        opacity: 1;
      }
      .note_title {
        display: flex;
        margin-bottom: 10px;
        align-items: center;
        font-weight: bold;
        font-size: 1.1rem;
      }
      .note_button_close {
        position: absolute;
        top: 15px;
        right: 15px;
        display: flex;
        padding: 5px;
        align-items: center;
        justify-content: center;
        background: none;
        border: none;
        border-radius: 50%;
        cursor: pointer;
      }
      .note_button_close:hover {
        background-color: var(--secondary-color);
      }
      .note_content {
        position: relative;
        width: 90%;
        max-width: 500px;
        padding: 20px;
        background-color: var(--background-color);
        border-radius: 8px;
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
        transform: translateY(-20px);
        transition: transform 0.3s ease;
      }

      .theme-toggle {
        display: flex;
        align-items: center;
      }

      #theme-toggle-btn {
        display: flex;
        width: 40px;
        height: 40px;
        align-items: center;
        justify-content: center;
        background: none;
        background-color: var(--secondary-color);
        border: none;
        border-radius: 50%;
        transition: background-color 0.2s;
        cursor: pointer;
      }

      #theme-toggle-btn:hover {
        background-color: color-mix(
          in srgb,
          var(--primary-color) 15%,
          transparent
        );
      }

      #theme-toggle-btn svg {
        fill: var(--text-color);
      }

      .sun-icon {
        display: none;
      }
      .moon-icon {
        display: none;
      }
      :root[data-theme="dark"] .sun-icon {
        display: block;
      }
      :root[data-theme="light"] .moon-icon {
        display: block;
      }

      .progress-container {
        position: relative;
        width: 100%;
        height: 100%;
        margin: 20px 0;
        background-color: rgba(25, 118, 210, 0.2);
        border-radius: 4px;
        overflow: hidden;
      }
      .progress-indeterminate .progress-bar-long,
      .progress-indeterminate .progress-bar-short {
        position: absolute;
        top: 0;
        height: 100%;
        background-color: var(--primary-color);
        border-radius: 4px;
        animation-duration: 2.2s;
        animation-iteration-count: infinite;
      }

      .progress-indeterminate .progress-bar-long {
        width: 75%;
        animation-name: indeterminate-ltr;
      }

      .progress-indeterminate .progress-bar-short {
        width: 20%;
        animation-name: indeterminate-short-ltr;
      }

      @keyframes indeterminate-ltr {
        0% {
          right: 100%;
          left: -90%;
        }
        60% {
          right: 100%;
          left: -90%;
        }
        100% {
          right: -35%;
          left: 100%;
        }
      }

      @keyframes indeterminate-short-ltr {
        0% {
          right: 100%;
          left: -200%;
        }
        60% {
          right: -8%;
          left: 107%;
        }
        100% {
          right: -8%;
          left: 107%;
        }
      }

      /* Styles pour les routes */
      .auto_head_note {
        display: flex;
        margin-top: 10px;
        align-items: center;
        color: var(--method-head-color);
        font-size: 14px;
      }
      .note {
        margin-bottom: 20px;
        padding: 12px;
        background-color: rgba(255, 152, 0, 0.1);
        border-left: 4px solid var(--warning-color);
        border-radius: 4px;
      }
      .info_pill {
        display: inline-flex;
        margin-left: 10px;
        padding: 4px 10px;
        align-items: center;
        font-size: 13px;
        background-color: rgba(0, 0, 0, 0.05);
        border-radius: 14px;
      }

      .route_container {
        display: flex;
        align-items: flex-start;
        gap: 20px;
      }
      .filters_sidebar {
        width: 250px;
        flex-shrink: 0;
        background: var(--secondary-color);
        border: 1px solid var(--border-color);
        border-radius: 6px;
        overflow: hidden;
      }
      .sidebar_header {
        display: flex;
        padding: 12px 15px;
        align-items: center;
        justify-content: space-between;
        font-weight: 500;
        border-bottom: 1px solid var(--border-color);
      }
      .filters_content {
        padding: 15px;
        background: var(--background-color);
      }
      .filters_count {
        padding: 2px 8px;
        color: white;
        font-weight: normal;
        font-size: 0.8rem;
        background-color: var(--primary-color);
        border-radius: 12px;
      }
      @media (max-width: 768px) {
        .route_container {
          flex-direction: column;
        }

        .filters_sidebar {
          width: 100%;
          margin-bottom: 20px;
        }
      }

      .route_container > * {
        min-width: 0; /* Prevent flexbox from expanding beyond available space */
        margin-top: 20px;
        flex-grow: 1;
      }
      .route_group_details {
        margin: 0 0 15px;
      }
      .summary_marker {
        width: 24px;
        height: 24px;
      }
      .route_group_details > summary {
        margin-bottom: 7px;
        list-style: none;
        border-bottom: 1px solid var(--border-color);
        cursor: pointer;
      }
      .route_group_details > summary::marker {
        display: none;
      }
      .route_group_details[open] > summary .summary_marker {
        transform: rotate(180deg);
      }
      .route_group_summary_container {
        display: flex;
        padding: 5px;
        align-items: center;
      }
      .route_group_name {
        display: flex;
        min-width: 80px;
        padding: 6px 0;
        gap: 0.3em;
        font-weight: 700;
        font-size: 14px;
        font-family: sans-serif;
        text-align: center;
        text-shadow: 0 1px 0 rgba(0, 0, 0, 0.1);
        border-radius: 3px;
      }
      .route_group_description {
        margin-top: 0;
        margin-bottom: 0;
        margin-left: 8px;
        font-weight: 600;
        font-size: 16px;
        font-family: monospace;
        word-break: break-word;
        user-select: none;
      }

      .route_details {
        margin-bottom: 8px;
        margin: 0 0 15px;
        background: color-mix(in srgb, var(--method-color), transparent 90%);
        border: 1px solid #000;
        border-color: var(--method-color);
        border-radius: 4px;
        box-shadow: 0 0 3px rgba(0, 0, 0, 0.19);
      }
      .route_details > summary {
        list-style: none;
        cursor: pointer;
      }
      .route_details > summary::marker {
        display: none;
      }
      .route_details:open > summary .summary_marker {
        transform: rotate(180deg);
      }
      .route_summary_container {
        display: flex;
        padding: 5px;
        align-items: center;
      }
      .route_method {
        min-width: 80px;
        padding: 6px 0;
        color: #fff;
        font-weight: 700;
        font-size: 14px;
        font-family: sans-serif;
        text-align: center;
        text-shadow: 0 1px 0 rgba(0, 0, 0, 0.1);
        background: var(--method-color);
        border-radius: 3px;
      }
      .route_resource {
        margin-top: 0;
        margin-bottom: 0;
        margin-left: 8px;
        font-weight: 600;
        font-size: 16px;
        font-family: monospace;
        word-break: break-word;
      }
      .route_details[data-method="HEAD"],
      .route_group_details[data-method="HEAD"] {
        --method-color: var(--method-head-color);
      }
      .route_details[data-method="OPTIONS"],
      .route_group_details[data-method="OPTIONS"] {
        --method-color: var(--method-options-color);
      }
      .route_details[data-method="GET"],
      .route_group_details[data-method="GET"] {
        --method-color: var(--method-get-color);
      }
      .route_details[data-method="POST"],
      .route_group_details[data-method="POST"] {
        --method-color: var(--method-post-color);
      }
      .route_details[data-method="PUT"],
      .route_group_details[data-method="PUT"] {
        --method-color: var(--method-put-color);
      }
      .route_details[data-method="PATCH"],
      .route_group_details[data-method="PATCH"] {
        --method-color: var(--method-patch-color);
      }
      .route_details[data-method="DELETE"],
      .route_group_details[data-method="DELETE"] {
        --method-color: var(--method-delete-color);
      }

      .route_owner_name {
        padding: 4px 8px;
        color: #666;
        text-align: center;
        background-color: #ffefd2;
        border-radius: 5px;
      }
      :root[data-theme="dark"] .route_owner_name {
        color: white;
        background-color: rgb(96, 59, 13);
      }

      .route_details_content {
        padding: 10px;
        border-top: 1px solid var(--method-color);
      }
      .route_description {
        margin: 0;
      }
      .route_content_nego_title {
        font-weight: bold;
      }

      .filter_container {
        height: 100%;
        margin-bottom: 20px;
        background: var(--secondary-color);
        border-right: 1px solid var(--border-color);
        overflow: hidden;
        overflow-y: auto;
      }
      .filter_container::marker {
        display: none;
      }
      .filter_summary {
        display: flex;
        flex-direction: row;
        align-items: center;
        justify-content: space-between;
        font-weight: 500;
        cursor: pointer;
        user-select: none;
      }
      .filter:open > summary .summary_marker {
        transform: rotate(180deg);
      }
      .summary_text {
        display: block;
        width: 100%;
        text-overflow: ellipsis;
        white-space: nowrap;
        overflow: hidden;
      }
      .filter_list {
        background: var(--background-color);
        overflow: hidden;
      }
      .filter_item {
        margin: 15px;
        margin-left: 0;
      }
      .filter_badge {
        margin-left: 10px;
        padding: 2px 8px;
        color: white;
        font-size: 0.8rem;
        background-color: var(--primary-color);
        border-radius: 12px;
      }

      select {
        min-width: 200px;
        padding: 8px;
        color: var(--text-color);
        font-family: inherit;
        background-color: var(--background-color);
        border: 1px solid var(--border-color);
        border-radius: 4px;
      }
      select option {
        padding: 8px;
      }
      select option:checked {
        color: white;
        background-color: var(--primary-color);
      }
      .filter_form {
        display: flex;
        margin-top: 15px;
        margin-bottom: 15px;
        flex-direction: column;
        flex-wrap: wrap;
        gap: 8px;
        user-select: none;
      }
      .filter_form label {
        display: flex;
        width: 100%;
        align-items: center;
        gap: 5px;
        text-overflow: ellipsis;
        white-space: nowrap;
        word-break: keep-all;
        cursor: pointer;
        overflow: hidden;
      }
      label .filter_text {
        text-overflow: ellipsis;
        overflow: hidden;
      }
      .filter_text[data-method] {
        padding-left: 4px;
      }
      .filter_text[data-method="all"] {
        --method-color: transparent;
        border-image-slice: 1;
      }
      .filter_text[data-method="HEAD"] {
        --method-color: var(--method-head-color);
      }
      .filter_text[data-method="OPTIONS"] {
        --method-color: var(--method-options-color);
      }
      .filter_text[data-method="GET"] {
        --method-color: var(--method-get-color);
      }
      .filter_text[data-method="POST"] {
        --method-color: var(--method-post-color);
      }
      .filter_text[data-method="PUT"] {
        --method-color: var(--method-put-color);
      }
      .filter_text[data-method="PATCH"] {
        --method-color: var(--method-patch-color);
      }
      .filter_text[data-method="DELETE"] {
        --method-color: var(--method-delete-color);
      }

      .filter_count {
        margin-left: auto;
        padding: 2px 8px;
        color: #666;
        font-size: 0.8rem;
        white-space: nowrap;
        background-color: #eee;
        border-radius: 12px;
        opacity: 0.8;
      }

      .filter_actions {
        display: flex;
        gap: 10px;
      }
      .filter_button {
        padding: 6px 12px;
        color: var(--text-color);
        font-size: 0.9rem;
        background-color: var(--secondary-color);
        border: 1px solid var(--border-color);
        border-radius: 4px;
        transition: all 0.2s;
        cursor: pointer;
      }
      .filter_button:hover {
        background-color: color-mix(
          in srgb,
          var(--primary-color) 15%,
          transparent
        );
      }

      .status_pill {
        display: flex;
        width: 0.4em;
        align-self: stretch;
      }
    </style>
    <div class="container">
      <aside></aside>
      <main>
        <div class="header_row">
          <h1 class="header_title">
            Route inspector
            <button
              class="note_button_open"
              aria-label="Show information"
              title="About HTTP Methods"
            >
              <svg
                xmlns="http://www.w3.org/2000/svg"
                viewBox="0 0 24 24"
                width="24"
                height="24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
              >
                <circle cx="12" cy="12" r="10"></circle>
                <line x1="12" y1="16" x2="12" y2="12"></line>
                <line x1="12" y1="8" x2="12.01" y2="8"></line>
              </svg>
            </button>
          </h1>
          <div style="flex: 1"></div>
          <div class="theme-toggle">
            <button id="theme-toggle-btn" aria-label="Toggle dark/light mode">
              <svg
                class="sun-icon"
                xmlns="http://www.w3.org/2000/svg"
                height="24"
                viewBox="0 -960 960 960"
                width="24"
              >
                <path
                  d="M480-360q50 0 85-35t35-85q0-50-35-85t-85-35q-50 0-85 35t-35 85q0 50 35 85t85 35Zm0 80q-83 0-141.5-58.5T280-480q0-83 58.5-141.5T480-680q83 0 141.5 58.5T680-480q0 83-58.5 141.5T480-280ZM80-440q0 17 11.5 28.5T120-400h80q17 0 28.5-11.5T240-440q0-17-11.5-28.5T200-480h-80q-17 0-28.5 11.5T80-440Zm680 0q0 17 11.5 28.5T800-400h80q17 0 28.5-11.5T920-440q0-17-11.5-28.5T880-480h-80q-17 0-28.5 11.5T760-440ZM440-760q0 17 11.5 28.5T480-720q17 0 28.5-11.5T520-760v-80q0-17-11.5-28.5T480-880q-17 0-28.5 11.5T440-840v80Zm0 680q0 17 11.5 28.5T480-40q17 0 28.5-11.5T520-80v-80q0-17-11.5-28.5T480-200q-17 0-28.5 11.5T440-160v80ZM226-678l56 56q12 12 28.5 12t28.5-12q12-12 12-28.5T339-679l-56-56q-12-12-28.5-12T226-735q-12 12-12 28.5t12 28.5Zm452 452 56 56q12 12 28.5 12t28.5-12q12-12 12-28.5T791-227l-56-56q-12-12-28.5-12T678-283q-12 12-12 28.5t12 28.5ZM791-678q12 12 28.5 12t28.5-12q12-12 12-28.5T848-735l-56-56q-12-12-28.5-12T735-791q-12 12-12 28.5t12 28.5l56 56Zm-508 452q12 12 28.5 12t28.5-12q12-12 12-28.5T340-283l-56-56q-12-12-28.5-12T227-339q-12 12-12 28.5t12 28.5l56 56Z"
                />
              </svg>
              <svg
                class="moon-icon"
                xmlns="http://www.w3.org/2000/svg"
                height="24"
                viewBox="0 -960 960 960"
                width="24"
              >
                <path
                  d="M480-120q-150 0-255-105T120-480q0-150 105-255t255-105q8 0 17 .5t23 1.5q-36 32-56 79t-20 99q0 83 58.5 141.5T643-460q52 0 99-20t79-56q1 14 1.5 23t.5 17q0 150-105 255T480-120Zm0-80q88 0 158-48.5T740-375q-20 5-40 8t-40 3q-123 0-209.5-86.5T364-660q0-20 3-40t8-40q-78 32-126.5 102T200-480q0 116 82 198t198 82Zm-10-270Z"
                />
              </svg>
            </button>
          </div>
        </div>
        <dialog class="node_dialog">
          <button class="note_button_close" aria-label="Close">
            <svg
              width="24"
              height="24"
              xmlns="http://www.w3.org/2000/svg"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
            >
              <line x1="18" y1="6" x2="6" y2="18"></line>
              <line x1="6" y1="6" x2="18" y2="18"></line>
            </svg>
          </button>
          <div class="note_title">Explanation about this page</div>
          <div class="note_text">
            <p>This page displays all routes configured in your server.</p>
            <p>
              Every GET route also automatically supports HEAD requests without
              additional configuration.
            </p>
          </div>
        </dialog>
        <script>
          const noteDialog = document.querySelector(".node_dialog");
          const noteButtonOpen = document.querySelector(".note_button_open");
          const nodeButtonClose = document.querySelector(".note_button_close");

          noteDialog.onclick = (e) => {
            if (e.target === noteDialog) {
              noteDialog.close();
            }
          };
          nodeButtonClose.onclick = () => {
            noteDialog.close();
          };
          noteButtonOpen.onclick = () => {
            noteDialog.showModal();
          };
        </script>
        <div id="app"></div>
      </main>
    </div>
    <script>
      // Theme toggling functionality
      const toggleThemeButton = document.getElementById("theme-toggle-btn");

      // Check for saved theme preference or use system preference
      const savedTheme = localStorage.getItem("theme");
      const prefersDark = window.matchMedia(
        "(prefers-color-scheme: dark)",
      ).matches;

      // Apply theme based on saved preference or system preference
      if (savedTheme === "dark" || (savedTheme === null && prefersDark)) {
        document.documentElement.setAttribute("data-theme", "dark");
      } else {
        document.documentElement.setAttribute("data-theme", "light");
      }

      // Toggle theme when button is clicked
      toggleThemeButton.addEventListener("click", () => {
        if (document.documentElement.getAttribute("data-theme") === "dark") {
          document.documentElement.setAttribute("data-theme", "light");
          localStorage.setItem("theme", "light");
        } else {
          document.documentElement.setAttribute("data-theme", "dark");
          localStorage.setItem("theme", "dark");
        }
      });
    </script>
    <script type="module">
      // https://preactjs.com/guide/v10/no-build-workflows/
      import { render } from "preact";
      import { html } from "htm/preact";
      import { signal, computed } from "@preact/signals";
      import { useRef, useCallback } from "preact/hooks";

      const routesLoadingSignal = signal(false);
      const routeLoadingErrorSignal = signal(null);
      const routesSignal = signal([]);
      const NO_PACKAGE_NAME = "unknown";

      const repartitionsSignal = computed(() => {
        const routes = routesSignal.value;
        const methodRepartition = {};
        const packageRepartition = {};
        for (const route of routes) {
          const method = route.method;
          if (!methodRepartition[method]) {
            methodRepartition[method] = 0;
          }
          methodRepartition[method]++;

          const packageName = route.meta.packageName || NO_PACKAGE_NAME;
          if (!packageRepartition[packageName]) {
            packageRepartition[packageName] = 0;
          }
          packageRepartition[packageName]++;
        }
        return {
          methodRepartition,
          packageRepartition,
        };
      });
      const methodRepartitionSignal = computed(() => {
        return repartitionsSignal.value.methodRepartition;
      });
      const packageRepartitionSignal = computed(() => {
        return repartitionsSignal.value.packageRepartition;
      });
      const availableMethodNamesSignal = computed(() => {
        return Object.keys(methodRepartitionSignal.value);
      });
      const availablePackageNamesSignal = computed(() => {
        return Object.keys(packageRepartitionSignal.value);
      });

      const loadRoutes = async () => {
        routesLoadingSignal.value = true;
        routeLoadingErrorSignal.value = null;
        try {
          const response = await fetch("/.internal/routes.json");
          const routes = await response.json();
          routesLoadingSignal.value = false;
          routesSignal.value = routes;
        } catch (e) {
          routesLoadingSignal.value = false;
          routeLoadingErrorSignal.value = e;
          throw e;
        }
      };
      loadRoutes();

      const Sidebar = () => {
        const routes = routesSignal.value;
        if (routes.length === 0) {
          return null;
        }
        return html`
          <div>
            <${FiltersPanel} routes="${routes}" />
          </div>`;
      };

      const App = () => {
        return html`
          <div>
            <${Toolbox} />
            <${RouteResults} />
          </div>`;
      };
      const ProgressBar = ({ width = "100%", height = 6, loading }) => {
        if (!loading) {
          return null;
        }
        return html`
          <div
            class="progress-bar"
            style="${{
              width: typeof Number(width) === "number" ? `${width}px` : width,
              height:
                typeof Number(height) === "number" ? `${height}px` : height,
            }}"
          >
            <div class="progress-container progress-indeterminate">
              <div class="progress-bar-long"></div>
              <div class="progress-bar-short"></div>
            </div>
          </div>
        `;
      };
      const RouteResults = () => {
        const routes = routesSignal.value;
        const loading = routesLoadingSignal.value;
        const routeLoadingError = routeLoadingErrorSignal.value;
        const [groupBy] = useGroupByUrlStringParam();

        if (loading) {
          return html`<${ProgressBar} width="150" loading="${true}" />`;
        }

        if (routeLoadingError) {
          return html`<p>
              Error loading routes: ${routeLoadingError.message}
            </p>`;
        }

        if (!routes || routes.length === 0) {
          return html`<p>No routes configured.</p>`;
        }

        return html`<div class="route_container">
            ${groupBy
              ? html`<${RouteGroups} groupBy="${groupBy}" routes="${routes}" />`
              : html`<${RouteList} routes="${routes}" />`}
          </div>`;
      };

      const RouteGroups = ({ groupBy, routes }) => {
        const groups = {};
        for (const route of routes) {
          const groupKey =
            groupBy === "by_method"
              ? route.method
              : route.meta.packageName || NO_PACKAGE_NAME;
          if (!groups[groupKey]) {
            groups[groupKey] = [];
          }
          groups[groupKey].push(route);
        }

        return html`
          <ul style="margin-left: 0; padding: 0">
            <li style="list-style: none; padding: 0;">
              ${Object.entries(groups).map(([groupKey, groupRoutes]) => {
                const groupText =
                  groupBy === "by_method"
                    ? html`<span
                          style="margin-left: 0.5em; display: inline-flex; gap: 0.5em;"
                        >
                          <${MethodsStatusPill} methodNames="${[groupKey]}" />
                          <span>${groupKey}</span>
                        </span>`
                    : html`<span>${groupKey}</span>`;

                return html`
                  <details
                    class="route_group_details"
                    data-method="${groupBy === "by_method"
                      ? groupKey
                      : undefined}"
                  >
                    <summary>
                      <div class="route_group_summary_container">
                        <span class="route_group_name">
                          ${groupBy === "by_method" ? "method" : "package"}:
                          ${groupText}
                        </span>
                        <span class="route_group_description">
                          <span class="filter_count">
                            ${groupRoutes.length}
                          </span>
                        </span>
                        <span style="flex: 1"></span>
                        <span class="summary_marker">
                          <${ArrowDown} />
                        </span>
                      </div>
                    </summary>
                    <${RouteList} routes="${groupRoutes}" />
                  </details>`;
              })}
            </li>
          </ul>`;
      };

      const RouteList = ({ routes }) => {
        return html`<div class="route_list">
            ${routes.map((route) => html`<${RouteDetails} ...${route} />`)}
          </div>`;
      };

      const documentUrlSignal = signal(window.location.href);
      window.addEventListener("popstate", async (popstateEvent) => {
        documentUrlSignal.value = popstateEvent.target.location.href;
      });
      const goTo = (url, { replace } = {}) => {
        if (replace) {
          window.history.replaceState(null, null, url);
          documentUrlSignal.value = url;
        } else {
          window.history.pushState(null, null, url);
          documentUrlSignal.value = url;
        }
      };
      goTo(window.location.href, { replace: true });

      let useUrlStringParam;
      url_string_param: {
        useUrlStringParam = (name, { availableValues } = {}) => {
          const urlStringParamSignal = signalForUrlParam(name, (url) => {
            return new URL(url).searchParams.get(name);
          });
          const urlStringParam = urlStringParamSignal.value;
          let value;
          if (urlStringParam) {
            value = urlStringParam;
            if (availableValues && !availableValues.includes(value)) {
              value = "";
            }
          } else {
            value = "";
          }

          const set = useCallback(
            (newValue) => {
              const urlObject = new URL(documentUrlSignal.peek());
              const { searchParams } = urlObject;
              if (!newValue) {
                searchParams.delete(name);
                const urlWithoutStringParam = urlObject.href;
                if (urlWithoutStringParam !== window.location.href) {
                  goTo(urlWithoutStringParam);
                }
                return;
              }
              if (availableValues && !availableValues.includes(newValue)) {
                return;
              }
              searchParams.set(name, newValue);
              const urlWithStringParam = urlObject.href;
              if (urlWithStringParam !== window.location.href) {
                goTo(urlWithStringParam);
              }
              return;
            },
            [name],
          );
          return [value, set];
        };

        const urlParamSignalMap = new Map();
        // can be called multiple times by hooks
        const signalForUrlParam = (name, getter) => {
          const existingSignal = urlParamSignalMap.get(name);
          if (existingSignal) {
            return existingSignal;
          }
          const signalForFirstCall = computed(() => {
            const url = documentUrlSignal.value;
            const valueInUrl = getter(url);
            return valueInUrl;
          });
          urlParamSignalMap.set(name, signalForFirstCall);
          return signalForFirstCall;
        };
      }

      const useGroupByUrlStringParam = () => {
        const availableGroupByValues = ["by_method", "by_package"];
        return useUrlStringParam("groupBy", {
          availableValues: availableGroupByValues,
        });
      };

      const useMethodUrlStringParam = () => {
        const availableMethodNames = availableMethodNamesSignal.value;
        return useUrlStringParam("method", {
          availableValues: availableMethodNames,
        });
      };

      const usePackageUrlStringParam = () => {
        const availablePackageNames = availablePackageNamesSignal.value;
        return useUrlStringParam("package", {
          availableValues: availablePackageNames,
        });
      };

      let Toolbox;
      groups: {
        Toolbox = () => {
          return html``;
        };
      }

      const StatusPill = ({ children, color }) => {
        return html`
            <span
            class="status_pill"
            style="${{
              background: color,
            }}"
          >
            ${children}
          </span>`;
      };
      const buildLinearGradient = (colors) => {
        const percentagePerColor = Math.floor(100 / (colors.length - 1));
        const gradientSteps = [];
        let progress = 0;
        let index = 0;
        for (const color of colors) {
          if (index === colors.length - 1) {
            progress = 100;
          }
          gradientSteps.push(`${color} ${progress}%`);
          progress += percentagePerColor;
          index++;
        }
        const gradient = `linear-gradient(to bottom, ${gradientSteps.join(", ")})`;
        return gradient;
      };
      const MethodsStatusPill = ({ methodNames }) => {
        if (methodNames.length === 1) {
          return html`
            <${StatusPill}
              color="${getMethodColor(methodNames[0])}"
            />
          `;
        }
        const colors = methodNames.map((methodName) =>
          getMethodColor(methodName),
        );
        const linearGradient = buildLinearGradient(colors);
        return html`
            <${StatusPill}
            color="${linearGradient}"
          />
          `;
      };
      const getMethodColor = (methodName) => {
        const bodyStyle = window.getComputedStyle(document.body);
        const methodColor = bodyStyle.getPropertyValue(
          `--method-${methodName.toLowerCase()}-color`,
        );
        return methodColor;
      };

      let FiltersPanel;
      filters: {
        FiltersPanel = ({ routes }) => {
          return html`
            <div class="filter_container">
              <div class="filter_list">
                <div class="filter_item">
                  <${GroupSelector} />
                </div>
                <div class="filter_item">
                  <${MethodFilter} routes="${routes}" />
                </div>
                <div class="filter_item">
                  <${PackageFilter} routes="${routes}" />
                </div>
              </div>
            </div>
          `;
        };

        const GroupSelector = () => {
          const [groupBy, setGroupBy] = useGroupByUrlStringParam();
          const label = html`
            <span>
              Group: ${groupBy || "none"}
            </span>`;
          const options = [
            {
              value: "",
              text: html`
                <span class="filter_text">
                  none
                </span>
              `,
              selected: !groupBy,
            },
            {
              value: "by_method",
              text: html`
                <span class="filter_text">
                  by method
                </span>
              `,
              selected: groupBy === "by_method",
            },
            {
              value: "by_package",
              text: html`
                <span class="filter_text">
                  by package
                </span>
              `,
              selected: groupBy === "by_package",
            },
          ];

          return html`
            <${FilterSelector}
              label="${label}"
              options="${options}"
              onChange="${(groupByToSelect) => {
                setGroupBy(groupByToSelect);
              }}"
            />
          `;
        };
        const MethodFilter = ({ routes }) => {
          const availableMethodNames = availableMethodNamesSignal.value;
          const availableMethodRepartition = methodRepartitionSignal.value;
          const [selectedMethod, setSelectedMethod] = useMethodUrlStringParam();

          const options = [
            {
              value: "",
              text: html`
                <${MethodsStatusPill}
                  methodNames="${availableMethodNames}"
                />
                <span class="filter_text" data-method="all">all</span>
                <span class="filter_count">
                  ${routes.length}
                </span>
              `,
              selected: !selectedMethod,
            },
            ...availableMethodNames.map((availableMethodName) => {
              return {
                value: availableMethodName,
                text: html`
                  <${MethodsStatusPill}
                    methodNames="${[availableMethodName]}"
                  />
                  <span
                    class="filter_text"
                    data-method="${availableMethodName}"
                  >
                    ${availableMethodName}
                  </span>
                  <span class="filter_count">
                    ${availableMethodRepartition[availableMethodName]}
                  </span>
                `,
                selected: availableMethodName === selectedMethod,
              };
            }),
          ];

          const label = html`<span
              style="display: flex; align-items: center; gap: 5px"
            >
              <${MethodsStatusPill}
                methodNames="${selectedMethod
                  ? [selectedMethod]
                  : availableMethodNames}"
              />
              <span>Methods: ${selectedMethod || "all"}</span>
            </span>`;

          return html`
            <${FilterSelector}
              label="${label}"
              options="${options}"
              onChange="${(methodToSelect) => {
                setSelectedMethod(methodToSelect);
              }}"
            />
          `;
        };
        const PackageFilter = ({ routes }) => {
          const availablePackageNames = availablePackageNamesSignal.value;
          const packageRepartition = packageRepartitionSignal.value;
          const [selectedPackageName, setSelectedPackageName] =
            usePackageUrlStringParam();

          const options = [
            {
              value: "",
              text: html`<span>all</span>
                <span class="filter_count">${routes.length}</span>`,
              selected: !selectedPackageName,
            },
            ...availablePackageNames.map((availablePackageName) => {
              return {
                value: availablePackageName,
                text: html` <span
                    class="filter_text"
                    title="${availablePackageName}"
                    >${availablePackageName}</span
                  >
                  <span class="filter_count"
                    >${packageRepartition[availablePackageName]}</span
                  >`,
                selected: availablePackageName === selectedPackageName,
              };
            }),
          ];

          const label = html`
            <span>
              Packages: ${selectedPackageName || "all"}
            </span>
          `;

          return html`
            <${FilterSelector}
              label="${label}"
              options="${options}"
              onChange="${(packageNameToSelect) => {
                setSelectedPackageName(packageNameToSelect);
              }}"
            />
          `;
        };
        const FilterSelector = ({
          label,
          multiple,
          options,
          onChange,
          actions,
        }) => {
          const formRef = useRef();

          return html`<details open class="filter">
                <summary class="filter_summary">
                  <span class="summary_text">${label}</span>
                  <span class="summary_marker">
                    <${ArrowDown} />
                  </span>
                </summary>
                <form ref=${formRef} class="filter_form">
                  ${options.map((option) => {
                    return html`<label>
                        <input
                          type="${multiple ? "checkbox" : "radio"}"
                          name="${label}"
                          checked="${option.selected}"
                          value="${option.value}"
                          onChange="${multiple
                            ? () => {
                                const formNode = formRef.current;
                                // even if we create a checkbox list the HTML spec
                                // return a radio node list and we have to gather the checked values
                                const radioNodeList = formNode.elements[label];
                                const selectedValues = [];
                                for (const checkboxNode of Array.from(
                                  radioNodeList,
                                )) {
                                  if (checkboxNode.checked) {
                                    selectedValues.push(checkboxNode.value);
                                  }
                                }
                                onChange(selectedValues);
                              }
                            : () => {
                                const formNode = formRef.current;
                                const radioNodeList = formNode.elements[label];
                                const selectedValue = radioNodeList.value;
                                onChange(selectedValue);
                              }}"
                        />
                        ${option.text}
                      </label>`;
                  })}
                </form>
                ${
                  actions &&
                  html` <div class="filter_actions">
                      <button
                        type="button"
                        class="filter_button"
                        onClick="${() => {
                          onChange(options.map((option) => option.value));
                        }}"
                      >
                        Select All
                      </button>
                      <button
                        type="button"
                        class="filter_button"
                        onClick="${() => {
                          onChange([]);
                        }}"
                      >
                        Clear All
                      </button>
                    </div>`
                }
              </div>`;
        };
      }

      const RouteDetails = ({
        meta,
        method,
        resource,
        description,
        availableMediaTypes,
        availableLanguages,
        availableVersions,
        availableEncodings,
        acceptedMediaTypes,
        websocket,
        clientCodeExample,
        declarationSource,
      }) => {
        const [selectedMethod] = useUrlStringParam("method");
        const [selectedPackageName] = usePackageUrlStringParam();

        if (selectedMethod && method !== selectedMethod) {
          return null;
        }
        const packageName = meta.packageName || NO_PACKAGE_NAME;
        if (selectedPackageName && packageName !== selectedPackageName) {
          return null;
        }

        return html`<details class="route_details" data-method="${method}">
            <summary class="route_summary_container">
              <span class="route_method">${method}</span>
              <p class="route_resource">${resource}</p>
              ${method === "GET"
                ? html`<a
                      style="display:inline-flex; margin-left: 5px;"
                      href="${resource}"
                      ><${OpenLink}
                    /></a>`
                : null}
              <span style="flex:1"></span>
              <${RouteBadge} meta="${meta}" />
              <span class="summary_marker">
                <${ArrowDown} />
              </span>
            </summary>
            <${RouteDetailsContent}
              method="${method}"
              resource="${resource}"
              description="${description}"
              availableMediaTypes="${availableMediaTypes}"
              availableLanguages="${availableLanguages}"
              availableVersions="${availableVersions}"
              availableEncodings="${availableEncodings}"
              acceptedMediaTypes="${acceptedMediaTypes}"
              websocket="${websocket}"
              clientCodeExample="${clientCodeExample}"
              declarationSource="${declarationSource}"
              meta="${meta}"
            />
          </details>`;
      };

      const RouteBadge = ({ meta }) => {
        if (!meta.packageName) {
          return null;
        }
        let text = meta.packageName;
        let title = `This endpoint is declared by ${meta.packageName}`;
        return html`<span title="${title}" class="route_owner_name"
            >${text}</span
          >`;
      };

      const RouteDetailsContent = ({
        method,
        resource,
        description,
        availableMediaTypes,
        availableLanguages,
        availableVersions,
        availableEncodings,
        acceptedMediaTypes,
        websocket,
        clientCodeExample,
        declarationSource,
        meta,
      }) => {
        return html`<div class="route_details_content">
            <${RoutedeclarationSource}
              meta="${meta}"
              declarationSource="${declarationSource}"
            />
            <p style="margin-top: 0"><strong>Description:</strong></p>
            <p class="route_description">
              ${description || "No description available"}
            </p>
            ${availableMediaTypes.length > 0 &&
            html`<${RouteContentNegotiationSection}
                type="content-type"
                title="Available media types"
                availableValues="${availableMediaTypes}"
              />`}
            ${availableLanguages.length > 0 &&
            html`<${RouteContentNegotiationSection}
                type="language"
                title="Available languages"
                availableValues="${availableLanguages}"
              />`}
            ${availableVersions.length > 0 &&
            html`<${RouteContentNegotiationSection}
                type="version"
                title="Available versions"
                availableValues="${availableVersions}"
              />`}
            ${availableEncodings.length > 0 &&
            html`<${RouteContentNegotiationSection}
                type="encoding"
                title="Available encodings"
                availableValues="${availableEncodings}"
              />`}
            ${acceptedMediaTypes.length > 0 &&
            html`<${RouteAcceptableContentSection}
                acceptedMediaTypes="${acceptedMediaTypes}"
              />`}
            <p style="margin-bottom:0; font-weight:bold">Example:</p>
            <${RouteCodeExample}
              method="${method}"
              resource="${resource}"
              availableMediaTypes="${availableMediaTypes}"
              websocket="${websocket}"
              clientCodeExample="${clientCodeExample}"
            />
          </div>`;
      };
      const RoutedeclarationSource = ({ meta, declarationSource }) => {
        if (!declarationSource) {
          return null;
        }
        return html`<p style="margin-top: 0"><strong>Declaration:</strong></p>
          <p>
            <${RouteDeclarationText}
              ownerLink="${meta.ownerLink}"
              declarationLink="${meta.declarationLink}"
            />
          </p>`;
      };
      const RouteDeclarationText = ({ declarationLink }) => {
        return html`This route is declared in${" "}
          <a href="${declarationLink.url}">${declarationLink.text}</a>`;
      };
      const RouteContentNegotiationSection = ({
        type,
        title,
        availableValues,
      }) => {
        return html`<div class="route_content_nego" data-nego-type="${type}">
            <p class="route_content_nego_title">${title}:</p>
            <ul>
              ${availableValues.map(
                (availableValue) => html`<li>${availableValue}</li>`,
              )}
            </ul>
          </div>`;
      };
      const RouteAcceptableContentSection = ({ acceptedMediaTypes }) => {
        return html`<div class="route_accepted_content_type">
            <p><strong>Accepted content types:</strong></p>
            <ul>
              ${acceptedMediaTypes.map(
                (acceptedMediaType) => html`<li>${acceptedMediaType}</li>`,
              )}
            </ul>
          </div>`;
      };

      const RouteCodeExample = ({
        method,
        resource,
        availableMediaTypes,
        websocket,
        clientCodeExample,
      }) => {
        let jsSource;
        if (clientCodeExample) {
          jsSource = clientCodeExample;
        } else if (websocket) {
          const websocketScheme =
            self.location.protocol === "https:" ? "wss" : "ws";
          const websocketOrigin = `${websocketScheme}://${self.location.host}`;
          jsSource = /*js */ `
                const websocket = new WebSocket("${websocketOrigin}${resource}");
                websocket.onerror = () => {
                  console.error("Failed to connect to websocket endpoint");
                };
                websocket.onopen = () => {
                  console.info("Connected to websocket endpoint")
                };
                websocket.onmessage = (event) => {
                  console.log("Received message", event.data);
                };
                `;
        } else {
          let fetchLine;
          if (method === "GET") {
            fetchLine = `const response = await window.fetch("${resource}");`;
          } else {
            fetchLine = `const response = await window.fetch("${resource}", {
        method: "${method}",
      }`;
          }
          let readResponseLine;
          if (availableMediaTypes.includes("application/json")) {
            readResponseLine = `const json = await response.json();`;
          } else {
            readResponseLine = `const text = await response.text();`;
          }

          jsSource = /*js */ `
      ${fetchLine}
      ${readResponseLine}
                `;
        }

        return html`<code-block lang="js" data-escaped data-copy-button
            >${jsSource}</code-block
          >`;
      };

      const ArrowDown = ({ width = 24, height = 24 }) => {
        return html`<svg
            viewBox="0 -960 960 960"
            width="${width}"
            height="${height}"
            fill="currentColor"
            xmlns="http://www.w3.org/2000/svg"
          >
            <path d="M480-345 240-585l56-56 184 184 184-184 56 56-240 240Z" />
          </svg>`;
      };
      const OpenLink = () => {
        return html`<svg
            xmlns="http://www.w3.org/2000/svg"
            viewBox="0 0 64 64"
            stroke-width="3"
            stroke="currentColor"
            fill="none"
            width="24"
            height="24"
          >
            <path
              d="M55.4,32V53.58a1.81,1.81,0,0,1-1.82,1.82H10.42A1.81,1.81,0,0,1,8.6,53.58V10.42A1.81,1.81,0,0,1,10.42,8.6H32"
            />
            <polyline points="40.32 8.6 55.4 8.6 55.4 24.18" />
            <line x1="19.32" y1="45.72" x2="54.61" y2="8.91" />
          </svg>`;
      };

      render(html`<${Sidebar} />`, document.querySelector("aside"));
      render(html`<${App} />`, document.querySelector("#app"));
    </script>
  </body>
</html>
