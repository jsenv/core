<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Drag Gesture Demo - Table Column Dragging</title>
    <style>
      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        padding: 20px;
        font-family: Arial, sans-serif;
        background: #f0f0f0;
        /* Remove forced vertical scroll - let content determine height naturally */
        /* Remove forced horizontal scroll - let columns determine width naturally */
      }

      .demo-section {
        margin: 40px auto;
        max-width: 1200px;
      }

      .demo-title {
        background: white;
        padding: 15px 20px;
        border-radius: 8px 8px 0 0;
        border-bottom: 2px solid #333;
        margin: 0;
        font-size: 18px;
        font-weight: bold;
        color: #333;
      }

      .info {
        max-width: 1200px;
        margin: 0 auto 20px auto;
        padding: 20px;
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }

      .info h1 {
        margin-top: 0;
        color: #333;
      }

      .info ul {
        line-height: 1.6;
      }

      .table-container {
        height: 300px; /* Reduced from 600px */
        position: relative;
        margin: 0 auto;
        border-radius: 4px;
        /* border: 20px solid #ddd; */
        /* No overflow: auto - let document handle scrolling */
      }

      .table-content {
        /* Width determined by column content - no fixed width */
        height: 100%;
        position: relative;
        display: flex; /* Use flexbox for natural column layout */
      }

      /* Column representations (invisible/semi-transparent) */
      .column-representation {
        position: absolute;
        top: 0;
        height: 100%;
        background: rgba(255, 0, 0, 0.1);
        border: 1px dashed rgba(255, 0, 0, 0.3);
        z-index: 1;
        pointer-events: none;
        opacity: 0;
      }

      .column-representation[data-sticky-left] {
        background: rgba(0, 255, 0, 0.1);
        border: 1px dashed rgba(0, 255, 0, 0.3);
      }

      /* Actual table columns */
      .table-column {
        /* Remove position: absolute, let flex handle positioning */
        height: 100%;
        background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
        border-radius: 4px;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: flex-start;
        color: white;
        font-weight: bold;
        text-shadow: 1px 1px 1px rgba(0, 0, 0, 0.5);
        z-index: 2;
        padding: 10px;
        user-select: none;
      }

      .table-column.sticky-column {
        position: sticky;
        left: 0; /* Stick at left edge when scrolling */
        background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
        border-color: #a93226;
        z-index: 3;
      }

      #column2.sticky-column {
        left: 100px; /* Position second sticky column next to first */
      }

      .table-column[data-being-dragged] {
        opacity: 0.2;
        z-index: 1000;
      }

      .column-header {
        background: rgba(255, 255, 255, 0.2);
        padding: 8px 12px;
        border-radius: 4px;
        margin-bottom: 10px;
        width: 100%;
        text-align: center;
        font-size: 12px;
      }

      .sticky-column .column-header {
        cursor: grab; /* Only sticky column header is draggable */
      }

      .sticky-column .column-header:hover {
        background: rgba(255, 255, 255, 0.3);
      }

      .sticky-column .column-header[data-dragging] {
        cursor: grabbing;
        background: rgba(255, 255, 255, 0.4);
      }

      .column-cell {
        background: rgba(255, 255, 255, 0.1);
        padding: 6px 8px;
        border-radius: 3px;
        margin: 3px 0;
        width: 100%;
        text-align: center;
        font-size: 10px;
        border: 1px solid rgba(255, 255, 255, 0.2);
      }

      .drag-clone-viewport {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        overflow: hidden;
        z-index: 10000;
      }

      /* Drag clone container */
      .drag-clone-container {
        position: absolute;
        opacity: 1;
        /* transform: rotate(2deg); */
        overflow: hidden;
      }

      .drag-clone-container .table-content {
        border-radius: 8px;
      }

      .drag-clone-container .column-representation {
        background: rgba(0, 255, 255, 0.2);
      }

      .drag-clone-container .table-column {
        background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%);
        border-color: #d35400;
        /* Remove transform: scale(1.05) to keep original column sizes */
        opacity: 0.5;
      }

      .position-display {
        position: fixed;
        top: 10px;
        right: 10px;
        background: rgba(0, 0, 0, 0.8);
        color: white;
        padding: 10px;
        border-radius: 4px;
        font-family: monospace;
        font-size: 11px;
        z-index: 10000;
        line-height: 1.4;
        min-width: 350px;
      }

      .position-display div {
        margin: 2px 0;
      }

      .position-display .label {
        font-weight: bold;
        color: #ffeb3b;
      }

      .debug-toggle {
        margin: 20px auto;
        text-align: center;
      }

      .debug-toggle label {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        font-size: 14px;
        color: #333;
        cursor: pointer;
        background: white;
        padding: 10px 15px;
        border-radius: 4px;
        transition: all 0.2s ease;
      }

      .debug-toggle label:hover {
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
      }

      .debug-toggle input[type="checkbox"] {
        width: 18px;
        height: 18px;
        cursor: pointer;
      }

      .element-legend {
        background: white;
        padding: 15px;
        border-radius: 6px;
        margin: 20px auto;
        max-width: 900px;
        text-align: center;
      }

      .element-legend h4 {
        margin: 0 0 15px 0;
        font-size: 14px;
        color: #333;
      }

      .legend-item {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        margin: 0 15px 10px 0;
        font-size: 12px;
      }

      .legend-color {
        width: 30px;
        height: 20px;
        border-radius: 4px;
        border: 2px solid #333;
      }

      .legend-regular {
        background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
      }

      .legend-sticky {
        background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
      }

      .legend-representation {
        background: rgba(255, 0, 0, 0.2);
        border: 1px dashed rgba(255, 0, 0, 0.6);
      }

      .legend-sticky-representation {
        background: rgba(0, 255, 0, 0.2);
        border: 1px dashed rgba(0, 255, 0, 0.6);
      }

      .legend-clone {
        background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%);
      }

      .scroll-instructions {
        background: #fff3cd;
        border: 1px solid #ffeaa7;
        border-radius: 6px;
        padding: 15px;
        margin: 20px auto;
        max-width: 900px;
        text-align: center;
        color: #856404;
      }

      .scroll-instructions strong {
        color: #533f03;
      }
    </style>
  </head>
  <body>
    <details style="max-width: 1200px; margin: 0 auto 20px auto">
      <summary
        style="
          cursor: pointer;
          font-size: 18px;
          font-weight: bold;
          margin-bottom: 20px;
          padding: 10px;
          background: white;
          border-radius: 4px;
          box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        "
      >
        Demo Information & Instructions
      </summary>

      <div class="info">
        <h1>
          Drag Gesture Demo - Table Column Dragging with Sticky Positioning
        </h1>
        <p>
          This demo demonstrates a complex real-world scenario: dragging table
          columns with sticky positioning behavior.
        </p>
        <ul>
          <li>
            <strong>Table Structure:</strong> Two columns - regular (100px) and
            sticky (left: 100px)
          </li>
          <li>
            <strong>Column Representations:</strong> Semi-transparent elements
            mimicking <code>&lt;col&gt;</code> behavior
          </li>
          <li>
            <strong>Sticky Behavior:</strong> Second column becomes sticky when
            scrolled horizontally
          </li>
          <li>
            <strong>Drag Mechanics:</strong> Click column header to drag the
            invisible column representation
          </li>
          <li>
            <strong>Clone System:</strong> Creates a cloned structure during
            drag with visual feedback
          </li>
          <li>
            <strong>Real Use Case:</strong> Table column reordering in data
            grids with sticky columns
          </li>
        </ul>
      </div>

      <div class="scroll-instructions">
        <strong>Instructions:</strong> Scroll the document horizontally to see
        the red sticky column behavior, then try dragging the sticky column
        header to move the column representation. Only the sticky column is
        draggable.
      </div>

      <div class="element-legend">
        <h4>Element Types</h4>
        <div class="legend-item">
          <div class="legend-color legend-regular"></div>
          <span>Regular Column</span>
        </div>
        <div class="legend-item">
          <div class="legend-color legend-sticky"></div>
          <span>Sticky Column</span>
        </div>
        <div class="legend-item">
          <div class="legend-color legend-representation"></div>
          <span>Column Representation</span>
        </div>
        <div class="legend-item">
          <div class="legend-color legend-sticky-representation"></div>
          <span>Sticky Column Representation</span>
        </div>
        <div class="legend-item">
          <div class="legend-color legend-clone"></div>
          <span>Drag Clone</span>
        </div>
      </div>
    </details>
    <div class="debug-toggle">
      <label>
        <input type="checkbox" id="debugMarkersCheckbox" checked />
        Show Debug Markers
      </label>
    </div>

    <!-- Demo: Table Column Dragging -->
    <div class="demo-section">
      <h2 class="demo-title">
        Demo: Table Column Dragging with Sticky Positioning
      </h2>
      <div class="table-container" id="tableContainer">
        <div class="table-content" id="tableContent">
          <!-- Column representations (before actual columns in DOM) -->
          <!-- Note: These representations now match the flexbox column positions -->
          <div
            class="column-representation"
            id="columnRep1"
            data-sticky-left=""
            style="left: 0; width: 100px"
          ></div>

          <div
            class="column-representation"
            id="columnRep2"
            data-sticky-left=""
            style="left: 100px; width: 120px"
          ></div>

          <!-- Actual table columns -->
          <div
            class="table-column sticky-column"
            id="column1"
            style="width: 100px"
          >
            <div class="column-header" id="column1Header">
              Column 1 (Sticky Draggable)
            </div>
            <div class="column-cell">Row 1</div>
            <div class="column-cell">Row 2</div>
            <div class="column-cell">Row 3</div>
          </div>

          <div
            class="table-column sticky-column"
            id="column2"
            style="width: 120px"
          >
            <div class="column-header" id="column2Header">
              Sticky Column (Draggable)
            </div>
            <div class="column-cell">Sticky 1</div>
            <div class="column-cell">Sticky 2</div>
            <div class="column-cell">Sticky 3</div>
          </div>

          <!-- More columns to show scrolling -->
          <div class="table-column" style="width: 150px">
            <div class="column-header">Column 3</div>
            <div class="column-cell">Data A</div>
            <div class="column-cell">Data B</div>
            <div class="column-cell">Data C</div>
          </div>

          <div class="table-column" style="width: 150px">
            <div class="column-header">Column 4</div>
            <div class="column-cell">Info 1</div>
            <div class="column-cell">Info 2</div>
            <div class="column-cell">Info 3</div>
          </div>

          <div class="table-column" style="width: 150px">
            <div class="column-header">Column 5</div>
            <div class="column-cell">Value X</div>
            <div class="column-cell">Value Y</div>
            <div class="column-cell">Value Z</div>
          </div>

          <div class="table-column" style="width: 160px">
            <div class="column-header">Column 6</div>
            <div class="column-cell">Report A</div>
            <div class="column-cell">Report B</div>
            <div class="column-cell">Report C</div>
          </div>

          <div class="table-column" style="width: 140px">
            <div class="column-header">Column 7</div>
            <div class="column-cell">Status 1</div>
            <div class="column-cell">Status 2</div>
            <div class="column-cell">Status 3</div>
          </div>

          <div class="table-column" style="width: 180px">
            <div class="column-header">Column 8</div>
            <div class="column-cell">Analysis X</div>
            <div class="column-cell">Analysis Y</div>
            <div class="column-cell">Analysis Z</div>
          </div>

          <div class="table-column" style="width: 170px" data-drag-obstacle>
            <div class="column-header">Column 9</div>
            <div class="column-cell">Result A</div>
            <div class="column-cell">Result B</div>
            <div class="column-cell">Result C</div>
          </div>

          <div class="table-column" style="width: 160px">
            <div class="column-header">Column 10</div>
            <div class="column-cell">Final 1</div>
            <div class="column-cell">Final 2</div>
            <div class="column-cell">Final 3</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Position Display -->
    <div class="position-display" id="positionDisplay">
      <div class="label">Column Drag Info</div>
      <div id="dragInfo">Ready to drag sticky column headers</div>
      <div id="scrollInfo">Scroll: 0px (sticky not activated)</div>
      <div id="elementInfo">
        Click and drag either sticky column header (Column 1 or Sticky Column)
      </div>
    </div>

    <script type="module">
      import { createDragToMoveGestureController } from "../interaction/drag_gesture.js";
      import {
        DRAG_DEBUG_MARKERS,
        enableDebugMarkers,
        disableDebugMarkers,
      } from "../interaction/debug_markers.js";

      const debugCheckbox = document.getElementById("debugMarkersCheckbox");
      const dragInfo = document.getElementById("dragInfo");
      const scrollInfo = document.getElementById("scrollInfo");
      const elementInfo = document.getElementById("elementInfo");
      const column1Header = document.getElementById("column1Header");
      const column1 = document.getElementById("column1");
      const columnRep1 = document.getElementById("columnRep1");
      const column2Header = document.getElementById("column2Header");
      const column2 = document.getElementById("column2");
      const columnRep2 = document.getElementById("columnRep2");

      // Handle debug markers toggle
      debugCheckbox.checked = DRAG_DEBUG_MARKERS;
      debugCheckbox.addEventListener("change", (e) => {
        if (e.target.checked) {
          enableDebugMarkers();
        } else {
          disableDebugMarkers();
        }
      });

      // Track scroll position for sticky behavior info
      document.addEventListener("scroll", () => {
        const scrollLeft = window.scrollX;
        const stickyActivated = scrollLeft > 100; // Sticky activates when first column starts disappearing
        scrollInfo.textContent = `Scroll: ${scrollLeft}px (sticky ${stickyActivated ? "ACTIVATED" : "not activated"})`;

        // Update viewport position to follow scroll during drag
        updateViewportPosition();
      });

      // Create drag clone container (will be populated during drag)
      let dragCloneViewport = null;
      let dragCloneContainer = null;

      function updateViewportPosition() {
        if (dragCloneViewport) {
          // Update viewport position to follow scroll
          dragCloneViewport.style.left = `${window.scrollX}px`;
          dragCloneViewport.style.top = `${window.scrollY}px`;
        }
      }

      function createDragClone() {
        // Create the viewport container that prevents scrollbar influence
        dragCloneViewport = document.createElement("div");
        dragCloneViewport.className = "drag-clone-viewport";

        // Position viewport at current scroll position
        dragCloneViewport.style.left = `${window.scrollX}px`;
        dragCloneViewport.style.top = `${window.scrollY}px`;

        // Create the clone container
        dragCloneContainer = document.createElement("div");
        dragCloneContainer.className = "drag-clone-container";

        // Get the position of the original table container to position clone exactly above it
        const tableContainer = document.getElementById("tableContainer");
        const tableRect = tableContainer.getBoundingClientRect();

        // Get table's natural offset position (without scroll influence)
        let tableOffsetLeft = 0;
        let element = tableContainer;
        while (element && element !== document.body) {
          tableOffsetLeft += element.offsetLeft;
          element = element.offsetParent;
        }

        // Calculate clone position based on scroll vs table offset
        const currentScrollX = window.scrollX;
        const cloneLeft =
          currentScrollX < tableOffsetLeft
            ? tableOffsetLeft - currentScrollX
            : 0;
        const cloneTop = tableRect.top; // Top position relative to viewport

        dragCloneContainer.style.width = `${tableRect.width}px`;
        dragCloneContainer.style.height = `${tableRect.height}px`;
        dragCloneContainer.style.left = `${cloneLeft}px`;
        dragCloneContainer.style.top = `${cloneTop}px`;

        // Clone the entire table content structure
        const tableContent = document.getElementById("tableContent");
        const clonedContent = tableContent.cloneNode(true);
        clonedContent.style.width = "100%";
        clonedContent.style.height = "100%";
        clonedContent.style.position = "relative";

        // Find the cloned elements we need to reference
        const clonedRep = clonedContent.querySelector("[data-sticky-left]");
        const clonedColumn = clonedContent.querySelector(".sticky-column");

        // Set opacity for clone columns: dragged column full opacity, others faded
        const allClonedColumns =
          clonedContent.querySelectorAll(".table-column");
        allClonedColumns.forEach((col) => {
          if (col.classList.contains("sticky-column")) {
            col.style.opacity = "1"; // Dragged column full opacity
          } else {
            col.style.opacity = "0.3"; // Other columns faded
          }
        });

        dragCloneContainer.appendChild(clonedContent);
        dragCloneViewport.appendChild(dragCloneContainer);
        document.body.appendChild(dragCloneViewport);

        return {
          container: dragCloneContainer,
          representation: clonedRep,
          column: clonedColumn,
        };
      }

      function removeDragClone() {
        // Keep clone for debugging - don't remove it
        if (dragCloneContainer && dragCloneViewport) {
          // Add a debug label to the clone
          const debugLabel = document.createElement("div");
          debugLabel.textContent = "DEBUG: Drag Clone (kept for debugging)";
          debugLabel.style.position = "absolute";
          debugLabel.style.top = "-25px";
          debugLabel.style.left = "0";
          debugLabel.style.background = "rgba(255, 0, 0, 0.8)";
          debugLabel.style.color = "white";
          debugLabel.style.padding = "5px 10px";
          debugLabel.style.fontSize = "12px";
          debugLabel.style.borderRadius = "4px";
          debugLabel.style.zIndex = "10001";
          dragCloneContainer.appendChild(debugLabel);

          // Make clone semi-transparent to show it's in debug mode
          dragCloneContainer.style.opacity = "0.7";

          // Reset variables so we can create new ones next time
          dragCloneContainer = null;
          dragCloneViewport = null;
        }
      }

      // Generic function to handle column dragging
      function setupColumnDrag(columnConfig) {
        const { header, column, representation, name, displayName } =
          columnConfig;

        header.addEventListener("mousedown", (event) => {
          console.log(`${displayName} drag started`, {
            header,
            column,
            representation,
          });

          const dragClone = createDragClone();

          createDragToMoveGestureController({
            name: `table-column-${name}`,
            backdrop: false,
            direction: { x: true },
            onGrab: (gestureInfo) => {
              console.log(`${displayName} grab started`, gestureInfo);
              header.setAttribute("data-dragging", "");
              column.setAttribute("data-being-dragged", "");

              // Set opacity for original table and dragged column
              const tableContent = document.getElementById("tableContent");
              tableContent.style.opacity = "0.1"; // Make original table very faded
              column.style.opacity = "0"; // Make original dragged column invisible

              updateDragInfo(gestureInfo, "Grabbed");
              elementInfo.textContent = `Dragging: ${displayName} representation will move`;
            },
            onDragStart: (gestureInfo) => {
              console.log(`${displayName} drag started`, gestureInfo);
              updateDragInfo(gestureInfo, "Drag Start");
            },
            onDrag: (gestureInfo, phase) => {
              updateDragInfo(gestureInfo, `Dragging (${phase})`);
            },
            onRelease: (gestureInfo) => {
              console.log(`${displayName} drag released`, gestureInfo);
              header.removeAttribute("data-dragging");
              column.removeAttribute("data-being-dragged");

              // Restore opacity for original table and dragged column
              const tableContent = document.getElementById("tableContent");
              tableContent.style.opacity = ""; // Restore original table opacity
              column.style.opacity = ""; // Restore original dragged column opacity

              removeDragClone();
              updateDragInfo(gestureInfo, "Released");
              elementInfo.textContent =
                "Click and drag either sticky column header";
            },
          }).grabViaMouse(event, {
            element: header, // Clicked element (header)
            elementToImpact: dragClone.container, // Move the clone container
            elementVisuallyImpacted: dragClone.representation, // Track the representation clone
          });
        });
      }

      // Column header drag handling
      setupColumnDrag({
        header: column2Header,
        column: column2,
        representation: columnRep2,
        name: "2",
        displayName: "Sticky Column",
      });

      setupColumnDrag({
        header: column1Header,
        column: column1,
        representation: columnRep1,
        name: "1",
        displayName: "Column 1",
      });

      function updateDragInfo(gestureInfo, status) {
        const columnRect = column2.getBoundingClientRect();
        const repRect = columnRep2.getBoundingClientRect();

        const columnX = columnRect.left + window.scrollX;
        const columnY = columnRect.top + window.scrollY;
        const repX = repRect.left + window.scrollX;
        const repY = repRect.top + window.scrollY;

        dragInfo.innerHTML = `${status} | Column: ${Math.round(columnX)}, ${Math.round(columnY)} | Rep: ${Math.round(repX)}, ${Math.round(repY)}`;
      }

      // Initial position updates
      function updatePositions() {
        if (!column2Header.hasAttribute("data-dragging")) {
          const columnRect = column2.getBoundingClientRect();
          const repRect = columnRep2.getBoundingClientRect();

          const columnX = columnRect.left + window.scrollX;
          const columnY = columnRect.top + window.scrollY;
          const repX = repRect.left + window.scrollX;
          const repY = repRect.top + window.scrollY;

          dragInfo.innerHTML = `Ready | Column: ${Math.round(columnX)}, ${Math.round(columnY)} | Rep: ${Math.round(repX)}, ${Math.round(repY)}`;
        }
      }

      // Update positions on scroll
      document.addEventListener("scroll", updatePositions);
      updatePositions();

      // Auto-scroll to show sticky behavior

      window.scrollTo(300, 0); // Scroll further to ensure sticky behavior is clearly visible
    </script>
  </body>
</html>
