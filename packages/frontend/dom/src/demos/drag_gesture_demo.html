<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Drag Gesture Demo - Multiple Cases</title>
    <style>
      body {
        margin: 0;
        padding: 20px;
        font-family: Arial, sans-serif;
        background: #f0f0f0;
      }

      .demo-section {
        margin: 40px auto;
        max-width: 800px;
      }

      .demo-title {
        background: white;
        padding: 15px 20px;
        border-radius: 8px 8px 0 0;
        border-bottom: 2px solid #333;
        margin: 0;
        font-size: 18px;
        font-weight: bold;
        color: #333;
      }

      .container {
        width: 400px;
        height: 200px;
        background: white;
        overflow: auto;
        position: relative;
        margin: 0 auto;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        border-radius: 4px;
      }

      /* Horizontal scrollbar only - content wider but same height */
      .horizontal-content {
        width: 600px; /* Wider than container = horizontal scrollbar */
        height: 180px; /* Same height as container = no vertical scrollbar */
        background: linear-gradient(
          90deg,
          transparent 99px,
          #ddd 100px,
          #ddd 101px,
          transparent 102px
        );
        background-size: 100px 100px;
        position: relative;
      }

      /* Both scrollbars - content wider and taller */
      .both-content {
        width: 600px; /* Wider than container = horizontal scrollbar */
        height: 400px; /* Taller than container = vertical scrollbar */
        background:
          linear-gradient(
            90deg,
            transparent 99px,
            #ddd 100px,
            #ddd 101px,
            transparent 102px
          ),
          linear-gradient(
            transparent 99px,
            #ddd 100px,
            #ddd 101px,
            transparent 102px
          );
        background-size: 100px 100px;
        position: relative;
      }

      .draggable-rectangle {
        width: 80px;
        height: 60px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border: 2px solid #333;
        border-radius: 8px;
        position: absolute;
        top: 50px;
        left: 50px;
        cursor: grab;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: bold;
        text-shadow: 1px 1px 1px rgba(0, 0, 0, 0.5);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        transition: box-shadow 0.2s ease;
      }

      .draggable-rectangle:hover {
        box-shadow: 0 6px 12px rgba(0, 0, 0, 0.3);
      }

      .draggable-rectangle[data-dragging] {
        cursor: grabbing;
        box-shadow: 0 8px 16px rgba(0, 0, 0, 0.4);
        z-index: 1000;
      }

      .info {
        max-width: 800px;
        margin: 0 auto;
        padding: 20px;
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }

      .info h1 {
        margin-top: 0;
        color: #333;
      }

      .info ul {
        line-height: 1.6;
      }

      .debug-toggle {
        margin: 20px auto;
        text-align: center;
      }

      .debug-toggle label {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        font-size: 14px;
        color: #333;
        cursor: pointer;
        background: white;
        padding: 10px 15px;
        border-radius: 4px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        transition: all 0.2s ease;
      }

      .debug-toggle label:hover {
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
      }

      .debug-toggle input[type="checkbox"] {
        width: 18px;
        height: 18px;
        cursor: pointer;
      }
    </style>
  </head>
  <body>
    <div class="info">
      <h1>Drag Gesture Demo - Scrollbar Cases</h1>
      <p>
        This demo tests drag gesture auto-scroll with different scrollbar
        configurations:
      </p>
      <ul>
        <li>
          <strong>Drag rectangles in any direction</strong> - they're not
          restricted to scroll direction
        </li>
        <li>
          <strong>Auto-scroll triggers</strong> when you drag near container
          edges
        </li>
        <li>
          <strong>Case 1:</strong> Only horizontal scrollbar visible (content
          wider, same height)
        </li>
        <li>
          <strong>Case 2:</strong> Both scrollbars visible (content wider and
          taller)
        </li>
        <li>
          <strong>Visual debug markers</strong> show boundaries and scroll areas
        </li>
      </ul>
    </div>

    <div class="debug-toggle">
      <label>
        <input type="checkbox" id="debugMarkersCheckbox" checked />
        Show Debug Markers
      </label>
    </div>

    <!-- Case 1: Only Horizontal Scrollbar -->
    <div class="demo-section">
      <h2 class="demo-title">
        Case 1: Only Horizontal Scrollbar (content wider, same height)
      </h2>
      <div
        style="
          display: flex;
          gap: 20px;
          align-items: flex-start;
          justify-content: center;
        "
      >
        <div class="container" id="horizontalContainer">
          <div class="horizontal-content">
            <div class="draggable-rectangle" id="horizontalRectangle">
              DRAG ME
            </div>
          </div>
        </div>

        <!-- Programmatic Controls for Case 1 -->
        <div
          style="
            background: white;
            padding: 15px;
            border-radius: 6px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            min-width: 280px;
            position: relative;
            z-index: 10;
          "
        >
          <h4 style="margin: 0 0 10px 0; font-size: 14px; color: #333">
            Programmatic Controls
          </h4>
          <div style="display: flex; flex-direction: column; gap: 8px">
            <button
              id="grabBtn1"
              style="
                padding: 8px 12px;
                background: #4caf50;
                color: white;
                border: none;
                border-radius: 3px;
                cursor: pointer;
                font-size: 12px;
              "
            >
              Grab
            </button>
            <button
              id="dragRightBtn1"
              disabled
              style="
                padding: 8px 12px;
                background: #2196f3;
                color: white;
                border: none;
                border-radius: 3px;
                cursor: pointer;
                font-size: 12px;
                opacity: 0.5;
              "
            >
              Drag Right
            </button>
            <button
              id="dragDownBtn1"
              disabled
              style="
                padding: 8px 12px;
                background: #ff9800;
                color: white;
                border: none;
                border-radius: 3px;
                cursor: pointer;
                font-size: 12px;
                opacity: 0.5;
              "
            >
              Drag Down
            </button>
            <button
              id="releaseBtn1"
              disabled
              style="
                padding: 8px 12px;
                background: #f44336;
                color: white;
                border: none;
                border-radius: 3px;
                cursor: pointer;
                font-size: 12px;
                opacity: 0.5;
              "
            >
              Release
            </button>
          </div>
          <div
            id="status1"
            style="
              margin-top: 10px;
              padding: 8px;
              background: #f9f9f9;
              border-radius: 3px;
              font-family: monospace;
              font-size: 10px;
              color: #666;
            "
          >
            Ready
          </div>
        </div>
      </div>
    </div>

    <!-- Case 2: Both Scrollbars -->
    <div class="demo-section">
      <h2 class="demo-title">
        Case 2: Both Scrollbars (content wider and taller)
      </h2>
      <div
        style="
          display: flex;
          gap: 20px;
          align-items: flex-start;
          justify-content: center;
        "
      >
        <div class="container" id="bothContainer">
          <div class="both-content">
            <div class="draggable-rectangle" id="bothRectangle">DRAG ME</div>
          </div>
        </div>

        <!-- Programmatic Controls for Case 2 -->
        <div
          style="
            background: white;
            padding: 15px;
            border-radius: 6px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            min-width: 280px;
            position: relative;
            z-index: 10;
          "
        >
          <h4 style="margin: 0 0 10px 0; font-size: 14px; color: #333">
            Programmatic Controls
          </h4>
          <div style="display: flex; flex-direction: column; gap: 8px">
            <button
              id="grabBtn2"
              style="
                padding: 8px 12px;
                background: #4caf50;
                color: white;
                border: none;
                border-radius: 3px;
                cursor: pointer;
                font-size: 12px;
              "
            >
              Grab
            </button>
            <button
              id="dragRightBtn2"
              disabled
              style="
                padding: 8px 12px;
                background: #2196f3;
                color: white;
                border: none;
                border-radius: 3px;
                cursor: pointer;
                font-size: 12px;
                opacity: 0.5;
              "
            >
              Drag Right
            </button>
            <button
              id="dragDownBtn2"
              disabled
              style="
                padding: 8px 12px;
                background: #ff9800;
                color: white;
                border: none;
                border-radius: 3px;
                cursor: pointer;
                font-size: 12px;
                opacity: 0.5;
              "
            >
              Drag Down
            </button>
            <button
              id="releaseBtn2"
              disabled
              style="
                padding: 8px 12px;
                background: #f44336;
                color: white;
                border: none;
                border-radius: 3px;
                cursor: pointer;
                font-size: 12px;
                opacity: 0.5;
              "
            >
              Release
            </button>
          </div>
          <div
            id="status2"
            style="
              margin-top: 10px;
              padding: 8px;
              background: #f9f9f9;
              border-radius: 3px;
              font-family: monospace;
              font-size: 10px;
              color: #666;
            "
          >
            Ready
          </div>
        </div>
      </div>
    </div>

    <script type="module">
      // Import the drag gesture functionality
      // Note: You'll need to adjust the import path based on your setup
      import {
        createDragGesture,
        startDragGesture,
        DRAG_DEBUG_VISUAL_MARKERS,
        enableDebugMarkers,
        disableDebugMarkers,
      } from "../interaction/drag_gesture.js";
      import { getScrollableParent } from "../scroll.js";

      // Make functions available globally for the demo
      window.createDragGesture = createDragGesture;
      window.startDragGesture = startDragGesture;
      window.getScrollableParent = getScrollableParent;
      window.enableDebugMarkers = enableDebugMarkers;
      window.disableDebugMarkers = disableDebugMarkers;

      const horizontalRectangle = document.getElementById(
        "horizontalRectangle",
      );
      const bothRectangle = document.getElementById("bothRectangle");
      const debugCheckbox = document.getElementById("debugMarkersCheckbox");

      // Handle debug markers toggle
      debugCheckbox.checked = DRAG_DEBUG_VISUAL_MARKERS;
      debugCheckbox.addEventListener("change", (e) => {
        if (e.target.checked) {
          enableDebugMarkers();
        } else {
          disableDebugMarkers();
        }
      });

      // Programmatic controls for Case 1 (Horizontal)
      const case1Controls = {
        grabBtn: document.getElementById("grabBtn1"),
        dragRightBtn: document.getElementById("dragRightBtn1"),
        dragDownBtn: document.getElementById("dragDownBtn1"),
        releaseBtn: document.getElementById("releaseBtn1"),
        statusDiv: document.getElementById("status1"),
        rectangle: horizontalRectangle,
        dragGesture: null,
        dragInstance: null,
      };

      // Programmatic controls for Case 2 (Both scrollbars)
      const case2Controls = {
        grabBtn: document.getElementById("grabBtn2"),
        dragRightBtn: document.getElementById("dragRightBtn2"),
        dragDownBtn: document.getElementById("dragDownBtn2"),
        releaseBtn: document.getElementById("releaseBtn2"),
        statusDiv: document.getElementById("status2"),
        rectangle: bothRectangle,
        dragGesture: null,
        dragInstance: null,
      };

      function updateStatus(controls, message) {
        controls.statusDiv.textContent = message;
        console.log("Programmatic Control:", message);
      }

      function updateButtonStates(controls, grabbed = false) {
        controls.grabBtn.disabled = grabbed;
        controls.dragRightBtn.disabled = !grabbed;
        controls.dragDownBtn.disabled = !grabbed;
        controls.releaseBtn.disabled = !grabbed;

        // Update visual disabled state
        const buttons = [
          controls.dragRightBtn,
          controls.dragDownBtn,
          controls.releaseBtn,
        ];
        buttons.forEach((btn) => {
          btn.style.opacity = grabbed ? "1" : "0.5";
          btn.style.cursor = grabbed ? "pointer" : "not-allowed";
        });

        controls.grabBtn.style.opacity = grabbed ? "0.5" : "1";
        controls.grabBtn.style.cursor = grabbed ? "not-allowed" : "pointer";
      }

      function setupProgrammaticControls(controls, caseLabel) {
        // Grab button
        controls.grabBtn.addEventListener("click", () => {
          if (controls.dragInstance) return;

          const rectangle = controls.rectangle;
          const positionedParent = rectangle.offsetParent || document.body;
          const positionedParentRect = positionedParent.getBoundingClientRect();
          const rectangleRect = rectangle.getBoundingClientRect();

          // Calculate current position in relative coordinates (where it actually is now)
          const xAtStart = rectangleRect.left - positionedParentRect.left;
          const yAtStart = rectangleRect.top - positionedParentRect.top;

          controls.dragGesture = createDragGesture({
            backdrop: false,
            onGrab: (gestureInfo) => {
              updateStatus(controls, `Grabbed ${caseLabel} programmatically`);
              console.log("Programmatic grab:", gestureInfo);
            },
            onDragStart: (gestureInfo) => {
              updateStatus(controls, `Started drag on ${caseLabel}`);
              console.log("Programmatic drag start:", gestureInfo);
            },
            onDrag: (gestureInfo, phase) => {
              updateStatus(controls, `Dragging ${caseLabel} (${phase})`);
              console.log("Programmatic drag:", gestureInfo, phase);
            },
            onRelease: (gestureInfo) => {
              updateStatus(controls, `Released ${caseLabel}`);
              console.log("Programmatic release:", gestureInfo);
              controls.dragGesture = null;
              controls.dragInstance = null;
              updateButtonStates(controls, false);
            },
          });

          controls.dragInstance = controls.dragGesture.grab({
            element: rectangle,
            elementToMove: rectangle,
            elementVisuallyMoving: rectangle,
            xAtStart,
            yAtStart,
            addTeardown: () => {
              // Store cleanup callbacks if needed
            },
          });

          updateButtonStates(controls, true);
        });

        // Drag Right button
        controls.dragRightBtn.addEventListener("click", () => {
          if (!controls.dragInstance) return;

          // Get current gesture position and move right by 50px
          const currentGestureInfo = controls.dragInstance.gestureInfo;
          const newX = currentGestureInfo.x + 50;

          updateStatus(controls, `Dragging ${caseLabel} right by 50px`);
          controls.dragInstance.drag(newX, currentGestureInfo.y);
        });

        // Drag Down button
        controls.dragDownBtn.addEventListener("click", () => {
          if (!controls.dragInstance) return;

          // Get current gesture position and move down by 50px
          const currentGestureInfo = controls.dragInstance.gestureInfo;
          const newY = currentGestureInfo.y + 50;

          updateStatus(controls, `Dragging ${caseLabel} down by 50px`);
          controls.dragInstance.drag(currentGestureInfo.x, newY);
        });

        // Release button
        controls.releaseBtn.addEventListener("click", () => {
          if (!controls.dragInstance) return;

          const currentGestureInfo = controls.dragInstance.gestureInfo;
          updateStatus(controls, `Releasing ${caseLabel}`);
          controls.dragInstance.release(
            currentGestureInfo.x,
            currentGestureInfo.y,
          );
        });

        updateButtonStates(controls, false);
      }

      // Set up both sets of controls
      setupProgrammaticControls(case1Controls, "horizontal case");
      setupProgrammaticControls(case2Controls, "both scrollbars case");

      // Function to set up drag gesture for any rectangle
      function setupDragGesture(rectangle, caseLabel) {
        rectangle.addEventListener("mousedown", (event) => {
          startDragGesture(event, {
            setup: () => ({
              element: rectangle,
              elementToMove: rectangle,
              elementVisuallyMoving: rectangle,
            }),
            onGrab: (gestureInfo) => {
              console.log(`${caseLabel} - Grab started`, gestureInfo);
            },
            onDragStart: (gestureInfo) => {
              console.log(`${caseLabel} - Drag started`, gestureInfo);
            },
            onDrag: () => {
              // console.log(`${caseLabel} - Dragging`, gestureInfo, phase);
            },
            onRelease: (gestureInfo) => {
              console.log(`${caseLabel} - Drag released`, gestureInfo);
            },
          });
        });
      }

      // Set up drag gestures for all rectangles
      setupDragGesture(horizontalRectangle, "Horizontal Only");
      setupDragGesture(bothRectangle, "Both Directions");
    </script>

    <script>
      // Add visual feedback for multiple containers
      document.addEventListener("DOMContentLoaded", () => {
        const horizontalContainer = document.getElementById(
          "horizontalContainer",
        );
        const bothContainer = document.getElementById("bothContainer");
        const horizontalRectangle = document.getElementById(
          "horizontalRectangle",
        );
        const bothRectangle = document.getElementById("bothRectangle");

        // Create info display for horizontal case
        const horizontalInfo = createInfoDisplay(
          "Horizontal Case",
          "10px",
          "10px",
        );
        const bothInfo = createInfoDisplay("Both Directions", "10px", "200px");

        function createInfoDisplay(label, top, right) {
          const info = document.createElement("div");
          info.style.position = "fixed";
          info.style.top = top;
          info.style.right = right;
          info.style.background = "rgba(0,0,0,0.8)";
          info.style.color = "white";
          info.style.padding = "8px 12px";
          info.style.borderRadius = "4px";
          info.style.fontSize = "11px";
          info.style.fontFamily = "monospace";
          info.style.zIndex = "10000";
          info.style.lineHeight = "1.4";
          info.style.minWidth = "160px";
          document.body.appendChild(info);
          return info;
        }

        function updateInfo(container, rectangle, infoDisplay, label) {
          const rect = rectangle.getBoundingClientRect();
          const containerRect = container.getBoundingClientRect();
          const relativeX =
            rect.left - containerRect.left + container.scrollLeft;
          const relativeY = rect.top - containerRect.top + container.scrollTop;

          infoDisplay.innerHTML = `
            <div style="font-weight: bold; margin-bottom: 4px;">${label}</div>
            <div>Scroll: ${Math.round(container.scrollLeft)}, ${Math.round(container.scrollTop)}</div>
            <div>Pos: ${Math.round(relativeX)}, ${Math.round(relativeY)}</div>
          `;
        }

        // Set up scroll listeners and initial updates
        function setupContainerMonitoring(
          container,
          rectangle,
          infoDisplay,
          label,
        ) {
          function update() {
            updateInfo(container, rectangle, infoDisplay, label);
          }

          container.addEventListener("scroll", update);
          update();

          // Update position info periodically while dragging
          let updateInterval;
          rectangle.addEventListener("mousedown", () => {
            updateInterval = setInterval(update, 16); // ~60fps
          });

          document.addEventListener("mouseup", () => {
            if (updateInterval) {
              clearInterval(updateInterval);
              update(); // Final update
            }
          });
        }

        setupContainerMonitoring(
          horizontalContainer,
          horizontalRectangle,
          horizontalInfo,
          "Horizontal Only",
        );
        setupContainerMonitoring(
          bothContainer,
          bothRectangle,
          bothInfo,
          "Both Directions",
        );
      });
    </script>
  </body>
</html>
