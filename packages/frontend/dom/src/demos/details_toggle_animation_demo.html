<!doctype html>
<html>
  <head>
    <title>Aside and main demo</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta charset="utf-8" />
    <link rel="icon" href="data:," />
  </head>
  <body>
    <style>
      * {
        box-sizing: border-box;
      }

      #app {
        display: flex;
        flex-direction: row;
      }

      main {
        min-width: 200px;
        padding-bottom: 0;
        min-width: 200px; /* Prevents content area from becoming too narrow */
        box-sizing: border-box;
        min-height: 100vh; /* Ensures content area is at least viewport height */
        overflow-x: auto; /* Horizontal scrollbar appears when content is wider than available space */
        scrollbar-gutter: stable; /* Reserves space for scrollbar to prevent layout shifts */

        width: 100px;
      }

      details {
        width: 100%;
        overflow: hidden;
      }

      details > summary {
        user-select: none;
        background: lightblue;
      }
    </style>

    <div id="app">
      <main>
        <details>
          <summary>First summary</summary>
          <div style="padding: 20px; width: 100%">
            This is the main content area. Lorem ipsum dolor sit amet,
            consectetur adipiscing elit. Sed do eiusmod tempor incididunt ut
            labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud
            exercitation
          </div>
        </details>
        <details>
          <summary>Second summary</summary>
          <div style="padding: 20px; width: fit-content">
            This is the main content area. Lorem ipsum dolor sit amet,
            consectetur adipiscing elit. Sed do eiusmod tempor incididunt ut
            labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud
            exercitation
          </div>
        </details>
        <details>
          <summary>Third summary</summary>
          <div style="padding: 20px; width: fit-content">
            This is the main content area. Lorem ipsum dolor sit amet,
            consectetur adipiscing elit. Sed do eiusmod tempor incididunt ut
            labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud
            exercitation
          </div>
        </details>
      </main>
    </div>

    <script type="module">
      const animateDetails = (details) => {
        const summary = details.querySelector("summary");

        let detailsHeight;
        let summaryHeight;
        const updateHeights = () => {
          summaryHeight = summary.getBoundingClientRect().height;
          if (details.open) {
            detailsHeight = details.getBoundingClientRect().height;
          }
        };
        updateHeights();

        details.style.overflow = "hidden";
        if (!details.open) {
          details.style.height = `${summaryHeight}px`;
        }

        let currentAnimation = null;
        const detailsResizeObserver = new ResizeObserver(() => {
          if (!currentAnimation) {
            updateHeights();
          }
        });
        detailsResizeObserver.observe(details);
        const summaryResizeObserver = new ResizeObserver(() => {
          updateHeights();
        });
        summaryResizeObserver.observe(summary);

        const finalizeAnimation = (isOpen) => {
          if (isOpen) {
            // For open state, set to auto to allow content changes
            details.style.height = `${detailsHeight}px`;
          } else {
            // For closed state, set explicit summary height
            details.style.height = `${summaryHeight}px`;
          }
          if (currentAnimation) {
            currentAnimation.finish();
            currentAnimation.cancel(); // This removes the animation's effect
            currentAnimation = null;
          }
        };

        details.ontoggle = (toggleEvent) => {
          const isOpening = toggleEvent.newState === "open";

          // If an animation is already running, just reverse it
          if (currentAnimation) {
            currentAnimation.reverse();
            // Update the onfinish handler to match the new direction
            currentAnimation.onfinish = () => finalizeAnimation(isOpening);
            return;
          }

          if (isOpening) {
            details.style.height = "auto";
            updateHeights();
            details.style.height = `${summaryHeight}px`;
            currentAnimation = details.animate(
              [
                { height: `${summaryHeight}px` },
                { height: `${detailsHeight}px` },
              ],
              {
                duration: 300, // Shorter duration for better responsiveness
                easing: "ease-out",
              },
            );
            currentAnimation.onfinish = () => finalizeAnimation(true);
            currentAnimation.oncancel = () => {
              currentAnimation = null;
            };
          } else {
            details.style.height = `${detailsHeight}px`;
            currentAnimation = details.animate(
              [
                { height: `${detailsHeight}px` },
                { height: `${summaryHeight}px` },
              ],
              {
                duration: 300,
                easing: "ease-in",
              },
            );
            currentAnimation.onfinish = () => finalizeAnimation(false);
            currentAnimation.oncancel = () => {
              currentAnimation = null;
            };
          }
        };
      };

      for (const details of document.querySelectorAll("details")) {
        animateDetails(details);
      }
    </script>
  </body>
</html>
