<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Content States Transition Demo</title>
    <style>
      body {
        margin: 0;
        font-family: system-ui;
      }

      .controls {
        padding: 20px;
        border-bottom: 1px solid #ccc;
        background: #f5f5f5;
      }

      .demo-container {
        padding: 20px;
      }

      #content-box {
        background: white;
        border: 2px solid #666;
        padding: 16px;
        margin: 20px 0;
        width: 300px;
      }

      /* State-specific styles */
      .loading-state {
        color: #666;
        text-align: center;
      }

      .loading-state.tall {
        padding: 140px 0;
      }

      .content-state {
        color: #000;
      }

      .error-state {
        color: #d32f2f;
        text-align: center;
      }

      .error-state.tall {
        padding: 140px 0;
      }

      /* Shared styles */
      .content-block {
        background: #f0f0f0;
        margin: 8px 0;
        padding: 12px;
      }

      button {
        margin: 0 8px 8px 0;
        padding: 8px 16px;
      }

      button.active {
        background: #4caf50;
        color: white;
        border-color: #388e3c;
      }

      .spinner {
        display: inline-block;
        width: 24px;
        height: 24px;
        border: 3px solid #f3f3f3;
        border-top: 3px solid #666;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin-bottom: 8px;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }
    </style>
  </head>
  <body>
    <div class="controls">
      <h3>Predefined Sequences</h3>
      <label style="display: block; margin-bottom: 10px">
        <input type="checkbox" id="preserve-between-sequences" /> Preserve
        content between sequences
      </label>
      <div>
        <button id="demo-loading-content">Loading → Content</button>
        <button id="demo-loading-content-big">
          Loading → Content (big content)
        </button>
        <button id="demo-loading-content-big-loading">
          Loading → Content (big loading)
        </button>
      </div>
      <div>
        <button id="demo-loading-error">Loading → Error</button>
        <button id="demo-loading-error-big">Loading → Error (big error)</button>
      </div>
      <div>
        <button id="demo-error-loading-content">
          Error → Loading → Content
        </button>
        <button id="demo-error-loading-content-big">
          Error → Loading → Content (big content)
        </button>
      </div>
      <div>
        <button id="demo-content-to-bigger">
          Content → Loading → Bigger Content
        </button>
        <button id="demo-content-to-smaller">
          Big Content → Loading → Smaller Content
        </button>
        <button id="demo-content-a-to-b">
          Content A → Loading → Content B
        </button>
      </div>

      <h3 style="margin-top: 20px">Manual Control</h3>
      <div>
        <button id="show-loading">Loading</button>
        <button id="show-content">Content A</button>
        <button id="show-content-alt">Content B</button>
        <button id="show-error">Error</button>
      </div>
      <div>
        <button id="toggle-size">Toggle Large State Size</button>
        <button id="reset-content">Reset Content</button>
      </div>
    </div>

    <div class="demo-container">
      <div id="content-box"></div>
    </div>

    <script type="module">
      import { initUITransition } from "../ui_transition/ui_transition.js";

      const contentBox = document.getElementById("content-box");
      let cleanup = initUITransition(contentBox);

      const createState = (type, options = {}) => {
        const {
          tall = false,
          bigContent = false,
          contentVariant = "A",
        } = options;

        const states = {
          loading: () => `
            <div class="loading-state ${tall ? "tall" : ""}" data-preserve-content-height>
              <div class="spinner"></div>
              <div>Loading...</div>
            </div>
          `,
          content: () => `
            <div class="content-state">
              ${
                contentVariant === "B"
                  ? `
                <div class="content-block">Alternative content block</div>
                <div class="content-block">With different structure</div>
                ${bigContent ? `<div class="content-block">And extra content when big</div>` : ""}
                `
                  : bigContent
                    ? Array.from({ length: 6 })
                        .map(
                          (_, i) => `
                <div class="content-block">Content block ${i + 1}</div>
              `,
                        )
                        .join("")
                    : `
                <div class="content-block">Content block one</div>
                <div class="content-block">Content block two</div>
                <div class="content-block">Content block three</div>
              `
              }
            </div>
          `,
          error: () => `
            <div class="error-state ${tall ? "tall" : ""}" data-preserve-content-height>
              <div>⚠️</div>
              <div>An error occurred</div>
            </div>
          `,
        };

        return states[type]();
      };

      // For manual control
      let isLargeState = false;
      let activeButton = document.getElementById("show-content");
      activeButton.classList.add("active");

      const resetContent = () => {
        // Properly cleanup the current maintainSize functionality
        if (cleanup) {
          cleanup();
        }

        // Reset content without any animation
        contentBox.innerHTML = "";

        // Reinstall the maintainSize functionality
        cleanup = initUITransition(contentBox);

        // Reset active button state
        activeButton.classList.remove("active");
        activeButton = document.getElementById("show-content");
        activeButton.classList.add("active");
      };

      const setState = (type, options = {}) => {
        if (
          !options.skipButtonUpdate &&
          type in { loading: 1, content: 1, error: 1 }
        ) {
          const buttonId =
            type === "content" && options.contentVariant === "B"
              ? "show-content-alt"
              : `show-${type}`;
          activeButton.classList.remove("active");
          activeButton = document.getElementById(buttonId);
          activeButton.classList.add("active");
        }
        contentBox.innerHTML = createState(type, options);
      };

      // Sequence runner
      const runSequence = async (sequence) => {
        for (const [type, delay, options] of sequence) {
          setState(type, { skipButtonUpdate: true, ...options });
          await new Promise((resolve) => setTimeout(resolve, delay));
        }
      };

      // Predefined sequences
      const sequences = {
        "loading-content": [
          ["loading", 1000],
          ["content", 0],
        ],
        "loading-content-big": [
          ["loading", 1000],
          ["content", 0, { bigContent: true }],
        ],
        "loading-content-big-loading": [
          ["loading", 1000, { tall: true }],
          ["content", 0],
        ],
        "loading-error": [
          ["loading", 1000],
          ["error", 0],
        ],
        "loading-error-big": [
          ["loading", 1000],
          ["error", 0, { tall: true }],
        ],
        "error-loading-content": [
          ["error", 1000],
          ["loading", 1000],
          ["content", 0],
        ],
        "error-loading-content-big": [
          ["error", 1000],
          ["loading", 1000],
          ["content", 0, { bigContent: true }],
        ],
        "content-to-bigger": [
          ["content", 500], // Show initial content for 500ms
          ["loading", 1000],
          ["content", 0, { bigContent: true }],
        ],
        "content-to-smaller": [
          ["content", 500, { bigContent: true }], // Show initial content for 500ms
          ["loading", 1000],
          ["content", 0],
        ],
        "content-a-to-b": [
          ["content", 500], // Show initial content for 500ms
          ["loading", 1000],
          ["content", 0, { contentVariant: "B" }],
        ],
      };

      // Setup sequence listeners
      Object.keys(sequences).forEach((key) => {
        document.getElementById(`demo-${key}`).addEventListener("click", () => {
          const shouldPreserve = document.getElementById(
            "preserve-between-sequences",
          ).checked;
          if (!shouldPreserve) {
            resetContent();
          }
          runSequence(sequences[key]);
        });
      });

      // Manual control listeners
      document
        .getElementById("show-loading")
        .addEventListener("click", () =>
          setState("loading", { tall: isLargeState }),
        );
      document
        .getElementById("show-content")
        .addEventListener("click", () => setState("content"));
      document
        .getElementById("show-content-alt")
        .addEventListener("click", () =>
          setState("content", { contentVariant: "B" }),
        );
      document
        .getElementById("show-error")
        .addEventListener("click", () =>
          setState("error", { tall: isLargeState }),
        );
      document
        .getElementById("reset-content")
        .addEventListener("click", resetContent);

      document.getElementById("toggle-size").addEventListener("click", () => {
        isLargeState = !isLargeState;
        const currentState = activeButton.id.replace("show-", "");
        setState(currentState, { tall: isLargeState });
      });
    </script>
  </body>
</html>
