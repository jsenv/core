<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Group Transition Controller Debugger Integration Test</title>
    <style>
      body {
        margin: 20px;
        font-family: Arial, sans-serif;
        background: #f5f5f5;
      }

      .container {
        max-width: 900px;
        margin: 0 auto;
        padding: 20px;
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      }

      .controls {
        display: flex;
        margin: 20px 0;
        flex-wrap: wrap;
        gap: 10px;
      }

      button {
        padding: 8px 16px;
        color: white;
        font-size: 14px;
        background: #007acc;
        border: none;
        border-radius: 4px;
        cursor: pointer;
      }

      button:hover {
        background: #005a99;
      }

      button:disabled {
        background: #ccc;
        cursor: not-allowed;
      }

      .status {
        margin: 10px 0;
        padding: 10px;
        background: #f0f8ff;
        border-left: 4px solid #007acc;
        border-radius: 4px;
      }

      .log {
        max-height: 250px;
        margin: 10px 0;
        padding: 10px;
        font-size: 12px;
        font-family: monospace;
        background: #f8f8f8;
        border-radius: 4px;
        overflow-y: auto;
      }

      .debug-controls {
        margin: 20px 0;
        padding: 15px;
        background: #fff3cd;
        border: 1px solid #ffeaa7;
        border-radius: 4px;
      }

      .debug-controls h3 {
        margin-top: 0;
        color: #856404;
      }

      .progress-bars {
        margin: 20px 0;
      }

      .progress-item {
        margin-bottom: 10px;
      }

      .progress-label {
        margin-bottom: 4px;
        color: #555;
        font-size: 12px;
      }

      .progress-bar {
        width: 100%;
        height: 16px;
        background: #e0e0e0;
        border-radius: 8px;
        overflow: hidden;
      }

      .progress-fill {
        width: 0%;
        height: 100%;
        transition: none;
      }

      .progress-fill.width {
        background: linear-gradient(90deg, #007acc, #0099ff);
      }

      .progress-fill.height {
        background: linear-gradient(90deg, #28a745, #5cb85c);
      }

      .progress-fill.opacity {
        background: linear-gradient(90deg, #dc3545, #f56565);
      }

      .progress-fill.group {
        background: linear-gradient(90deg, #6f42c1, #9966cc);
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>Group Transition Controller Debugger Integration Test</h1>

      <div class="progress-bars">
        <div class="progress-item">
          <div class="progress-label">Width Progress</div>
          <div class="progress-bar">
            <div class="progress-fill width" id="widthProgress"></div>
          </div>
        </div>
        <div class="progress-item">
          <div class="progress-label">Height Progress</div>
          <div class="progress-bar">
            <div class="progress-fill height" id="heightProgress"></div>
          </div>
        </div>
        <div class="progress-item">
          <div class="progress-label">Opacity Progress</div>
          <div class="progress-bar">
            <div class="progress-fill opacity" id="opacityProgress"></div>
          </div>
        </div>
        <div class="progress-item">
          <div class="progress-label">Group Progress (Average)</div>
          <div class="progress-bar">
            <div class="progress-fill group" id="groupProgress"></div>
          </div>
        </div>
      </div>

      <div class="controls">
        <button id="startBtn">Start Group Transitions</button>
        <button id="pauseBtn" disabled>Pause Group</button>
        <button id="resumeBtn" disabled>Resume Group</button>
        <button id="cancelBtn" disabled>Cancel Group</button>
      </div>

      <div class="debug-controls">
        <h3>üêõ Debugger Simulation</h3>
        <div style="margin-bottom: 10px">
          <label>
            <input type="checkbox" id="debugBreakpointsCheckbox" checked />
            Enable debug breakpoints at 25% and 75% progress for each transition
          </label>
        </div>
        <button id="triggerDebuggerBtn">
          Trigger Debugger (Pause All Transitions)
        </button>
        <button id="endDebuggerBtn" disabled>
          End Debugger (Resume All Transitions)
        </button>
        <p>
          <em
            >This simulates what happens when a debugger breakpoint is hit
            during group transitions.</em
          >
        </p>
      </div>

      <div class="status" id="status">Ready to start group transitions</div>

      <div class="log" id="log"></div>
    </div>

    <script type="module">
      import { createTimelineTransition } from "../transition_playback.js";
      import { createGroupTransitionController } from "../group_transition.js";
      import { notifyDebuggerStart } from "../debugger_topic.js";

      const widthProgress = document.getElementById("widthProgress");
      const heightProgress = document.getElementById("heightProgress");
      const opacityProgress = document.getElementById("opacityProgress");
      const groupProgress = document.getElementById("groupProgress");
      const status = document.getElementById("status");
      const log = document.getElementById("log");

      const startBtn = document.getElementById("startBtn");
      const pauseBtn = document.getElementById("pauseBtn");
      const resumeBtn = document.getElementById("resumeBtn");
      const cancelBtn = document.getElementById("cancelBtn");
      const triggerDebuggerBtn = document.getElementById("triggerDebuggerBtn");
      const endDebuggerBtn = document.getElementById("endDebuggerBtn");
      const debugBreakpointsCheckbox = document.getElementById(
        "debugBreakpointsCheckbox",
      );

      let currentGroupController = null;
      let notifyDebuggerEnd = null;

      function addLog(message) {
        const timestamp = new Date().toLocaleTimeString();
        log.innerHTML += `[${timestamp}] ${message}<br>`;
        log.scrollTop = log.scrollHeight;
      }

      function updateStatus(message) {
        status.textContent = message;
        addLog(`Status: ${message}`);
      }

      function updateButtons(state) {
        startBtn.disabled = state !== "idle";
        pauseBtn.disabled = state !== "running";
        resumeBtn.disabled = state !== "paused";
        cancelBtn.disabled = state === "idle";
        triggerDebuggerBtn.disabled = state !== "running";
      }

      function createGroupTransitions() {
        // Create width transition (50px to 200px)
        const widthTransition = createTimelineTransition({
          constructor: { name: "WidthTransition" },
          key: "width",
          from: 50,
          to: 200,
          duration: 2500,
          isVisual: true,
          lifecycle: {
            setup: () => {
              return {
                update: (transition) => {
                  const width = Math.round(transition.value);
                  widthProgress.style.width = `${transition.progress * 100}%`;

                  addLog(
                    `WIDTH: ${width}px, Progress: ${(transition.progress * 100).toFixed(1)}%`,
                  );
                },
                restore: () => {
                  widthProgress.style.width = "0%";
                },
              };
            },
          },
        });

        // Create height transition (50px to 120px)
        const heightTransition = createTimelineTransition({
          constructor: { name: "HeightTransition" },
          key: "height",
          from: 50,
          to: 120,
          duration: 3000,
          isVisual: true,
          lifecycle: {
            setup: () => {
              return {
                update: (transition) => {
                  const height = Math.round(transition.value);
                  heightProgress.style.width = `${transition.progress * 100}%`;

                  addLog(
                    `HEIGHT: ${height}px, Progress: ${(transition.progress * 100).toFixed(1)}%`,
                  );
                },
                restore: () => {
                  heightProgress.style.width = "0%";
                },
              };
            },
          },
        });

        // Create opacity transition (0.3 to 1.0)
        const opacityTransition = createTimelineTransition({
          constructor: { name: "OpacityTransition" },
          key: "opacity",
          from: 0.3,
          to: 1.0,
          duration: 2000,
          isVisual: true,
          lifecycle: {
            setup: () => {
              return {
                update: (transition) => {
                  const opacity = transition.value.toFixed(2);
                  opacityProgress.style.width = `${transition.progress * 100}%`;

                  addLog(
                    `OPACITY: ${opacity}, Progress: ${(transition.progress * 100).toFixed(1)}%`,
                  );
                },
                restore: () => {
                  opacityProgress.style.width = "0%";
                },
              };
            },
          },
        });

        return [widthTransition, heightTransition, opacityTransition];
      }

      startBtn.addEventListener("click", () => {
        const transitions = createGroupTransitions();
        currentGroupController = createGroupTransitionController({
          debugQuarterBreakpoints: debugBreakpointsCheckbox.checked,
        });

        const groupTransition = currentGroupController.update(transitions, {
          onChange: (changeEntries) => {
            // Calculate average progress for group progress bar
            let totalProgress = 0;
            for (const entry of changeEntries) {
              totalProgress += entry.transition.progress || 0;
            }
            const averageProgress = totalProgress / changeEntries.length;
            groupProgress.style.width = `${averageProgress * 100}%`;

            updateStatus(
              `Group animating... ${(averageProgress * 100).toFixed(1)}% average progress`,
            );
          },
          onFinish: () => {
            updateStatus("All group transitions finished");
            updateButtons("idle");
            currentGroupController = null;
            addLog("üèÅ All group transitions finished");
          },
          onCancel: () => {
            updateStatus("All group transitions cancelled");
            updateButtons("idle");
            currentGroupController = null;
            addLog("‚ùå All group transitions cancelled");
          },
        });

        groupTransition.play();
        updateStatus("Group transitions started");
        updateButtons("running");
        addLog("üöÄ Group transitions started (width, height, opacity)");
        addLog(
          `üìä Using debug breakpoints: ${debugBreakpointsCheckbox.checked ? "YES" : "NO"}`,
        );
      });

      pauseBtn.addEventListener("click", () => {
        if (currentGroupController) {
          // Note: Group controller doesn't have pause method,
          // so we'll simulate it by cancelling and noting it was manual
          addLog("‚è∏Ô∏è Manual pause requested (will cancel group)");
          currentGroupController.cancel();
        }
      });

      resumeBtn.addEventListener("click", () => {
        addLog("‚ñ∂Ô∏è Resume not implemented for group controller");
        updateStatus("Resume not available for group controller");
      });

      cancelBtn.addEventListener("click", () => {
        if (currentGroupController) {
          currentGroupController.cancel();
          addLog("‚ùå Group transitions cancelled manually");
        }
      });

      triggerDebuggerBtn.addEventListener("click", () => {
        addLog(
          "üêõ Triggering debugger - this should pause all group transitions",
        );
        notifyDebuggerEnd = notifyDebuggerStart();

        updateStatus("Debugger active - all transitions should be paused");
        triggerDebuggerBtn.disabled = true;
        endDebuggerBtn.disabled = false;

        addLog(
          "‚è∏Ô∏è Debugger started, all group transitions should be paused automatically",
        );
      });

      endDebuggerBtn.addEventListener("click", () => {
        if (notifyDebuggerEnd) {
          addLog(
            "üêõ Ending debugger - this should resume all group transitions",
          );
          notifyDebuggerEnd();
          notifyDebuggerEnd = null;

          updateStatus("Debugger ended - all transitions should resume");
          triggerDebuggerBtn.disabled = !currentGroupController;
          endDebuggerBtn.disabled = true;

          addLog(
            "‚ñ∂Ô∏è Debugger ended, all group transitions should resume automatically",
          );
        }
      });

      // Initialize UI
      updateButtons("idle");
      addLog("üîß Group transition test page loaded and ready");
      addLog("üìù Instructions:");
      addLog(
        "1. Click 'Start Group Transitions' to begin coordinated width, height, and opacity animations",
      );
      addLog(
        "2. While running, click 'Trigger Debugger' to simulate a debugger breakpoint",
      );
      addLog(
        "3. Observe that ALL transitions pause automatically (width, height, opacity)",
      );
      addLog("4. Click 'End Debugger' to resume all transitions");
      addLog(
        "5. Verify all transitions continue smoothly from where they paused",
      );
      addLog(
        "6. Optional: Enable debug breakpoints checkbox for automatic breakpoints at 25% and 75%",
      );
      addLog(
        "üí° This tests the debugger integration with the group transition controller",
      );
    </script>
  </body>
</html>
