<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <link rel="icon" href="data:," />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Checkbox list demo</title>
  </head>
  <body>
    <div id="root" style="position: relative"></div>

    <script type="module" jsenv-type="module/jsx">
      import { render } from "preact";
      import { useState } from "preact/hooks";
      import {
        // eslint-disable-next-line no-unused-vars
        Button,
        // eslint-disable-next-line no-unused-vars
        Form,
        // eslint-disable-next-line no-unused-vars
        CheckboxList,
        // eslint-disable-next-line no-unused-vars
        Label,
        // eslint-disable-next-line no-unused-vars
        Checkbox,
      } from "@jsenv/navi";

      // eslint-disable-next-line no-unused-vars
      const App = () => {
        return (
          <div style="display: flex; flex-direction: column; gap: 40px">
            <DynamicCheckboxListDemo />
            <div style="display: flex; flex-direction: row; gap: 30px"></div>
          </div>
        );
      };

      // eslint-disable-next-line no-unused-vars
      const DynamicCheckboxListDemo = () => {
        // Available color choices with their selection state
        const [colorChoices, setColorChoices] = useState([
          { id: 1, color: "red", selected: true },
          { id: 2, color: "blue", selected: true },
          { id: 3, color: "green", selected: false },
        ]);

        // UI FORM STATE - This represents the current form state (may differ from data state)
        const [uiSelectedColors, setUiSelectedColors] = useState([
          "red",
          "blue",
        ]);

        // Next ID for new colors
        const [nextId, setNextId] = useState(4);

        // Random colors pool
        const randomColors = [
          "purple",
          "orange",
          "yellow",
          "pink",
          "cyan",
          "magenta",
          "lime",
          "indigo",
          "coral",
          "teal",
          "gold",
          "silver",
          "navy",
          "maroon",
        ];

        // Action that simulates submitting form data (takes 1s)
        const submitForm = async ({ colors }) => {
          console.log("Submitting form data:", colors);
          await new Promise((resolve) => setTimeout(resolve, 1000));
          // Update the data state to match the form submission
          setColorChoices((prev) =>
            prev.map((choice) => ({
              ...choice,
              selected: colors?.includes(choice.color) || false,
            })),
          );
          console.log("Data state updated from form:", colors);
        };

        // Add a new color to the data state
        const addColorToState = (color) => {
          setColorChoices((prev) => [
            ...prev,
            { id: nextId, color, selected: false },
          ]);
          setNextId((prev) => prev + 1);
        };

        // Remove a color from the data state
        const removeColorFromState = (colorId) => {
          setColorChoices((prev) =>
            prev.filter((choice) => choice.id !== colorId),
          );
          // Also remove from UI form if it was selected
          const colorToRemove = colorChoices.find(
            (choice) => choice.id === colorId,
          );
          if (colorToRemove) {
            setUiSelectedColors((prev) =>
              prev.filter((color) => color !== colorToRemove.color),
            );
          }
        };

        // Toggle selection state in the data state
        const toggleColorInState = (colorId) => {
          setColorChoices((prev) =>
            prev.map((choice) =>
              choice.id === colorId
                ? { ...choice, selected: !choice.selected }
                : choice,
            ),
          );
        };

        // Sync UI form state to current data state
        const syncFormToState = () => {
          const selectedColors = colorChoices
            .filter((choice) => choice.selected)
            .map((choice) => choice.color);
          setUiSelectedColors(selectedColors);
        }; // Add a random color choice to the data state
        const addRandomColor = () => {
          const availableColors = randomColors.filter(
            (color) => !colorChoices.some((choice) => choice.color === color),
          );
          if (availableColors.length > 0) {
            const randomColor =
              availableColors[
                Math.floor(Math.random() * availableColors.length)
              ];
            addColorToState(randomColor);
          }
        };

        return (
          <div style="border: 2px solid #ddd; padding: 20px; border-radius: 8px; background: #f9f9f9;">
            <h2>State ‚Üî UI Form Demo</h2>

            <div style="display: flex; gap: 20px; margin: 20px 0;">
              {/* DATA STATE SECTION */}
              <div style="flex: 1; padding: 15px; background: #fff; border-radius: 6px; border: 1px solid #ccc;">
                <h3 style="margin: 0 0 15px 0; color: #2196F3;">
                  üóÑÔ∏è Data State
                </h3>
                <p style="margin: 0 0 15px 0; font-size: 14px; color: #666;">
                  Direct manipulation of the data source
                </p>

                <div style="margin-bottom: 15px;">
                  <button
                    onClick={addRandomColor}
                    style="padding: 6px 12px; background: #4CAF50; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px; margin-right: 8px;"
                  >
                    + Add Random Color
                  </button>
                </div>

                <div style="display: flex; flex-direction: column; gap: 8px;">
                  {colorChoices.map(({ id, color, selected }) => (
                    <div
                      key={id}
                      style="display: flex; align-items: center; gap: 8px; padding: 6px; border: 1px solid #eee; border-radius: 3px; background: #fafafa;"
                    >
                      <span style="flex: 1; font-size: 14px;">
                        {color.charAt(0).toUpperCase() + color.slice(1)}
                      </span>

                      <button
                        onClick={() => toggleColorInState(id)}
                        style={{
                          padding: "4px 8px",
                          fontSize: "11px",
                          background: selected ? "#4CAF50" : "#ccc",
                          color: "white",
                          border: "none",
                          borderRadius: "3px",
                          cursor: "pointer",
                          minWidth: "60px",
                        }}
                      >
                        {selected ? "Selected" : "Not Selected"}
                      </button>

                      <button
                        onClick={() => removeColorFromState(id)}
                        style="padding: 4px 6px; background: #f44336; color: white; border: none; border-radius: 3px; cursor: pointer; font-size: 11px;"
                        title="Remove this color"
                      >
                        üóë
                      </button>
                    </div>
                  ))}
                </div>
              </div>

              {/* UI FORM SECTION */}
              <div style="flex: 1; padding: 15px; background: #fff; border-radius: 6px; border: 1px solid #ccc;">
                <h3 style="margin: 0 0 15px 0; color: #FF9800;">üìù UI Form</h3>
                <p style="margin: 0 0 15px 0; font-size: 14px; color: #666;">
                  Checkbox interface for user interaction
                </p>

                <Form action={submitForm}>
                  <fieldset style="border: 1px solid #ddd; padding: 10px; border-radius: 4px;">
                    <legend>Select Colors:</legend>
                    <CheckboxList name="colors">
                      {colorChoices.map(({ id, color }) => (
                        <Label key={id} style="display: block; margin: 5px 0;">
                          {color.charAt(0).toUpperCase() + color.slice(1)}
                          <Checkbox
                            value={color}
                            checked={uiSelectedColors.includes(color)}
                          />
                        </Label>
                      ))}
                    </CheckboxList>
                  </fieldset>

                  <div style="margin-top: 15px; display: flex; gap: 8px;">
                    <Button type="submit">üì§ Submit Form</Button>
                    <Button type="button" onClick={syncFormToState}>
                      üîÑ Reset to State
                    </Button>
                  </div>
                </Form>
              </div>
            </div>

            <div style="background: #f0f8ff; padding: 15px; border-radius: 6px; margin: 20px 0; border-left: 4px solid #2196F3;">
              <h4 style="margin: 0 0 10px 0;">How it works:</h4>
              <ul style="margin: 0; padding-left: 20px; font-size: 14px;">
                <li>
                  <strong>Data State</strong>: The actual data with direct
                  manipulation buttons
                </li>
                <li>
                  <strong>UI Form</strong>: Checkbox interface that can differ
                  from the data state
                </li>
                <li>
                  <strong>Submit</strong>: Updates data state to match the form
                  selections
                </li>
                <li>
                  <strong>Reset</strong>: Syncs form back to current data state
                </li>
              </ul>
            </div>
          </div>
        );
      };

      render(<App />, document.querySelector("#root"));
    </script>
  </body>
</html>
