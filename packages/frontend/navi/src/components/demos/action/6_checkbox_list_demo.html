<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <link rel="icon" href="data:," />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Checkbox list demo</title>
  </head>
  <body>
    <div id="root" style="position: relative"></div>

    <script type="module" jsenv-type="module/jsx">
      import { render } from "preact";
      import { useState } from "preact/hooks";
      import {
        // eslint-disable-next-line no-unused-vars
        Button,
        // eslint-disable-next-line no-unused-vars
        Form,
        // eslint-disable-next-line no-unused-vars
        CheckboxList,
        // eslint-disable-next-line no-unused-vars
        Label,
        // eslint-disable-next-line no-unused-vars
        Checkbox,
      } from "@jsenv/navi";

      // eslint-disable-next-line no-unused-vars
      const App = () => {
        return (
          <div style="display: flex; flex-direction: column; gap: 40px">
            <DynamicCheckboxListDemo />
            <div style="display: flex; flex-direction: row; gap: 30px"></div>
          </div>
        );
      };

      // eslint-disable-next-line no-unused-vars
      const DynamicCheckboxListDemo = () => {
        // Available color choices
        const [colorChoices, setColorChoices] = useState([
          { id: 1, color: "red" },
          { id: 2, color: "blue" },
          { id: 3, color: "green" },
        ]);

        // Selected colors state
        const [selectedColors, setSelectedColors] = useState(["red", "blue"]);

        // Display state for the action result
        const [displayedSelections, setDisplayedSelections] =
          useState("red, blue");

        // Next ID for new colors
        const [nextId, setNextId] = useState(4);

        // Random colors pool
        const randomColors = [
          "purple",
          "orange",
          "yellow",
          "pink",
          "cyan",
          "magenta",
          "lime",
          "indigo",
          "coral",
          "teal",
          "gold",
          "silver",
          "navy",
          "maroon",
        ];

        // Action that takes 1s to update display state
        const updateDisplayAction = async (colors) => {
          await new Promise((resolve) => setTimeout(resolve, 1000));
          setDisplayedSelections(colors.join(", ") || "none");
        };

        // Add a random color choice
        const addRandomColor = () => {
          const availableColors = randomColors.filter(
            (color) => !colorChoices.some((choice) => choice.color === color),
          );
          if (availableColors.length > 0) {
            const randomColor =
              availableColors[
                Math.floor(Math.random() * availableColors.length)
              ];
            setColorChoices((prev) => [
              ...prev,
              { id: nextId, color: randomColor },
            ]);
            setNextId((prev) => prev + 1);
          }
        };

        // Remove a color choice
        const removeColor = (colorId) => {
          const colorToRemove = colorChoices.find(
            (choice) => choice.id === colorId,
          );
          if (colorToRemove) {
            // Remove from choices
            setColorChoices((prev) =>
              prev.filter((choice) => choice.id !== colorId),
            );
            // Remove from selected if it was selected
            setSelectedColors((prev) =>
              prev.filter((color) => color !== colorToRemove.color),
            );
          }
        };

        // Programmatically select a checkbox
        const selectColor = (color) => {
          setSelectedColors((prev) => {
            if (!prev.includes(color)) {
              return [...prev, color];
            }
            return prev;
          });
        };

        // Programmatically uncheck a checkbox
        const unselectColor = (color) => {
          setSelectedColors((prev) => prev.filter((c) => c !== color));
        };

        return (
          <div style="border: 2px solid #ddd; padding: 20px; border-radius: 8px; background: #f9f9f9;">
            <h2>Dynamic Checkbox List Demo</h2>
            <p>
              <strong>Current displayed selections:</strong>{" "}
              {displayedSelections}
            </p>

            <div style="margin: 20px 0;">
              <button
                onClick={addRandomColor}
                style="padding: 8px 16px; margin-right: 10px; background: #4CAF50; color: white; border: none; border-radius: 4px; cursor: pointer;"
              >
                Add Random Color
              </button>
            </div>

            <Form action={updateDisplayAction}>
              <DynamicCheckboxList
                name="dynamic-colors"
                value={selectedColors}
                colorChoices={colorChoices}
                onRemoveColor={removeColor}
                onSelectColor={selectColor}
                onUnselectColor={unselectColor}
              />

              <div style="margin-top: 20px; display: flex; gap: 10px;">
                <Button type="submit">Submit Selection</Button>
                <Button type="reset">Reset Form</Button>
              </div>
            </Form>
          </div>
        );
      };

      // eslint-disable-next-line no-unused-vars
      const DynamicCheckboxList = ({
        name,
        value = [],
        colorChoices,
        onRemoveColor,
        onSelectColor,
        onUnselectColor,
        ...rest
      }) => {
        return (
          <fieldset>
            <legend>Dynamic Color Selection:</legend>
            <CheckboxList name={name} {...rest}>
              {colorChoices.map(({ id, color }) => (
                <div
                  key={id}
                  style="display: flex; align-items: center; gap: 10px; margin: 8px 0; padding: 8px; border: 1px solid #eee; border-radius: 4px;"
                >
                  <Label style="flex: 1;">
                    {color.charAt(0).toUpperCase() + color.slice(1)}
                    <Checkbox value={color} checked={value?.includes(color)} />
                  </Label>

                  <div style="display: flex; gap: 5px;">
                    <button
                      type="button"
                      onClick={() => onSelectColor(color)}
                      disabled={value?.includes(color)}
                      style={{
                        padding: "4px 8px",
                        fontSize: "12px",
                        background: value?.includes(color) ? "#ccc" : "#2196F3",
                        color: "white",
                        border: "none",
                        borderRadius: "3px",
                        cursor: value?.includes(color)
                          ? "not-allowed"
                          : "pointer",
                      }}
                      title="Select this checkbox programmatically"
                    >
                      âœ“
                    </button>

                    <button
                      type="button"
                      onClick={() => onUnselectColor(color)}
                      disabled={!value?.includes(color)}
                      style={{
                        padding: "4px 8px",
                        fontSize: "12px",
                        background: !value?.includes(color)
                          ? "#ccc"
                          : "#FF5722",
                        color: "white",
                        border: "none",
                        borderRadius: "3px",
                        cursor: !value?.includes(color)
                          ? "not-allowed"
                          : "pointer",
                      }}
                      title="Uncheck this checkbox programmatically"
                    >
                      âŠŸ
                    </button>

                    <button
                      type="button"
                      onClick={() => onRemoveColor(id)}
                      style={{
                        padding: "4px 8px",
                        fontSize: "12px",
                        background: "#f44336",
                        color: "white",
                        border: "none",
                        borderRadius: "3px",
                        cursor: "pointer",
                      }}
                      title="Remove this color choice"
                    >
                      ðŸ—‘
                    </button>
                  </div>
                </div>
              ))}
            </CheckboxList>
          </fieldset>
        );
      };

      // eslint-disable-next-line no-unused-vars
      const ActionLogAfter1s = () => {
        const [value, setValue] = useState(["red", "blue"]);

        return (
          <div>
            <p>
              <strong>Action + log after 1s</strong>
            </p>
            <PickFavoriteColors
              name="colors"
              value={value}
              action={async (colors) => {
                await new Promise((resolve) => setTimeout(resolve, 1_000));
                console.log(`Colors selected: ${JSON.stringify(colors)}`);
                setValue(colors);
              }}
            />
          </div>
        );
      };

      // eslint-disable-next-line no-unused-vars
      const ActionThrowAfter1s = () => {
        const [value] = useState(["blue"]);

        return (
          <div>
            <p>
              <strong>Action + throw after 1s</strong>
            </p>
            <PickFavoriteColors
              name="colors"
              value={value}
              action={async (colors) => {
                await new Promise((resolve) => setTimeout(resolve, 1_000));
                throw new Error(`Colors selected: ${JSON.stringify(colors)}`);
                // setValue(colors);
              }}
            />
          </div>
        );
      };

      // eslint-disable-next-line no-unused-vars
      const FormAlertAfter1s = () => {
        const [value, setValue] = useState(["blue"]);

        return (
          <div>
            <p>
              <strong>Form + alert after 1s</strong>
            </p>
            <Form
              action={async ({ colors }) => {
                await new Promise((resolve) => setTimeout(resolve, 1_000));
                // eslint-disable-next-line no-alert
                window.alert(`Colors selected: ${JSON.stringify(colors)}`);
                setValue(colors);
              }}
            >
              <PickFavoriteColors
                id="form_alert_1"
                name="colors"
                value={value}
              />

              <Button type="submit">Submit</Button>
              <Button type="reset">Reset</Button>
            </Form>
          </div>
        );
      };
      // eslint-disable-next-line no-unused-vars
      const FormThrowAfter1s = () => {
        const [value] = useState(["red", "blue"]);
        return (
          <div>
            <p>
              <strong>Form + throw after 1s</strong>
            </p>
            <Form
              action={async ({ colors }) => {
                await new Promise((resolve) => setTimeout(resolve, 1_000));
                throw new Error(`Colors selected: ${JSON.stringify(colors)}`);
                // setValue(colors);
              }}
            >
              <PickFavoriteColors name="colors" value={value} />
              <Button type="submit">Submit</Button>
              <Button type="reset">Reset</Button>
            </Form>
          </div>
        );
      };

      // eslint-disable-next-line no-unused-vars
      const PickFavoriteColors = ({ name, value = [], ...rest }) => {
        return (
          <fieldset>
            <legend>Select your favorite colors:</legend>
            <CheckboxList name={name} {...rest}>
              <Label>
                Red
                <Checkbox value="red" checked={value?.includes("red")} />
              </Label>
              <Label>
                Blue
                <Checkbox value="blue" checked={value?.includes("blue")} />
              </Label>
              <Label>
                Green
                <Checkbox value="green" checked={value?.includes("green")} />
              </Label>
            </CheckboxList>
          </fieldset>
        );
      };

      render(<App />, document.querySelector("#root"));
    </script>
  </body>
</html>
