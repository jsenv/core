<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <link rel="icon" href="data:," />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Checkbox list demo</title>
  </head>
  <body>
    <div id="root" style="position: relative"></div>

    <script type="module" jsenv-type="module/jsx">
      import { render } from "preact";
      import { useState } from "preact/hooks";
      import {
        // eslint-disable-next-line no-unused-vars
        Button,
        // eslint-disable-next-line no-unused-vars
        Form,
        // eslint-disable-next-line no-unused-vars
        CheckboxList,
        // eslint-disable-next-line no-unused-vars
        Label,
        // eslint-disable-next-line no-unused-vars
        Checkbox,
      } from "@jsenv/navi";

      // eslint-disable-next-line no-unused-vars
      const App = () => {
        return (
          <div style="display: flex; flex-direction: column; gap: 40px">
            <DynamicCheckboxListDemo />
            <div style="display: flex; flex-direction: row; gap: 30px"></div>
          </div>
        );
      };

      // eslint-disable-next-line no-unused-vars
      const DynamicCheckboxListDemo = () => {
        // Available color choices
        const [colorChoices, setColorChoices] = useState([
          { id: 1, color: "red" },
          { id: 2, color: "blue" },
          { id: 3, color: "green" },
        ]);

        // BACKEND STATE - This represents the server/database state
        const [backendSelectedColors, setBackendSelectedColors] = useState([
          "red",
          "blue",
        ]);

        // UI STATE - This represents the current form state (may differ from backend)
        const [uiSelectedColors, setUiSelectedColors] = useState([
          "red",
          "blue",
        ]);

        // Next ID for new colors
        const [nextId, setNextId] = useState(4);

        // Random colors pool
        const randomColors = [
          "purple",
          "orange",
          "yellow",
          "pink",
          "cyan",
          "magenta",
          "lime",
          "indigo",
          "coral",
          "teal",
          "gold",
          "silver",
          "navy",
          "maroon",
        ];

        // Action that simulates sending data to backend (takes 1s)
        const submitToBackend = async ({ colors }) => {
          console.log("Submitting to backend:", colors);
          await new Promise((resolve) => setTimeout(resolve, 1000));
          // Simulate backend accepting the data and updating backend state
          setBackendSelectedColors(colors || []);
          console.log("Backend state updated:", colors);
        };

        // Simulate backend state changes (these would come from server events, websockets, etc.)
        const simulateBackendChange = (newBackendState) => {
          console.log("Backend state changed externally:", newBackendState);
          setBackendSelectedColors(newBackendState);
          // When backend changes, we typically sync the UI to match
          setUiSelectedColors(newBackendState);
        };

        // Sync UI state to backend state (like a refresh or reset)
        const syncUiToBackend = () => {
          setUiSelectedColors([...backendSelectedColors]);
        };

        // Add a random color choice
        const addRandomColor = () => {
          const availableColors = randomColors.filter(
            (color) => !colorChoices.some((choice) => choice.color === color),
          );
          if (availableColors.length > 0) {
            const randomColor =
              availableColors[
                Math.floor(Math.random() * availableColors.length)
              ];
            setColorChoices((prev) => [
              ...prev,
              { id: nextId, color: randomColor },
            ]);
            setNextId((prev) => prev + 1);
          }
        };

        // Remove a color choice
        const removeColor = (colorId) => {
          const colorToRemove = colorChoices.find(
            (choice) => choice.id === colorId,
          );
          if (colorToRemove) {
            // Remove from choices
            setColorChoices((prev) =>
              prev.filter((choice) => choice.id !== colorId),
            );
            // Remove from UI selected if it was selected
            setUiSelectedColors((prev) =>
              prev.filter((color) => color !== colorToRemove.color),
            );
            // Also remove from backend state if it was there
            setBackendSelectedColors((prev) =>
              prev.filter((color) => color !== colorToRemove.color),
            );
          }
        };

        // Programmatically select a checkbox (modifies UI state)
        const selectColor = (color) => {
          setUiSelectedColors((prev) => {
            if (!prev.includes(color)) {
              return [...prev, color];
            }
            return prev;
          });
        };

        // Programmatically uncheck a checkbox (modifies UI state)
        const unselectColor = (color) => {
          setUiSelectedColors((prev) => prev.filter((c) => c !== color));
        };

        return (
          <div style="border: 2px solid #ddd; padding: 20px; border-radius: 8px; background: #f9f9f9;">
            <h2>Backend ‚Üî UI State Synchronization Demo</h2>

            <div style="display: flex; gap: 20px; margin: 20px 0; padding: 15px; background: #fff; border-radius: 6px; border: 1px solid #ccc;">
              <div style="flex: 1;">
                <h3 style="margin: 0 0 10px 0; color: #2196F3;">
                  üóÑÔ∏è Backend State
                </h3>
                <p style="margin: 0; font-family: monospace; background: #e3f2fd; padding: 8px; border-radius: 4px;">
                  {backendSelectedColors.length
                    ? backendSelectedColors.join(", ")
                    : "none"}
                </p>
                <small style="color: #666;">
                  This represents the server/database state
                </small>
              </div>

              <div style="flex: 1;">
                <h3 style="margin: 0 0 10px 0; color: #FF9800;">üìù UI State</h3>
                <p style="margin: 0; font-family: monospace; background: #fff3e0; padding: 8px; border-radius: 4px;">
                  {uiSelectedColors.length
                    ? uiSelectedColors.join(", ")
                    : "none"}
                </p>
                <small style="color: #666;">
                  This represents the current form state
                </small>
              </div>
            </div>

            <div style="background: #f0f8ff; padding: 15px; border-radius: 6px; margin: 20px 0; border-left: 4px solid #2196F3;">
              <h4 style="margin: 0 0 10px 0;">How it works:</h4>
              <ul style="margin: 0; padding-left: 20px; font-size: 14px;">
                <li>
                  The checkboxes show the <strong>UI state</strong> (what user
                  is editing)
                </li>
                <li>
                  Clicking checkboxes or programmatic buttons modifies{" "}
                  <strong>UI state only</strong>
                </li>
                <li>
                  "Submit" sends UI state to backend (1s delay) and updates{" "}
                  <strong>backend state</strong>
                </li>
                <li>"Reset" syncs UI state back to current backend state</li>
                <li>
                  "Simulate Backend Change" buttons simulate external backend
                  updates
                </li>
              </ul>
            </div>

            <div style="margin: 20px 0;">
              <h4>üõ†Ô∏è Controls:</h4>
              <div style="display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 15px;">
                <button
                  onClick={addRandomColor}
                  style="padding: 8px 16px; background: #4CAF50; color: white; border: none; border-radius: 4px; cursor: pointer;"
                >
                  Add Random Color
                </button>

                <button
                  onClick={syncUiToBackend}
                  style="padding: 8px 16px; background: #2196F3; color: white; border: none; border-radius: 4px; cursor: pointer;"
                >
                  Sync UI ‚Üê Backend
                </button>
              </div>

              <div style="margin: 10px 0;">
                <strong>Simulate Backend Changes:</strong>
                <div style="display: flex; gap: 8px; flex-wrap: wrap; margin-top: 8px;">
                  <button
                    onClick={() => simulateBackendChange(["red"])}
                    style="padding: 6px 12px; background: #9C27B0; color: white; border: none; border-radius: 3px; cursor: pointer; font-size: 12px;"
                  >
                    Backend ‚Üí [red]
                  </button>
                  <button
                    onClick={() => simulateBackendChange(["blue", "green"])}
                    style="padding: 6px 12px; background: #9C27B0; color: white; border: none; border-radius: 3px; cursor: pointer; font-size: 12px;"
                  >
                    Backend ‚Üí [blue, green]
                  </button>
                  <button
                    onClick={() => simulateBackendChange([])}
                    style="padding: 6px 12px; background: #9C27B0; color: white; border: none; border-radius: 3px; cursor: pointer; font-size: 12px;"
                  >
                    Backend ‚Üí [none]
                  </button>
                </div>
              </div>
            </div>

            <Form action={submitToBackend}>
              <fieldset>
                <legend>Dynamic Color Selection:</legend>
                <CheckboxList name="colors">
                  {colorChoices.map(({ id, color }) => (
                    <div
                      key={id}
                      style="display: flex; align-items: center; gap: 10px; margin: 8px 0; padding: 8px; border: 1px solid #eee; border-radius: 4px;"
                    >
                      <Label style="flex: 1;">
                        {color.charAt(0).toUpperCase() + color.slice(1)}
                        <Checkbox
                          value={color}
                          checked={uiSelectedColors.includes(color)}
                        />
                      </Label>

                      <div style="display: flex; gap: 5px;">
                        <button
                          type="button"
                          onClick={() => selectColor(color)}
                          disabled={uiSelectedColors.includes(color)}
                          style={{
                            padding: "4px 8px",
                            fontSize: "12px",
                            background: uiSelectedColors.includes(color)
                              ? "#ccc"
                              : "#2196F3",
                            color: "white",
                            border: "none",
                            borderRadius: "3px",
                            cursor: uiSelectedColors.includes(color)
                              ? "not-allowed"
                              : "pointer",
                          }}
                          title="Select this checkbox programmatically"
                        >
                          ‚úì
                        </button>

                        <button
                          type="button"
                          onClick={() => unselectColor(color)}
                          disabled={!uiSelectedColors.includes(color)}
                          style={{
                            padding: "4px 8px",
                            fontSize: "12px",
                            background: !uiSelectedColors.includes(color)
                              ? "#ccc"
                              : "#FF5722",
                            color: "white",
                            border: "none",
                            borderRadius: "3px",
                            cursor: !uiSelectedColors.includes(color)
                              ? "not-allowed"
                              : "pointer",
                          }}
                          title="Uncheck this checkbox programmatically"
                        >
                          ‚äü
                        </button>

                        <button
                          type="button"
                          onClick={() => removeColor(id)}
                          style={{
                            padding: "4px 8px",
                            fontSize: "12px",
                            background: "#f44336",
                            color: "white",
                            border: "none",
                            borderRadius: "3px",
                            cursor: "pointer",
                          }}
                          title="Remove this color choice"
                        >
                          üóë
                        </button>
                      </div>
                    </div>
                  ))}
                </CheckboxList>
              </fieldset>

              <div style="margin-top: 20px; display: flex; gap: 10px;">
                <Button type="submit">Submit Selection</Button>
                <Button type="reset">Reset Form</Button>
              </div>
            </Form>
          </div>
        );
      };

      // eslint-disable-next-line no-unused-vars
      const ActionLogAfter1s = () => {
        const [value, setValue] = useState(["red", "blue"]);

        return (
          <div>
            <p>
              <strong>Action + log after 1s</strong>
            </p>
            <PickFavoriteColors
              name="colors"
              value={value}
              action={async (colors) => {
                await new Promise((resolve) => setTimeout(resolve, 1_000));
                console.log(`Colors selected: ${JSON.stringify(colors)}`);
                setValue(colors);
              }}
            />
          </div>
        );
      };

      // eslint-disable-next-line no-unused-vars
      const ActionThrowAfter1s = () => {
        const [value] = useState(["blue"]);

        return (
          <div>
            <p>
              <strong>Action + throw after 1s</strong>
            </p>
            <PickFavoriteColors
              name="colors"
              value={value}
              action={async (colors) => {
                await new Promise((resolve) => setTimeout(resolve, 1_000));
                throw new Error(`Colors selected: ${JSON.stringify(colors)}`);
                // setValue(colors);
              }}
            />
          </div>
        );
      };

      // eslint-disable-next-line no-unused-vars
      const FormAlertAfter1s = () => {
        const [value, setValue] = useState(["blue"]);

        return (
          <div>
            <p>
              <strong>Form + alert after 1s</strong>
            </p>
            <Form
              action={async ({ colors }) => {
                await new Promise((resolve) => setTimeout(resolve, 1_000));
                // eslint-disable-next-line no-alert
                window.alert(`Colors selected: ${JSON.stringify(colors)}`);
                setValue(colors);
              }}
            >
              <PickFavoriteColors
                id="form_alert_1"
                name="colors"
                value={value}
              />

              <Button type="submit">Submit</Button>
              <Button type="reset">Reset</Button>
            </Form>
          </div>
        );
      };
      // eslint-disable-next-line no-unused-vars
      const FormThrowAfter1s = () => {
        const [value] = useState(["red", "blue"]);
        return (
          <div>
            <p>
              <strong>Form + throw after 1s</strong>
            </p>
            <Form
              action={async ({ colors }) => {
                await new Promise((resolve) => setTimeout(resolve, 1_000));
                throw new Error(`Colors selected: ${JSON.stringify(colors)}`);
                // setValue(colors);
              }}
            >
              <PickFavoriteColors name="colors" value={value} />
              <Button type="submit">Submit</Button>
              <Button type="reset">Reset</Button>
            </Form>
          </div>
        );
      };

      // eslint-disable-next-line no-unused-vars
      const PickFavoriteColors = ({ name, value = [], ...rest }) => {
        return (
          <fieldset>
            <legend>Select your favorite colors:</legend>
            <CheckboxList name={name} {...rest}>
              <Label>
                Red
                <Checkbox value="red" checked={value?.includes("red")} />
              </Label>
              <Label>
                Blue
                <Checkbox value="blue" checked={value?.includes("blue")} />
              </Label>
              <Label>
                Green
                <Checkbox value="green" checked={value?.includes("green")} />
              </Label>
            </CheckboxList>
          </fieldset>
        );
      };

      render(<App />, document.querySelector("#root"));
    </script>
  </body>
</html>
