<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Item Tracker Debug</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 20px;
        background: #f5f5f5;
      }
      .debug-panel {
        background: white;
        padding: 20px;
        margin: 10px 0;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }
      .item-data {
        background: #e3f2fd;
        padding: 15px;
        margin: 10px 0;
        border-radius: 4px;
        border-left: 4px solid #2196f3;
        display: flex;
        align-items: center;
        justify-content: space-between;
      }
      .item-info {
        flex: 1;
      }
      .item-controls {
        display: flex;
        gap: 8px;
        align-items: center;
      }
      .item-consumer {
        background: #f3e5f5;
        padding: 10px;
        margin: 5px 0;
        border-radius: 4px;
        border-left: 4px solid #9c27b0;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
      button {
        background: #4caf50;
        color: white;
        border: none;
        padding: 8px 16px;
        border-radius: 4px;
        cursor: pointer;
        margin: 2px;
        font-size: 12px;
      }
      button:hover {
        background: #45a049;
      }
      button.remove {
        background: #f44336;
      }
      button.remove:hover {
        background: #d32f2f;
      }
      button.add {
        background: #2196f3;
      }
      button.add:hover {
        background: #1976d2;
      }
      button.rerender {
        background: #ff9800;
      }
      button.rerender:hover {
        background: #f57c00;
      }
      select {
        padding: 4px 8px;
        border: 1px solid #ddd;
        border-radius: 4px;
        margin: 0 8px;
      }
      .log {
        background: #1e1e1e;
        color: #00ff00;
        padding: 10px;
        border-radius: 4px;
        font-family: monospace;
        max-height: 200px;
        overflow-y: auto;
        white-space: pre-wrap;
      }
      .section {
        margin: 20px 0;
      }
    </style>
  </head>
  <body>
    <h1>Item Tracker Debug</h1>

    <div class="debug-panel">
      <h2>Logs</h2>
      <div id="logs" class="log"></div>
      <button onclick="document.getElementById('logs').textContent = ''">
        Clear Logs
      </button>
    </div>

    <div class="debug-panel">
      <h2>App</h2>
      <div id="app"></div>
    </div>

    <script type="module" jsenv-type="module/jsx">
      import { render } from "preact";
      import { useState } from "preact/hooks";
      import {
        // eslint-disable-next-line no-unused-vars
        ItemTrackerProvider,
        useItemTracker,
        useTrackItem,
        useTrackedItem,
        useTrackedItems,
      } from "./use_item_tracker.jsx";

      // Debug logging
      const log = (message) => {
        const timestamp = new Date().toLocaleTimeString();
        const logElement = document.getElementById("logs");
        logElement.textContent += `[${timestamp}] ${message}\n`;
        logElement.scrollTop = logElement.scrollHeight;
        console.log(message);
      };

      // Hidden item that only tracks data, doesn't render anything visible
      // eslint-disable-next-line no-unused-vars
      const HiddenItem = ({ id, name, color }) => {
        useTrackItem({ id, name, color });
        return null; // Render nothing
      };

      // Item data display with controls
      // eslint-disable-next-line no-unused-vars
      const ItemData = ({ item, index, onUpdate, onRemove, onAddAfter }) => {
        const colors = ["red", "blue", "green", "purple", "orange", "pink"];

        return (
          <div className="item-data">
            <div className="item-info">
              <strong>Item {index}:</strong> id={item.id}, name={item.name},
              color={item.color}
            </div>
            <div className="item-controls">
              <select
                value={item.color}
                onChange={(e) =>
                  onUpdate(index, { ...item, color: e.target.value })
                }
              >
                {colors.map((color) => (
                  <option key={color} value={color}>
                    {color}
                  </option>
                ))}
              </select>
              <button className="add" onClick={() => onAddAfter(index)}>
                Add After
              </button>
              <button className="remove" onClick={() => onRemove(index)}>
                Remove
              </button>
            </div>
          </div>
        );
      };

      // Item consumer with re-render button
      // eslint-disable-next-line no-unused-vars
      const ItemConsumer = ({ itemIndex }) => {
        const [renderKey, setRenderKey] = useState(0);
        const itemData = useTrackedItem(itemIndex);
        log(`üëÅÔ∏è Consumer ${itemIndex} render #${renderKey}`);

        return (
          <div className="item-consumer">
            <div>
              <strong>Consumer for index {itemIndex}:</strong>
              <span>{itemData ? JSON.stringify(itemData) : "undefined"}</span>
              <small> (render #{renderKey})</small>
            </div>
            <button
              className="rerender"
              onClick={() => {
                log(`üîÑ Re-rendering consumer ${itemIndex}`);
                setRenderKey((prev) => prev + 1);
              }}
            >
              Re-render
            </button>
          </div>
        );
      };

      // Values display
      // eslint-disable-next-line no-unused-vars
      const ValuesDisplay = () => {
        const items = useTrackedItems();
        return (
          <div
            style={{
              background: "#fff3e0",
              padding: "10px",
              borderRadius: "4px",
            }}
          >
            <strong>All Tracked Items:</strong>
            <pre>{JSON.stringify(items, null, 2)}</pre>
          </div>
        );
      };

      // Initial state
      const initialState = {
        renderKey: 0,
        items: [
          { id: "a", name: "First", color: "red" },
          { id: "b", name: "Second", color: "blue" },
        ],
      };

      // eslint-disable-next-line no-unused-vars
      const AppWrapper = () => {
        const [state, setState] = useState(initialState);
        const itemTracker = useItemTracker();

        log(`üé¨ App render ${state.renderKey}`);

        const handleUpdateItem = (index, newItem) => {
          setState((prev) => {
            const newItems = [...prev.items];
            newItems[index] = newItem;
            log(`üîÑ Updated item ${index}: ${JSON.stringify(newItem)}`);
            return { ...prev, items: newItems };
          });
        };

        const handleRemoveItem = (index) => {
          setState((prev) => {
            const newItems = prev.items.filter((_, i) => i !== index);
            log(`‚ûñ Removed item ${index}`);
            return { ...prev, items: newItems };
          });
        };

        const handleAddAfter = (index) => {
          setState((prev) => {
            const newId = String.fromCharCode(97 + prev.items.length);
            const newItem = {
              id: newId,
              name: `Item ${newId.toUpperCase()}`,
              color: "green",
            };
            const newItems = [
              ...prev.items.slice(0, index + 1),
              newItem,
              ...prev.items.slice(index + 1),
            ];
            log(`‚ûï Added item after ${index}: ${JSON.stringify(newItem)}`);
            return { ...prev, items: newItems };
          });
        };

        return (
          <div>
            <div style={{ marginBottom: "20px" }}>
              <strong>App Render #{state.renderKey}</strong>
              <button
                style={{ marginLeft: "10px" }}
                onClick={() => {
                  log("üîÑ Manual app re-render triggered");
                  setState((prev) => ({
                    ...prev,
                    renderKey: prev.renderKey + 1,
                  }));
                }}
              >
                Re-render App
              </button>
            </div>

            <ItemTrackerProvider value={itemTracker}>
              <div className="section">
                <h3>Item Data Controls</h3>
                {state.items.map((item, index) => (
                  <ItemData
                    key={`${item.id}-${state.renderKey}`}
                    item={item}
                    index={index}
                    onUpdate={handleUpdateItem}
                    onRemove={handleRemoveItem}
                    onAddAfter={handleAddAfter}
                  />
                ))}
              </div>

              <HiddenItemTracker state={state} itemTracker={itemTracker} />

              <div className="section">
                <h3>Item Consumers</h3>
                <ItemConsumer itemIndex={0} />
                <ItemConsumer itemIndex={1} />
                <ItemConsumer itemIndex={2} />
                <ItemConsumer itemIndex={3} />
              </div>

              <div className="section">
                <ValuesDisplay />
              </div>
            </ItemTrackerProvider>
          </div>
        );
      };

      // Component that renders hidden tracking items
      // eslint-disable-next-line no-unused-vars
      const HiddenItemTracker = ({ state, itemTracker }) => {
        // eslint-disable-next-line no-unused-vars
        const TrackItemProvider = itemTracker.useTrackItemProvider();

        return (
          <TrackItemProvider>
            {state.items.map((item) => (
              <HiddenItem
                key={`${item.id}-${state.renderKey}`}
                id={item.id}
                name={item.name}
                color={item.color}
              />
            ))}
          </TrackItemProvider>
        );
      };

      // Initial render
      render(<AppWrapper />, document.getElementById("app"));
      log("üöÄ App initialized");
    </script>
  </body>
</html>
