<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Child Tracker Debug</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 20px;
        background: #f5f5f5;
      }
      .debug-panel {
        background: white;
        padding: 20px;
        margin: 10px 0;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }
      .child-item {
        background: #e3f2fd;
        padding: 10px;
        margin: 5px 0;
        border-radius: 4px;
        border-left: 4px solid #2196f3;
      }
      .child-consumer {
        background: #f3e5f5;
        padding: 10px;
        margin: 5px 0;
        border-radius: 4px;
        border-left: 4px solid #9c27b0;
      }
      button {
        background: #4caf50;
        color: white;
        border: none;
        padding: 8px 16px;
        border-radius: 4px;
        cursor: pointer;
        margin: 5px;
      }
      button:hover {
        background: #45a049;
      }
      .log {
        background: #1e1e1e;
        color: #00ff00;
        padding: 10px;
        border-radius: 4px;
        font-family: monospace;
        max-height: 200px;
        overflow-y: auto;
        white-space: pre-wrap;
      }
      .controls {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        margin: 10px 0;
      }
      .input-group {
        display: flex;
        align-items: center;
        gap: 8px;
      }
      input[type="text"],
      input[type="number"] {
        padding: 4px 8px;
        border: 1px solid #ddd;
        border-radius: 4px;
      }
    </style>
  </head>
  <body>
    <h1>Child Tracker Debug</h1>

    <div class="debug-panel">
      <h2>Controls</h2>
      <div class="controls">
        <button id="rerender-parent">Re-render Parent</button>
        <button id="add-child">Add Child</button>
        <button id="remove-child">Remove Child</button>
        <div class="input-group">
          <label>Child Index:</label>
          <input type="number" id="child-index" value="0" min="0" />
        </div>
        <div class="input-group">
          <label>New Value:</label>
          <input type="text" id="child-value" value="updated value" />
        </div>
        <button id="update-child">Update Child Value</button>
      </div>
    </div>

    <div class="debug-panel">
      <h2>Logs</h2>
      <div id="logs" class="log"></div>
      <button onclick="document.getElementById('logs').textContent = ''">
        Clear Logs
      </button>
    </div>

    <div class="debug-panel">
      <h2>App</h2>
      <div id="app"></div>
    </div>

    <script type="module" jsenv-type="module/jsx">
      import { render } from "preact";
      import { useState } from "preact/hooks";
      import { createChildTracker } from "./use_child_tracker.jsx";

      // Debug logging
      const log = (message) => {
        const timestamp = new Date().toLocaleTimeString();
        const logElement = document.getElementById("logs");
        logElement.textContent += `[${timestamp}] ${message}\n`;
        logElement.scrollTop = logElement.scrollHeight;
        console.log(message);
      };

      // Create tracker instance
      const {
        useValues,
        useChildTrackerProvider,
        useTrackChildProvider,
        useTrackChild,
        useTrackedChild,
      } = createChildTracker();

      // Demo components
      const Child = ({ id, name, color }) => {
        const childIndex = useTrackChild({ id, name, color });

        return (
          <div className="child-item">
            <strong>Child {childIndex}: </strong>
            <span>
              id={id}, name={name}, color={color}
            </span>
          </div>
        );
      };

      const ChildConsumer = ({ childIndex }) => {
        const childData = useTrackedChild(childIndex);

        return (
          <div className="child-consumer">
            <strong>Consumer for index {childIndex}: </strong>
            <span>{childData ? JSON.stringify(childData) : "undefined"}</span>
          </div>
        );
      };

      const ValuesDisplay = () => {
        const values = useValues();

        return (
          <div
            style={{
              background: "#fff3e0",
              padding: "10px",
              borderRadius: "4px",
            }}
          >
            <strong>All Values: </strong>
            <pre>{JSON.stringify(values, null, 2)}</pre>
          </div>
        );
      };

      // Global app state
      let globalState = {
        renderKey: 0,
        children: [
          { id: "a", name: "First", color: "red" },
          { id: "b", name: "Second", color: "blue" },
        ],
      };

      let setGlobalState;

      const AppWrapper = () => {
        const [state, setState] = useState(globalState);
        setGlobalState = setState;

        const ColumnsTrackerProvider = useChildTrackerProvider();
        const TrackChildProvider = useTrackChildProvider();

        log(`ðŸŽ¬ App render ${state.renderKey}`);

        return (
          <div>
            <div style={{ marginBottom: "20px" }}>
              <strong>Render #{state.renderKey}</strong>
            </div>

            <ColumnsTrackerProvider>
              <TrackChildProvider>
                <ValuesDisplay />
                <div style={{ margin: "20px 0" }}>
                  <h3>Children:</h3>
                  {state.children.map((child) => (
                    <Child
                      key={`${child.id}-${state.renderKey}`}
                      id={child.id}
                      name={child.name}
                      color={child.color}
                    />
                  ))}
                </div>
                <div style={{ margin: "20px 0" }}>
                  <h3>Consumers:</h3>
                  <ChildConsumer childIndex={0} />
                  <ChildConsumer childIndex={1} />
                  <ChildConsumer childIndex={2} />
                </div>
              </TrackChildProvider>
            </ColumnsTrackerProvider>
          </div>
        );
      };

      // Event handlers
      document.getElementById("rerender-parent").onclick = () => {
        log("ðŸ”„ Manual parent re-render triggered");
        globalState = { ...globalState, renderKey: globalState.renderKey + 1 };
        setGlobalState(globalState);
      };

      document.getElementById("add-child").onclick = () => {
        const newId = String.fromCharCode(97 + globalState.children.length);
        const newChild = {
          id: newId,
          name: `Child ${newId.toUpperCase()}`,
          color: ["green", "purple", "orange", "pink"][
            globalState.children.length % 4
          ],
        };
        globalState = {
          ...globalState,
          children: [...globalState.children, newChild],
        };
        setGlobalState(globalState);
        log(`âž• Added child: ${JSON.stringify(newChild)}`);
      };

      document.getElementById("remove-child").onclick = () => {
        if (globalState.children.length > 0) {
          const removed = globalState.children[globalState.children.length - 1];
          globalState = {
            ...globalState,
            children: globalState.children.slice(0, -1),
          };
          setGlobalState(globalState);
          log(`âž– Removed child: ${JSON.stringify(removed)}`);
        }
      };

      document.getElementById("update-child").onclick = () => {
        const index = parseInt(document.getElementById("child-index").value);
        const newValue = document.getElementById("child-value").value;

        if (index >= 0 && index < globalState.children.length) {
          const updatedChildren = [...globalState.children];
          updatedChildren[index] = {
            ...updatedChildren[index],
            name: newValue,
          };
          globalState = { ...globalState, children: updatedChildren };
          setGlobalState(globalState);
          log(`ðŸ”„ Updated child ${index} name to: ${newValue}`);
        } else {
          log(
            `âŒ Invalid index ${index} (max: ${globalState.children.length - 1})`,
          );
        }
      };

      // Initial render
      render(<AppWrapper />, document.getElementById("app"));
      log("ðŸš€ App initialized");
    </script>
  </body>
</html>
