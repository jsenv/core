<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Child Tracker Debug</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 20px;
        background: #f5f5f5;
      }
      .debug-panel {
        background: white;
        padding: 20px;
        margin: 10px 0;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }
      .child-item {
        background: #e3f2fd;
        padding: 10px;
        margin: 5px 0;
        border-radius: 4px;
        border-left: 4px solid #2196f3;
      }
      .child-consumer {
        background: #f3e5f5;
        padding: 10px;
        margin: 5px 0;
        border-radius: 4px;
        border-left: 4px solid #9c27b0;
      }
      button {
        background: #4caf50;
        color: white;
        border: none;
        padding: 8px 16px;
        border-radius: 4px;
        cursor: pointer;
        margin: 5px;
      }
      button:hover {
        background: #45a049;
      }
      .log {
        background: #1e1e1e;
        color: #00ff00;
        padding: 10px;
        border-radius: 4px;
        font-family: monospace;
        max-height: 200px;
        overflow-y: auto;
        white-space: pre-wrap;
      }
      .controls {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        margin: 10px 0;
      }
      .input-group {
        display: flex;
        align-items: center;
        gap: 8px;
      }
      input[type="text"],
      input[type="number"] {
        padding: 4px 8px;
        border: 1px solid #ddd;
        border-radius: 4px;
      }
    </style>
  </head>
  <body>
    <h1>Child Tracker Debug</h1>

    <div class="debug-panel">
      <h2>Controls</h2>
      <div class="controls">
        <button id="rerender-parent">Re-render Parent</button>
        <button id="add-child">Add Child</button>
        <button id="remove-child">Remove Child</button>
        <div class="input-group">
          <label>Child Index:</label>
          <input type="number" id="child-index" value="0" min="0" />
        </div>
        <div class="input-group">
          <label>New Value:</label>
          <input type="text" id="child-value" value="updated value" />
        </div>
        <button id="update-child">Update Child Value</button>
      </div>
    </div>

    <div class="debug-panel">
      <h2>Logs</h2>
      <div id="logs" class="log"></div>
      <button onclick="document.getElementById('logs').textContent = ''">
        Clear Logs
      </button>
    </div>

    <div class="debug-panel">
      <h2>App</h2>
      <div id="app"></div>
    </div>

    <script type="module" jsenv-type="module/jsx">
      import { render } from "preact";
      import { useState, useEffect } from "preact/hooks";
      import { createChildTracker } from "./use_child_tracker.jsx";

      // Debug logging
      const log = (message) => {
        const timestamp = new Date().toLocaleTimeString();
        const logElement = document.getElementById("logs");
        logElement.textContent += `[${timestamp}] ${message}\n`;
        logElement.scrollTop = logElement.scrollHeight;
        console.log(message);
      };

      // Create tracker instance
      const {
        useValues,
        useChildTrackerProvider,
        useTrackChildProvider,
        useTrackChild,
        useTrackedChild,
        // eslint-disable-next-line no-unused-vars
        ChildTrackerValuesContext,
      } = createChildTracker();

      // Demo components
      // eslint-disable-next-line no-unused-vars
      const Child = ({ id, name, color }) => {
        const childIndex = useTrackChild({ id, name, color });

        return (
          <div className="child-item">
            <strong>Child {childIndex}: </strong>
            <span>
              id={id}, name={name}, color={color}
            </span>
          </div>
        );
      };

      // eslint-disable-next-line no-unused-vars
      const ChildConsumer = ({ childIndex }) => {
        const childData = useTrackedChild(childIndex);

        return (
          <div className="child-consumer">
            <strong>Consumer for index {childIndex}: </strong>
            <span>{childData ? JSON.stringify(childData) : "undefined"}</span>
          </div>
        );
      };

      // eslint-disable-next-line no-unused-vars
      const ValuesDisplay = () => {
        const values = useValues();

        return (
          <div
            style={{
              background: "#fff3e0",
              padding: "10px",
              borderRadius: "4px",
            }}
          >
            <strong>All Values: </strong>
            <pre>{JSON.stringify(values, null, 2)}</pre>
          </div>
        );
      };

      // Initial state
      const initialState = {
        renderKey: 0,
        children: [
          { id: "a", name: "First", color: "red" },
          { id: "b", name: "Second", color: "blue" },
        ],
      };

      // eslint-disable-next-line no-unused-vars
      const AppWrapper = () => {
        const [state, setState] = useState(initialState);

        // eslint-disable-next-line no-unused-vars
        const [values, ChildTrackerProvider] = useChildTrackerProvider();

        log(`ðŸŽ¬ App render ${state.renderKey}`);

        // Setup event handlers once
        useEffect(() => {
          const handleRerender = () => {
            log("ðŸ”„ Manual parent re-render triggered");
            setState((prev) => ({ ...prev, renderKey: prev.renderKey + 1 }));
          };

          const handleAddChild = () => {
            setState((prev) => {
              const newId = String.fromCharCode(97 + prev.children.length);
              const newChild = {
                id: newId,
                name: `Child ${newId.toUpperCase()}`,
                color: ["green", "purple", "orange", "pink"][
                  prev.children.length % 4
                ],
              };
              log(`âž• Added child: ${JSON.stringify(newChild)}`);
              return {
                ...prev,
                children: [...prev.children, newChild],
              };
            });
          };

          const handleRemoveChild = () => {
            setState((prev) => {
              if (prev.children.length > 0) {
                const removed = prev.children[prev.children.length - 1];
                log(`âž– Removed child: ${JSON.stringify(removed)}`);
                return {
                  ...prev,
                  children: prev.children.slice(0, -1),
                };
              }
              return prev;
            });
          };

          const handleUpdateChild = () => {
            const index = parseInt(
              document.getElementById("child-index").value,
            );
            const newValue = document.getElementById("child-value").value;

            setState((prev) => {
              if (index >= 0 && index < prev.children.length) {
                const updatedChildren = [...prev.children];
                updatedChildren[index] = {
                  ...updatedChildren[index],
                  name: newValue,
                };
                log(`ðŸ”„ Updated child ${index} name to: ${newValue}`);
                return { ...prev, children: updatedChildren };
              }
              log(
                `âŒ Invalid index ${index} (max: ${prev.children.length - 1})`,
              );
              return prev;
            });
          };

          // Attach event listeners
          document.getElementById("rerender-parent").onclick = handleRerender;
          document.getElementById("add-child").onclick = handleAddChild;
          document.getElementById("remove-child").onclick = handleRemoveChild;
          document.getElementById("update-child").onclick = handleUpdateChild;

          // Cleanup
          return () => {
            document.getElementById("rerender-parent").onclick = null;
            document.getElementById("add-child").onclick = null;
            document.getElementById("remove-child").onclick = null;
            document.getElementById("update-child").onclick = null;
          };
        }, []);

        return (
          <div>
            <div style={{ marginBottom: "20px" }}>
              <strong>Render #{state.renderKey}</strong>
            </div>

            <ChildTrackerProvider>
              <ChildRenderer state={state} />
              <Intermediate state={state} values={values} />
            </ChildTrackerProvider>
          </div>
        );
      };

      // eslint-disable-next-line no-unused-vars
      const ChildRenderer = ({ state }) => {
        log("Render all child");
        // eslint-disable-next-line no-unused-vars
        const TrackChildProvider = useTrackChildProvider();

        return (
          <TrackChildProvider>
            <div style={{ margin: "20px 0" }}>
              <h3>Children:</h3>
              {state.children.map((child) => (
                <Child
                  key={`${child.id}-${state.renderKey}`}
                  id={child.id}
                  name={child.name}
                  color={child.color}
                />
              ))}
            </div>
          </TrackChildProvider>
        );
      };

      // eslint-disable-next-line no-unused-vars
      const Intermediate = ({ state, values }) => {
        log("render child values display and consumers");
        return (
          <ChildTrackerValuesContext.Provider value={values}>
            <ValuesDisplay />
            <div style={{ margin: "20px 0" }}>
              <h3>Consumers:</h3>
              <ChildConsumer childIndex={0} />
              <ChildConsumer childIndex={1} />
              <ChildConsumer childIndex={2} />
            </div>
          </ChildTrackerValuesContext.Provider>
        );
      };

      // Event handlers are now managed within React components

      // Initial render
      render(<AppWrapper />, document.getElementById("app"));
      log("ðŸš€ App initialized");
    </script>
  </body>
</html>
