<!doctype html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Test Smooth Resize Transition</title>
    <style>
      body {
        margin: 40px;
        font-family: Arial, sans-serif;
        background: #f5f5f5;
      }

      .controls {
        display: flex;
        margin-bottom: 40px;
        gap: 10px;
      }

      button {
        padding: 10px 20px;
        color: white;
        font-size: 14px;
        background: #007acc;
        border: none;
        border-radius: 4px;
        cursor: pointer;
      }

      button:hover {
        background: #005a99;
      }

      button.active {
        background: #ff6b35;
      }

      /* État désactivé pendant les transitions */
      button:disabled {
        color: #999;
        background: #ccc;
        opacity: 0.6;
        cursor: not-allowed;
      }

      .rectangle.disabled {
        opacity: 0.5;
        filter: grayscale(50%);
        cursor: not-allowed;
      }

      .controls-disabled {
        opacity: 0.6;
        pointer-events: none;
      }

      /* Contrôles dans le DOM de base */
      .controls-container {
        display: flex;
        margin-top: 15px;
        flex-wrap: wrap;
        align-items: center;
        gap: 15px;
      }

      .transition-container.empty {
        display: flex;
        width: 300px;
        height: 80px;
        align-items: center;
        justify-content: center;
        color: #999;
        font-style: italic;
      }

      .duration-control {
        display: flex;
        align-items: center;
        gap: 8px;
        color: #333;
        font-size: 14px;
      }

      .duration-control input[type="range"] {
        width: 120px;
      }

      .duration-control span:last-child {
        min-width: 50px;
        font-weight: bold;
      }

      .alignment-controls {
        display: flex;
        align-items: center;
        gap: 10px;
        color: #333;
        font-size: 14px;
      }

      .align-control {
        display: flex;
        align-items: center;
        gap: 5px;
      }

      /* Rectangles visibles pour cliquer */
      .rectangles-container {
        display: flex;
        margin-bottom: 20px;
        flex-wrap: wrap;
        gap: 20px;
      }

      .rectangle {
        display: flex;
        box-sizing: border-box;
        padding: 20px;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        border: 2px solid #ddd;
        border-radius: 8px;
        transition:
          transform 0.2s ease,
          box-shadow 0.2s ease;
        cursor: pointer;
      }

      .rectangle[data-state="a"] {
        width: 100px;
        height: 100px;
        color: white;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      }

      .rectangle[data-state="b"] {
        width: 300px;
        height: 150px;
        color: white;
        background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
      }

      .rectangle[data-state="c"] {
        width: 100px;
        height: 200px;
        color: white;
        background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);
      }

      .rectangle h3 {
        margin: 0 0 10px 0;
        font-size: 18px;
      }

      .rectangle p {
        margin: 0;
        font-size: 14px;
        text-align: center;
        line-height: 1.4;
      }

      /* Zone de transition */
      .transition-zone {
        margin-top: 10px;
      }

      .transition-zone h4 {
        margin-top: 10px;
        margin-bottom: 20px;
        color: #333;
      }

      /* Boîte de visualisation pour centrer la zone de transition */
      .transition-viewport {
        position: relative;
        display: flex;
        width: 350px;
        height: 250px;
        margin: 20px 0;
        align-items: center;
        justify-content: center;
        background: #fafafa;
        border: 3px solid #007acc;
        border-radius: 8px;
      }

      .transition-viewport::before {
        position: absolute;
        top: -8px;
        left: 10px;
        padding: 0 8px;
        color: #007acc;
        font-weight: bold;
        font-size: 12px;
        background: #fafafa;
        content: "Zone de visualisation 350x250";
      }

      /* Ghost debug dans la viewport (position absolue pour ne pas impacter le layout) */
      .debug-ghost {
        position: absolute;
        top: 50%;
        left: 50%;
        z-index: 10;
        border-radius: 4px;
        box-shadow: 0 0 0 3px #ff6b35;
        opacity: 0.3;
        transform: translate(-50%, -50%);
        pointer-events: none;
      }

      .content h3 {
        margin: 0 0 10px 0;
        font-size: 18px;
      }

      .content p {
        margin: 0;
        font-size: 14px;
        text-align: center;
        line-height: 1.4;
      }

      /* Debug info */
      .debug-info {
        margin-top: 30px;
        padding: 15px;
        font-size: 12px;
        font-family: monospace;
        background: #f9f9f9;
        border-radius: 4px;
      }

      .debug-info div {
        margin-bottom: 5px;
      }
    </style>
  </head>
  <body>
    <h1>Test de Transition smooth</h1>

    <!-- Rectangles visibles - cliquer pour transitionner -->
    <div class="rectangles-container">
      <div class="rectangle" data-state="a" id="rect-a">
        <h3>État A</h3>
        <p>Du texte yep</p>
      </div>

      <div class="rectangle" data-state="b" id="rect-b">
        <h3>État B</h3>
        <p>
          Rectangle plus grand avec plus de contenu. Ce texte est plus long pour
          voir comment le contenu s'adapte dans un espace plus grand. La
          transition doit être fluide.
        </p>
      </div>

      <div class="rectangle" data-state="c" id="rect-c">
        <h3>État C</h3>
        <p>Format portrait</p>
      </div>
    </div>

    <!-- Zone de transition -->
    <div class="transition-zone">
      <h4>Zone de transition:</h4>
      <div class="transition-viewport">
        <div class="transition-container" id="container">
          <div class="content-wrapper" id="wrapper">
            <!-- Conteneur pour le nouveau contenu (cross-fade) - EN PREMIER -->
            <div class="content-transitioning content-new">
              <div class="content state-empty" id="content">
                <p>
                  Cliquez sur un rectangle ci-dessus pour voir la transition
                </p>
              </div>
            </div>
            <!-- Conteneur pour l'ancien contenu (cross-fade) - EN DERNIER -->
            <div class="content-transitioning content-old"></div>
          </div>
        </div>
      </div>

      <!-- Contrôles -->
      <div class="controls-container">
        <button id="reset-button">Vider la zone</button>

        <label class="duration-control">
          <span>Durée:</span>
          <input
            type="range"
            id="duration-slider"
            min="500"
            max="5000"
            step="100"
            value="3000"
          />
          <span id="duration-value">3000ms</span>
        </label>

        <div class="alignment-controls">
          <label class="align-control">
            <span>X:</span>
            <select id="align-x-select">
              <option value="start">start</option>
              <option value="center">center</option>
              <option value="end">end</option>
            </select>
          </label>

          <label class="align-control">
            <span>Y:</span>
            <select id="align-y-select">
              <option value="start">start</option>
              <option value="center">center</option>
              <option value="end">end</option>
            </select>
          </label>
        </div>
      </div>
    </div>

    <div class="debug-info" id="debug">
      <div><strong>Debug Info:</strong></div>
      <div id="container-size">Container: 200px × 100px</div>
      <div id="content-size">Content naturel: -</div>
      <div id="scale-info">Scale: 1</div>
      <div id="state-info">État: A</div>
    </div>

    <script type="module">
      import { initUITransition } from "./poc_ui_transition.js";

      // Configuration localStorage
      const STORAGE_KEY = "smoothResizeTransition";

      // Load preferences from localStorage
      function loadPreferences() {
        try {
          const saved = localStorage.getItem(STORAGE_KEY);
          if (saved) {
            const prefs = JSON.parse(saved);
            return {
              duration: prefs.duration || 3000,
              alignX: prefs.alignX || "center",
              alignY: prefs.alignY || "center",
            };
          }
        } catch (e) {
          console.warn("Erreur lors du chargement des préférences:", e);
        }
        return {
          duration: 3000,
          alignX: "center",
          alignY: "center",
        };
      }

      // Save preferences to localStorage
      function savePreferences(prefs) {
        try {
          localStorage.setItem(STORAGE_KEY, JSON.stringify(prefs));
          console.log("Préférences sauvegardées:", prefs);
        } catch (e) {
          console.warn("Erreur lors de la sauvegarde des préférences:", e);
        }
      }

      // Demo state and UI management
      let currentState = "empty";
      const savedPrefs = loadPreferences();

      // Initialize UITransition
      const uiTransition = initUITransition(
        document.getElementById("container"),
        {
          duration: savedPrefs.duration,
          alignX: savedPrefs.alignX,
          alignY: savedPrefs.alignY,
          onStateChange: updateUIState,
        },
      );

      // Debug info elements
      const debug = {
        containerSize: document.getElementById("container-size"),
        contentSize: document.getElementById("content-size"),
        scaleInfo: document.getElementById("scale-info"),
        stateInfo: document.getElementById("state-info"),
      };

      // Update UI state during transitions
      function updateUIState({ isTransitioning }) {
        const rectangles = document.querySelectorAll(".rectangle");
        const controls = document.querySelector(".controls-container");
        const resetButton = document.getElementById("reset-button");

        if (isTransitioning) {
          rectangles.forEach((rect) => {
            rect.classList.add("disabled");
            rect.style.pointerEvents = "none";
          });

          if (controls) {
            controls.classList.add("controls-disabled");
          }

          if (resetButton) {
            resetButton.disabled = true;
            resetButton.textContent = "Transition en cours...";
          }

          debug.scaleInfo.textContent =
            "⚠️ Transition en cours - Interface désactivée";
        } else {
          rectangles.forEach((rect) => {
            rect.classList.remove("disabled");
            rect.style.pointerEvents = "auto";
          });

          if (controls) {
            controls.classList.remove("controls-disabled");
          }

          if (resetButton) {
            resetButton.disabled = false;
            resetButton.textContent = "Vider la zone";
          }

          debug.scaleInfo.textContent = `Clone utilisé: ${isTransitioning ? "Oui" : "Non"}`;
        }
      }

      // Update debug info
      function updateDebugInfo() {
        const container = document.getElementById("container");
        const containerRect = container.getBoundingClientRect();
        const currentContent = uiTransition.getCurrentContent();
        const contentRect = currentContent
          ? currentContent.getBoundingClientRect()
          : { width: 0, height: 0 };

        debug.containerSize.textContent = `Container: ${containerRect.width.toFixed(0)}px × ${containerRect.height.toFixed(0)}px`;
        debug.contentSize.textContent = `Content: ${contentRect.width.toFixed(0)}px × ${contentRect.height.toFixed(0)}px`;
        debug.scaleInfo.textContent = `Clone utilisé: ${uiTransition.getIsTransitioning() ? "Oui" : "Non"}`;
        debug.stateInfo.textContent = `État: ${currentState.toUpperCase()}`;
      }

      // Setup rectangle click handlers
      function setupRectangleClickHandlers() {
        const rectangles = document.querySelectorAll(".rectangle");

        rectangles.forEach((rectangle) => {
          rectangle.addEventListener("click", () => {
            const targetState = rectangle.dataset.state;
            console.log(`Clic sur rectangle ${targetState}:`, rectangle);

            uiTransition.transitionTo(rectangle);
            currentState = targetState;
          });
        });
      }

      // Setup controls
      function setupControls() {
        // Reset button
        const resetButton = document.getElementById("reset-button");
        if (resetButton) {
          resetButton.addEventListener("click", () => {
            const emptyElement = document.createElement("div");
            emptyElement.className = "content state-empty";
            emptyElement.innerHTML =
              "<p>Cliquez sur un rectangle ci-dessus pour voir la transition</p>";

            uiTransition.resetToEmpty(emptyElement);
            currentState = "empty";
          });
        }

        // Duration control
        const durationSlider = document.getElementById("duration-slider");
        const durationValue = document.getElementById("duration-value");

        if (durationSlider && durationValue) {
          durationSlider.value = savedPrefs.duration;
          durationValue.textContent = `${savedPrefs.duration}ms`;

          durationSlider.addEventListener("input", (e) => {
            const duration = parseInt(e.target.value);
            durationValue.textContent = `${duration}ms`;
            uiTransition.setDuration(duration);

            const prefs = { ...loadPreferences(), duration };
            savePreferences(prefs);
          });
        }

        // Alignment controls
        const alignXSelect = document.getElementById("align-x-select");
        const alignYSelect = document.getElementById("align-y-select");

        if (alignXSelect) {
          alignXSelect.value = savedPrefs.alignX;
          alignXSelect.addEventListener("change", (e) => {
            const alignX = e.target.value;
            uiTransition.setAlignment(alignX, uiTransition.alignY);

            const prefs = { ...loadPreferences(), alignX };
            savePreferences(prefs);
          });
        }

        if (alignYSelect) {
          alignYSelect.value = savedPrefs.alignY;
          alignYSelect.addEventListener("change", (e) => {
            const alignY = e.target.value;
            uiTransition.setAlignment(uiTransition.alignX, alignY);

            const prefs = { ...loadPreferences(), alignY };
            savePreferences(prefs);
          });
        }
      }

      // Initialization
      function init() {
        setupRectangleClickHandlers();
        setupControls();
        updateDebugInfo();

        // Continuous debug info updates
        setInterval(updateDebugInfo, 200);

        console.log(
          "Interface initialisée - cliquez sur les rectangles pour transitionner",
        );
      }

      // Start when DOM is ready
      if (document.readyState === "loading") {
        document.addEventListener("DOMContentLoaded", init);
      } else {
        init();
      }
    </script>
  </body>
</html>
