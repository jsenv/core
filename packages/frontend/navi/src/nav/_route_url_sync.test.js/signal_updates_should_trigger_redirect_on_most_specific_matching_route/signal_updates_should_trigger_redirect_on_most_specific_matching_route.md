# [signal updates should trigger redirect on most specific matching route](../../route_url_sync.test.js#L103)

```js
try {
  const zoomSignal = stateSignal(12, {
    id: "hierarchyZoom",
    type: "number",
  });

  const { MAP_ROUTE, MAP_ISOCHRONE_ROUTE, MAP_COMPARE_ROUTE } = setupRoutes(
    {
      MAP_ROUTE: `/map?zoom=${zoomSignal}`,
      MAP_ISOCHRONE_ROUTE: `/map/isochrone?zoom=${zoomSignal}`, 
      MAP_COMPARE_ROUTE: `/map/isochrone/compare?zoom=${zoomSignal}`,
    },
  );

  // Start on deeply nested route
  updateRoutes(`${baseUrl}/map/isochrone/compare?zoom=15`);

  const redirectCalls = [];

  // Mock all redirectTo methods to track which ones get called
  const mockRedirectTo = (routeName, originalRedirectTo) => (params) => {
    const route =
      routeName === "MAP_ROUTE"
        ? MAP_ROUTE
        : routeName === "MAP_ISOCHRONE_ROUTE"
          ? MAP_ISOCHRONE_ROUTE
          : MAP_COMPARE_ROUTE;

    redirectCalls.push({
      route: routeName,
      params,
      generatedUrl: route.buildUrl(params),
    });
    return originalRedirectTo.call(route, params);
  };

  const originalMethods = {
    map: MAP_ROUTE.redirectTo,
    isochrone: MAP_ISOCHRONE_ROUTE.redirectTo,
    compare: MAP_COMPARE_ROUTE.redirectTo,
  };

  MAP_ROUTE.redirectTo = mockRedirectTo("MAP_ROUTE", originalMethods.map);
  MAP_ISOCHRONE_ROUTE.redirectTo = mockRedirectTo(
    "MAP_ISOCHRONE_ROUTE",
    originalMethods.isochrone,
  );
  MAP_COMPARE_ROUTE.redirectTo = mockRedirectTo(
    "MAP_COMPARE_ROUTE",
    originalMethods.compare,
  );

  // When signal changes, this should trigger replaceParams on all matching routes
  // but the actual redirect should happen on the most specific one
  zoomSignal.value = 20;

  // Restore methods
  Object.assign(MAP_ROUTE, { redirectTo: originalMethods.map });
  Object.assign(MAP_ISOCHRONE_ROUTE, {
    redirectTo: originalMethods.isochrone,
  });
  Object.assign(MAP_COMPARE_ROUTE, { redirectTo: originalMethods.compare });

  return {
    // Route matching states
    routes_matching: {
      map: MAP_ROUTE.matching,
      isochrone: MAP_ISOCHRONE_ROUTE.matching,
      compare: MAP_COMPARE_ROUTE.matching,
    },

    // Track which routes handled redirects
    redirect_calls: redirectCalls,

    // Verify only the most specific route was used for redirect
    most_specific_route_used:
      redirectCalls.length > 0 ? redirectCalls[redirectCalls.length - 1].route : "none",

    // Expected: MAP_COMPARE_ROUTE should handle the redirect
    expected_most_specific: "MAP_COMPARE_ROUTE",

    // The URL that should be generated
    expected_url_pattern: "/map/isochrone/compare?zoom=20",
  };
} finally {
  clearAllRoutes();
  globalSignalRegistry.clear();
}
```

```js
{
  "routes_matching": {
    "map": false,
    "isochrone": false,
    "compare": true
  },
  "redirect_calls": [
    {
      "route": "MAP_COMPARE_ROUTE",
      "params": {
        "zoom": 20
      },
      "generatedUrl": "http://127.0.0.1/map/isochrone/compare?zoom=20"
    }
  ],
  "most_specific_route_used": "MAP_COMPARE_ROUTE",
  "expected_most_specific": "MAP_COMPARE_ROUTE",
  "expected_url_pattern": "/map/isochrone/compare?zoom=20"
}
```

---

<sub>
  Generated by <a href="https://github.com/jsenv/core/tree/main/packages/tooling/snapshot">@jsenv/snapshot</a>
</sub>
