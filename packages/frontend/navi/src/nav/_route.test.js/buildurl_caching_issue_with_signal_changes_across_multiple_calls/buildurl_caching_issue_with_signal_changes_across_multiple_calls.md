# [buildUrl caching issue with signal changes across multiple calls](../../route.test.js)

```js
try {
  const userIdSignal = stateSignal("123", { id: "cachingUserId" });
  const statusSignal = stateSignal("active", { id: "cachingStatus" });

  const { USER_PROFILE_ROUTE } = setupRoutes({
    USER_PROFILE_ROUTE: `/user/:id=${userIdSignal}/profile?status=${statusSignal}`,
  });

  // Build URL multiple times to potentially trigger caching
  const firstCall = USER_PROFILE_ROUTE.buildUrl();
  const secondCall = USER_PROFILE_ROUTE.buildUrl();
  const thirdCall = USER_PROFILE_ROUTE.buildUrl();

  // Change signal values
  userIdSignal.value = "456";
  statusSignal.value = "inactive";

  // Build URL again multiple times after signal changes
  const fourthCall = USER_PROFILE_ROUTE.buildUrl();
  const fifthCall = USER_PROFILE_ROUTE.buildUrl();

  // Change only one signal
  userIdSignal.value = "789";

  const sixthCall = USER_PROFILE_ROUTE.buildUrl();

  // Change the other signal
  statusSignal.value = "pending";

  const seventhCall = USER_PROFILE_ROUTE.buildUrl();

  return {
    signal_progression: {
      phase1: { userId: "123", status: "active" },
      phase2: { userId: "456", status: "inactive" },
      phase3: { userId: "789", status: "inactive" },
      phase4: { userId: "789", status: "pending" },
    },
    url_calls: {
      first_call: firstCall,
      second_call: secondCall,
      third_call: thirdCall,
      fourth_call: fourthCall,
      fifth_call: fifthCall,
      sixth_call: sixthCall,
      seventh_call: seventhCall,
    },
    consistency_checks: {
      // Multiple calls with same signal values should return identical URLs
      initial_consistency:
        firstCall === secondCall && secondCall === thirdCall,
      post_change_consistency: fourthCall === fifthCall,

      // URLs should change when signals change
      changed_after_both_signals: firstCall !== fourthCall,
      changed_after_userid_only: fifthCall !== sixthCall,
      changed_after_status_only: sixthCall !== seventhCall,

      // Each URL should be unique when signal combinations are unique
      all_phases_unique:
        firstCall !== fourthCall &&
        fourthCall !== sixthCall &&
        sixthCall !== seventhCall,
    },
    potential_caching_issues: {
      // If these fail, it indicates caching problems
      urls_update_with_signals:
        firstCall !== fourthCall && fourthCall !== sixthCall,
      no_stale_cache_on_repeated_calls:
        firstCall === secondCall && fourthCall === fifthCall,
    },
    test_result:
      firstCall === secondCall &&
      secondCall === thirdCall &&
      fourthCall === fifthCall &&
      firstCall !== fourthCall &&
      fourthCall !== sixthCall &&
      sixthCall !== seventhCall
        ? "PASS"
        : "FAIL",
  };
} finally {
  clearAllRoutes();
  globalSignalRegistry.clear();
}
```

```js
{
  "signal_progression": {
    "phase1": {
      "userId": "123",
      "status": "active"
    },
    "phase2": {
      "userId": "456",
      "status": "inactive"
    },
    "phase3": {
      "userId": "789",
      "status": "inactive"
    },
    "phase4": {
      "userId": "789",
      "status": "pending"
    }
  },
  "url_calls": {
    "first_call": "http://127.0.0.1/user/profile",
    "second_call": "http://127.0.0.1/user/profile",
    "third_call": "http://127.0.0.1/user/profile",
    "fourth_call": "http://127.0.0.1/user/456/profile?status=inactive",
    "fifth_call": "http://127.0.0.1/user/456/profile?status=inactive",
    "sixth_call": "http://127.0.0.1/user/789/profile?status=inactive",
    "seventh_call": "http://127.0.0.1/user/789/profile?status=pending"
  },
  "consistency_checks": {
    "initial_consistency": true,
    "post_change_consistency": true,
    "changed_after_both_signals": true,
    "changed_after_userid_only": true,
    "changed_after_status_only": true,
    "all_phases_unique": true
  },
  "potential_caching_issues": {
    "urls_update_with_signals": true,
    "no_stale_cache_on_repeated_calls": true
  },
  "test_result": "PASS"
}
```

---

<sub>
  Generated by <a href="https://github.com/jsenv/core/tree/main/packages/tooling/snapshot">@jsenv/snapshot</a>
</sub>
