# [signal update should stay on current route (dynamic segment test)](../../route_document_url_sync.test.js)

```js
const navToCalls = [];
setRouteIntegration({
  navTo: (url) => {
    navToCalls.push(url);
  },
});

try {
  const tabSignal = stateSignal(undefined);
  const lonSignal = stateSignal(undefined);
  const { DASHBOARD_ROUTE, DASHBOARD_TAB_ROUTE } = setupRoutes({
    DASHBOARD_ROUTE: `/dashboard/?lon=${lonSignal}`,
    DASHBOARD_TAB_ROUTE: `/dashboard/:tab=${tabSignal}/`,
  });

  // Step 1: Navigate to /dashboard - we're on the base dashboard route
  updateRoutes(`${baseUrl}/dashboard`);

  const afterDashboardNav = {
    current_url: "/dashboard",
    tab_signal_value: tabSignal.value, // Should be undefined
    dashboard_route_matching: DASHBOARD_ROUTE.matching,
    dashboard_tab_route_matching: DASHBOARD_TAB_ROUTE.matching,
    navToCalls: [...navToCalls],
  };

  // Clear navTo calls before the critical test
  navToCalls.length = 0;

  // Step 2: Update lonSignal - this should stay on /dashboard?lon=20
  // BUG WOULD BE: System incorrectly chooses /dashboard/:tab route even though:
  // - tabSignal.value = undefined
  // - /dashboard/:tab requires a tab parameter
  // - These are INCOMPATIBLE (undefined cannot fill :tab parameter)
  lonSignal.value = 20;

  const afterUpdatingLon = {
    lon_signal_value: lonSignal.value, // Should be 20
    tab_signal_value: tabSignal.value, // Should STILL be undefined
    dashboard_route_matching: DASHBOARD_ROUTE.matching,
    dashboard_tab_route_matching: DASHBOARD_TAB_ROUTE.matching,
    navToCalls: [...navToCalls],
  };

  return {
    after_dashboard_nav: afterDashboardNav,
    after_updating_lon: afterUpdatingLon,

    // BUG DETECTION: Should NOT navigate to child route with dynamic segment
    bug_reproduced: navToCalls.some((url) =>
      url.includes("/dashboard/undefined"),
    ),

    // EXPECTED: Should stay on /dashboard?lon=20
    expected_url: "/dashboard?lon=20",
    actual_nav_calls: navToCalls,

    // ANALYSIS: Why /dashboard/:tab should be INCOMPATIBLE
    compatibility_analysis: {
      current_tab_signal: tabSignal.value, // undefined
      tab_route_requires: "tab parameter (non-undefined)",
      are_compatible: tabSignal.value !== undefined, // Should be false
      issue:
        "/dashboard/:tab should not be selected when tabSignal.value = undefined",
      correct_behavior:
        "Should stay on /dashboard/ with updated lon parameter",
      dynamic_segment_note:
        "Unlike static segments, dynamic segments need actual parameter values",
    },

    // DEBUG INFO
    signal_values_during_update: {
      tabSignal: tabSignal.value,
      lonSignal: lonSignal.value,
    },
  };
} finally {
  clearAllRoutes();
  globalSignalRegistry.clear();
  setRouteIntegration(null);
}
```

```js
{
  "after_dashboard_nav": {
    "current_url": "/dashboard",
    "tab_signal_value": undefined,
    "dashboard_route_matching": true,
    "dashboard_tab_route_matching": true,
    "navToCalls": []
  },
  "after_updating_lon": {
    "lon_signal_value": 20,
    "tab_signal_value": undefined,
    "dashboard_route_matching": true,
    "dashboard_tab_route_matching": true,
    "navToCalls": [
      "http://127.0.0.1/dashboard?lon=20"
    ]
  },
  "bug_reproduced": false,
  "expected_url": "/dashboard?lon=20",
  "actual_nav_calls": [
    "http://127.0.0.1/dashboard?lon=20"
  ],
  "compatibility_analysis": {
    "current_tab_signal": undefined,
    "tab_route_requires": "tab parameter (non-undefined)",
    "are_compatible": false,
    "issue": "/dashboard/:tab should not be selected when tabSignal.value = undefined",
    "correct_behavior": "Should stay on /dashboard/ with updated lon parameter",
    "dynamic_segment_note": "Unlike static segments, dynamic segments need actual parameter values"
  },
  "signal_values_during_update": {
    "tabSignal": undefined,
    "lonSignal": 20
  }
}
```

---

<sub>
  Generated by <a href="https://github.com/jsenv/core/tree/main/packages/tooling/snapshot">@jsenv/snapshot</a>
</sub>
