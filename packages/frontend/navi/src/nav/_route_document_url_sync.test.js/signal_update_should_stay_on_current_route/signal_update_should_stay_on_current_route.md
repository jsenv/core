# [signal update should stay on current route](../../route_document_url_sync.test.js)

```js
const navToCalls = [];
const mockBrowserIntegration = {
  navTo: (url) => {
    navToCalls.push(url);
  },
};
setBrowserIntegration(mockBrowserIntegration);

try {
  const mapPanelSignal = stateSignal(undefined);
  const lonSignal = stateSignal(undefined);
  const { MAP_ROUTE, MAP_PANEL_ROUTE, MAP_FLOW_ROUTE } = setupRoutes({
    MAP_ROUTE: `/map/?lon=${lonSignal}`,
    MAP_PANEL_ROUTE: `/map/:panel=${mapPanelSignal}/`,
    MAP_FLOW_ROUTE: `/map/flow/`,
  });

  // Step 1: Navigate to /map - we're on the base map route
  updateRoutes(`${baseUrl}/map`);

  const afterMapNav = {
    current_url: "/map",
    panel_signal_value: mapPanelSignal.value, // Should be undefined
    map_route_matching: MAP_ROUTE.matching,
    panel_route_matching: MAP_PANEL_ROUTE.matching,
    flow_route_matching: MAP_FLOW_ROUTE.matching,
    navToCalls: [...navToCalls],
  };

  // Clear navTo calls before the critical test
  navToCalls.length = 0;

  // Step 2: Update lonSignal - this should stay on /map?lon=20, NOT redirect to /map/flow/
  // BUG: System incorrectly chooses /map/flow/ as "deepest child" even though:
  // - mapPanelSignal.value = undefined
  // - /map/flow/ requires panel = "flow"
  // - These are INCOMPATIBLE
  lonSignal.value = 20;

  const afterUpdatingLon = {
    lon_signal_value: lonSignal.value, // Should be 20
    panel_signal_value: mapPanelSignal.value, // Should STILL be undefined
    map_route_matching: MAP_ROUTE.matching,
    panel_route_matching: MAP_PANEL_ROUTE.matching,
    flow_route_matching: MAP_FLOW_ROUTE.matching,
    navToCalls: [...navToCalls],
  };

  return {
    after_map_nav: afterMapNav,
    after_updating_lon: afterUpdatingLon,

    // BUG DETECTION
    bug_reproduced: navToCalls.some((url) => url.includes("/map/flow")),

    // EXPECTED: Should stay on /map?lon=20
    expected_url: "/map?lon=20",
    actual_nav_calls: navToCalls,

    // ANALYSIS: Why /map/flow/ should be INCOMPATIBLE
    compatibility_analysis: {
      current_panel_signal: mapPanelSignal.value, // undefined
      flow_route_requires: "panel = 'flow'",
      are_compatible: mapPanelSignal.value === "flow", // Should be false
      issue:
        "/map/flow/ should not be selected when mapPanelSignal.value = undefined",
      correct_behavior: "Should stay on /map/ with updated lon parameter",
    },

    // DEBUG INFO
    signal_values_during_update: {
      mapPanelSignal: mapPanelSignal.value,
      lonSignal: lonSignal.value,
    },
  };
} finally {
  clearAllRoutes();
  globalSignalRegistry.clear();
  setBrowserIntegration(null);
}
```

```js
{
  "after_map_nav": {
    "current_url": "/map",
    "panel_signal_value": undefined,
    "map_route_matching": true,
    "panel_route_matching": true,
    "flow_route_matching": false,
    "navToCalls": []
  },
  "after_updating_lon": {
    "lon_signal_value": 20,
    "panel_signal_value": undefined,
    "map_route_matching": true,
    "panel_route_matching": true,
    "flow_route_matching": false,
    "navToCalls": [
      "http://127.0.0.1/map?lon=20"
    ]
  },
  "bug_reproduced": false,
  "expected_url": "/map?lon=20",
  "actual_nav_calls": [
    "http://127.0.0.1/map?lon=20"
  ],
  "compatibility_analysis": {
    "current_panel_signal": undefined,
    "flow_route_requires": "panel = 'flow'",
    "are_compatible": false,
    "issue": "/map/flow/ should not be selected when mapPanelSignal.value = undefined",
    "correct_behavior": "Should stay on /map/ with updated lon parameter"
  },
  "signal_values_during_update": {
    "mapPanelSignal": undefined,
    "lonSignal": 20
  }
}
```

---

<sub>
  Generated by <a href="https://github.com/jsenv/core/tree/main/packages/tooling/snapshot">@jsenv/snapshot</a>
</sub>
