# [parameterized route conflict with shared signals](../../route_document_url_sync.test.js)

```js
try {
  const zoomSignal = stateSignal(10, {
    id: "sharedZoom",
    type: "number",
  });

  const panelSignal = stateSignal(undefined, {
    id: "panelValue",
    type: "string",
  });

  // Set panel signal to initial value
  panelSignal.value = "isochrone";

  // More realistic scenario where routes have signals that control parameters
  // This should reproduce the delegation issue
  const { MAP_ROUTE, MAP_PANEL_ROUTE, MAP_ISOCHRONE_ROUTE } = setupRoutes({
    MAP_ROUTE: `/map?zoom=${zoomSignal}`,
    MAP_PANEL_ROUTE: `/map/:panel={navi_state_signal:panelValue}?zoom=${zoomSignal}`,
    MAP_ISOCHRONE_ROUTE: `/map/isochrone?zoom=${zoomSignal}`,
  });

  const navToCalls = [];
  const allNavToCalls = []; // Track ALL navigation calls including during navigation
  setRouteIntegration({
    navTo: (url) => {
      navToCalls.push(url);
      allNavToCalls.push(url);
      updateRoutes(url);
      return Promise.resolve();
    },
  });

  // SCENARIO:
  // 1. Start at /map/isochrone?zoom=10 (panel signal = "isochrone")
  updateRoutes(`${baseUrl}/map/isochrone?zoom=10`);

  const afterIsochrone = {
    url: `${baseUrl}/map/isochrone?zoom=10`,
    signal_values: {
      zoom: zoomSignal.value,
      panel: panelSignal.value,
    },
    routes: {
      map: MAP_ROUTE.matching,
      panel: MAP_PANEL_ROUTE.matching,
      isochrone: MAP_ISOCHRONE_ROUTE.matching,
    },
  };

  // Clear navigation history after navigation
  navToCalls.length = 0;

  // 2. Navigate to /map?zoom=10 (but panel signal still = "isochrone")
  updateRoutes(`${baseUrl}/map?zoom=10`);

  const afterMap = {
    url: `${baseUrl}/map?zoom=10`,
    signal_values: {
      zoom: zoomSignal.value,
      panel: panelSignal.value,
    },
    routes: {
      map: MAP_ROUTE.matching,
      panel: MAP_PANEL_ROUTE.matching, // This might still be matching if panel="isochrone"!
      isochrone: MAP_ISOCHRONE_ROUTE.matching,
    },
  };

  // Clear navigation history after navigation
  navToCalls.length = 0;

  // 3. Update zoom signal - this is where the bug should occur
  // If MAP_PANEL_ROUTE is still matching because panel="isochrone",
  // it might be considered "more specific" and redirect incorrectly
  zoomSignal.value = 25;

  return {
    after_isochrone_nav: afterIsochrone,
    after_map_nav: afterMap,

    // After signal update
    signal_update_nav_calls: navToCalls,

    // Expected: Should navigate to stay on /map
    expected_url_pattern: "/map?zoom=25",

    // Actual
    actual_url:
      navToCalls.length > 0 ? navToCalls[navToCalls.length - 1] : "none",

    // Full navigation history for debugging
    all_nav_calls_during_test: allNavToCalls,

    // Signal values at the end
    final_signal_values: {
      zoom: zoomSignal.value,
      panel: panelSignal.value,
    },
  };
} finally {
  clearAllRoutes();
  globalSignalRegistry.clear();
}
```

```js
{
  "after_isochrone_nav": {
    "url": "http://127.0.0.1/map/isochrone?zoom=10",
    "signal_values": {
      "zoom": 10,
      "panel": "isochrone"
    },
    "routes": {
      "map": true,
      "panel": true,
      "isochrone": true
    }
  },
  "after_map_nav": {
    "url": "http://127.0.0.1/map?zoom=10",
    "signal_values": {
      "zoom": 10,
      "panel": undefined
    },
    "routes": {
      "map": true,
      "panel": false,
      "isochrone": false
    }
  },
  "signal_update_nav_calls": [
    "http://127.0.0.1/map?zoom=25"
  ],
  "expected_url_pattern": "/map?zoom=25",
  "actual_url": "http://127.0.0.1/map?zoom=25",
  "all_nav_calls_during_test": [
    "http://127.0.0.1/map?zoom=25"
  ],
  "final_signal_values": {
    "zoom": 25,
    "panel": undefined
  }
}
```

---

<sub>
  Generated by <a href="https://github.com/jsenv/core/tree/main/packages/tooling/snapshot">@jsenv/snapshot</a>
</sub>
