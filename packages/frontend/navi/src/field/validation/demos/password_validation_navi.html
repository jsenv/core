<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>Password Validation Demo - Navi Version</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <style>
      body {
        max-width: 600px;
        margin: 40px auto;
        padding: 20px;
        color: #333;
        font-family:
          system-ui,
          -apple-system,
          sans-serif;
        line-height: 1.5;
      }

      .demo-section {
        margin-bottom: 30px;
        padding: 30px;
        background: #fff;
        border: 1px solid #e0e0e0;
        border-radius: 8px;
      }

      h1 {
        margin: 0 0 10px 0;
        color: #2c3e50;
        font-size: 1.5rem;
      }

      .description {
        margin: 0 0 30px 0;
        color: #666;
        font-size: 0.95rem;
      }

      .form-group {
        margin-bottom: 20px;
      }

      label {
        display: block;
        margin-bottom: 8px;
        color: #555;
        font-weight: 500;
      }

      input[type="password"] {
        box-sizing: border-box;
        width: 100%;
        padding: 12px 16px;
        font-size: 1rem;
        border: 2px solid #e0e0e0;
        border-radius: 6px;
        transition: border-color 0.2s ease;
      }

      input[type="password"]:focus {
        border-color: #007bff;
        outline: none;
        box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.1);
      }

      .constraints-list {
        margin-top: 15px;
        padding: 20px;
        background: #f8f9fa;
        border: 1px solid #e9ecef;
        border-radius: 6px;
      }

      .constraints-title {
        margin: 0 0 15px 0;
        color: #495057;
        font-weight: 600;
        font-size: 0.9rem;
      }

      .constraint {
        display: flex;
        margin-bottom: 10px;
        padding: 8px 0;
        align-items: center;
        font-size: 0.9rem;
        transition: all 0.2s ease;
      }

      .constraint:last-child {
        margin-bottom: 0;
      }

      .constraint-icon {
        display: flex;
        width: 18px;
        height: 18px;
        margin-right: 12px;
        flex-shrink: 0;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        font-size: 0.7rem;
        border-radius: 50%;
        transition: all 0.2s ease;
      }

      .constraint.unfulfilled .constraint-icon {
        color: #6c757d;
        background: #f8f9fa;
        border: 1px solid #dee2e6;
      }

      .constraint.unfulfilled .constraint-icon::before {
        content: "○";
      }

      .constraint.fulfilled .constraint-icon {
        color: white;
        background: #28a745;
      }

      .constraint.fulfilled .constraint-icon::before {
        content: "✓";
      }

      .constraint.unfulfilled .constraint-text {
        color: #6c757d;
      }

      .constraint.fulfilled .constraint-text {
        color: #28a745;
        opacity: 0.8;
      }

      .constraint-text {
        flex: 1;
        transition: all 0.2s ease;
      }

      .debug-info {
        margin-top: 20px;
        padding: 15px;
        color: #666;
        font-size: 0.8rem;
        font-family: "Courier New", monospace;
        background: #f1f3f4;
        border-radius: 6px;
      }

      .debug-title {
        margin-bottom: 8px;
        color: #333;
        font-weight: bold;
      }
    </style>
  </head>
  <body>
    <div id="root"></div>

    <script type="module" jsenv-type="module/jsx">
      import { useRef, useState, useEffect } from "preact/hooks";
      import { render } from "preact";
      import { useConstraintValidityState } from "../hooks/use_constraint_validity_state.js";
      import { installCustomConstraintValidation } from "../custom_constraint_validation.js";

      const PasswordField = () => {
        const passwordRef = useRef();
        const [password, setPassword] = useState("");
        const constraintValidityState = useConstraintValidityState(passwordRef);

        // Define password constraints
        const constraints = {
          minLength: {
            test: (value) => value.length >= 10,
            message: "At least 10 characters long",
          },
          uppercase: {
            test: (value) => /[A-Z]/.test(value),
            message: "Contains at least one uppercase letter (A-Z)",
          },
          lowercase: {
            test: (value) => /[a-z]/.test(value),
            message: "Contains at least one lowercase letter (a-z)",
          },
          number: {
            test: (value) => /[0-9]/.test(value),
            message: "Contains at least one number (0-9)",
          },
          special: {
            test: (value) => /[!@#$%^&*]/.test(value),
            message: "Contains at least one special character (!@#$%^&*)",
          },
        };

        // Set up custom constraint validation
        useEffect(() => {
          const element = passwordRef.current;
          if (!element || element.__validationInterface__) {
            return undefined;
          }

          // Install custom validation interface
          const validationInterface =
            installCustomConstraintValidation(element);

          // Register custom constraint that validates password
          validationInterface.registerConstraint({
            name: "password_requirements",
            check: (element) => {
              const value = element.value;
              const violations = [];

              Object.entries(constraints).forEach(([key, constraint]) => {
                if (!constraint.test(value)) {
                  violations.push({
                    constraint: key,
                    message: constraint.message,
                  });
                }
              });

              if (violations.length > 0) {
                return {
                  message: `Password requirements not met: ${violations.map((v) => v.message.toLowerCase()).join(", ")}`,
                  status: "error",
                };
              }

              return null; // Valid
            },
          });

          return () => validationInterface.uninstall();
        }, []);

        const handleInput = (event) => {
          const value = event.target.value;
          setPassword(value);

          // The validation interface will automatically check validity on input
        };

        // Calculate constraint states for UI display
        const constraintStates = {};
        const fulfilledCount = Object.entries(constraints).reduce(
          (count, [key, constraint]) => {
            const isFulfilled = constraint.test(password);
            constraintStates[key] = isFulfilled;
            return count + (isFulfilled ? 1 : 0);
          },
          0,
        );

        return (
          <div className="demo-section">
            <h1>Password Validation Demo - Navi Version</h1>
            <p className="description">
              A Navi implementation using useConstraintValidityState for
              real-time password validation with visual feedback for multiple
              constraints. This demonstrates the integration of custom
              validation logic with the Navi validation system.
            </p>

            <form>
              <div className="form-group">
                <label htmlFor="password">Password</label>
                <input
                  ref={passwordRef}
                  type="password"
                  id="password"
                  name="password"
                  value={password}
                  onInput={handleInput}
                  placeholder="Enter your password"
                  autoComplete="new-password"
                />
              </div>

              <div className="constraints-list">
                <div className="constraints-title">Password Requirements:</div>

                {Object.entries(constraints).map(([key, constraint]) => (
                  <div
                    key={key}
                    className={`constraint ${constraintStates[key] ? "fulfilled" : "unfulfilled"}`}
                    data-constraint={key}
                  >
                    <div className="constraint-icon"></div>
                    <div className="constraint-text">{constraint.message}</div>
                  </div>
                ))}
              </div>

              <div className="debug-info">
                <div className="debug-title">Debug Information:</div>
                <div>
                  Password length: <span>{password.length}</span>
                </div>
                <div>
                  Fulfilled constraints: <span>{fulfilledCount}</span>/
                  {Object.keys(constraints).length}
                </div>
                <div>
                  Valid:{" "}
                  <span>{constraintValidityState?.valid ? "Yes" : "No"}</span>
                </div>
                <div>
                  Validation Interface:{" "}
                  <span>
                    {passwordRef.current?.__validationInterface__
                      ? "Installed"
                      : "Not installed"}
                  </span>
                </div>
                {constraintValidityState && !constraintValidityState.valid && (
                  <div>Failed constraint: password_requirements</div>
                )}
              </div>
            </form>
          </div>
        );
      };

      const App = () => {
        return <PasswordField />;
      };

      // Render the app
      render(<App />, document.getElementById("root"));
    </script>
  </body>
</html>
