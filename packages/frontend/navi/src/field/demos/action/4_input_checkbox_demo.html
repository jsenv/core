<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <link rel="icon" href="data:," />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Checkbox Demo</title>
    <style>
      body {
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
        font-family:
          system-ui,
          -apple-system,
          sans-serif;
      }
      .demo-grid {
        display: grid;
        margin-bottom: 30px;
        grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
        gap: 20px;
      }
      .demo-card {
        padding: 20px;
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      }
      .demo-title {
        margin: 0 0 15px 0;
        padding-bottom: 8px;
        color: #333;
        font-weight: 600;
        font-size: 16px;
        border-bottom: 2px solid #e0e0e0;
      }
      .result-display {
        min-height: 20px;
        margin-top: 15px;
        padding: 12px;
        font-size: 14px;
        font-family: monospace;
        background: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 4px;
      }
      .result-success {
        color: #155724;
        background: #d4edda;
        border-color: #c3e6cb;
      }
      .result-error {
        color: #721c24;
        background: #f8d7da;
        border-color: #f5c6cb;
      }
      .result-loading {
        color: #0c5460;
        background: #d1ecf1;
        border-color: #bee5eb;
      }
      .button-group {
        display: flex;
        margin-top: 10px;
        gap: 10px;
      }
      .control-group {
        margin-bottom: 15px;
      }
      .checkbox-group {
        display: flex;
        margin-bottom: 10px;
        align-items: center;
        gap: 8px;
      }
      .checkbox-group input[type="checkbox"] {
        width: 18px;
        height: 18px;
        cursor: pointer;
      }
      .checkbox-group label {
        color: #555;
        font-weight: 500;
        cursor: pointer;
      }
      .status-indicator {
        display: inline-block;
        width: 12px;
        height: 12px;
        margin-right: 8px;
        border-radius: 50%;
      }
      .status-idle {
        background: #6c757d;
      }
      .status-loading {
        background: #007bff;
        animation: pulse 1s infinite;
      }
      .status-success {
        background: #28a745;
      }
      .status-error {
        background: #dc3545;
      }
      @keyframes pulse {
        0%,
        100% {
          opacity: 1;
        }
        50% {
          opacity: 0.5;
        }
      }
      nav a {
        color: #007bff;
        text-decoration: none;
      }
      nav a:hover {
        text-decoration: underline;
      }
      h2 {
        margin-top: 40px;
        margin-bottom: 20px;
        padding-top: 20px;
        border-top: 2px solid #e0e0e0;
      }
      h2:first-of-type {
        margin-top: 0;
        padding-top: 0;
        border-top: none;
      }
    </style>
  </head>
  <body>
    <h1>Checkbox Demo</h1>
    <div id="root"></div>

    <script type="module" jsenv-type="module/jsx">
      import { render } from "preact";
      import { useState, useRef } from "preact/hooks";
      import { createAction, Form, Input, Button } from "@jsenv/navi";

      const delay = (ms) => new Promise((resolve) => setTimeout(resolve, ms));

      const App = () => {
        const [checkboxBackgroundColor, setCheckboxBackgroundColor] =
          useState(undefined);

        return (
          <>
            <div className="demo-card" style={{ marginBottom: "30px" }}>
              <h2>Checkbox Demo - Overview</h2>
              <p>
                This demo showcases different ways to use the Input component
                with checkboxes.
              </p>

              <div
                className="control-group"
                style={{
                  marginBottom: "20px",
                  padding: "15px",
                  backgroundColor: "#f8f9fa",
                  borderRadius: "8px",
                }}
              >
                <label>
                  <strong>Global Checkbox Background Color:</strong>
                  <select
                    value={checkboxBackgroundColor || ""}
                    onChange={(e) =>
                      setCheckboxBackgroundColor(e.target.value || undefined)
                    }
                    style={{
                      marginLeft: "10px",
                      padding: "5px 10px",
                      borderRadius: "4px",
                      border: "1px solid #ccc",
                    }}
                  >
                    <option value="">Default</option>
                    <option value="#ff6b6b">Red</option>
                    <option value="#51cf66">Green</option>
                  </select>
                </label>
                <p
                  style={{
                    fontSize: "14px",
                    color: "#666",
                    margin: "8px 0 0 0",
                  }}
                >
                  This affects all checkboxes below and demonstrates that
                  background color changes don't affect checked state.
                </p>
              </div>

              <nav>
                <h3>Sections:</h3>
                <ul style={{ marginLeft: "20px" }}>
                  <li>
                    <a href="#basic-checkboxes">
                      1. Basic Checkbox (no action/no form)
                    </a>{" "}
                    - Simple checkboxes with value handling
                  </li>
                  <li>
                    <a href="#checkbox-actions">2. Checkbox with Actions</a> -
                    Checkboxes that trigger actions on change, including error
                    handling
                  </li>
                  <li>
                    <a href="#checkbox-forms">3. Checkbox inside Form</a> - Form
                    integration patterns
                  </li>
                </ul>
              </nav>
            </div>

            <h2 id="basic-checkboxes">1. Basic Checkbox (no action/no form)</h2>
            <div className="demo-grid">
              <CheckboxDemo backgroundColor={checkboxBackgroundColor} />
              <CheckboxDefaultCheckedDemo
                backgroundColor={checkboxBackgroundColor}
              />
            </div>

            <h2 id="checkbox-actions">2. Checkbox with Actions</h2>
            <div className="demo-grid">
              <CheckboxActionDemo backgroundColor={checkboxBackgroundColor} />
              <CheckboxActionDefaultCheckedDemo
                backgroundColor={checkboxBackgroundColor}
              />
              <CheckboxActionErrorDemo
                backgroundColor={checkboxBackgroundColor}
              />
              <CheckboxActionErrorDefaultCheckedDemo
                backgroundColor={checkboxBackgroundColor}
              />
              <CheckboxActionErrorOnUncheckedDemo
                backgroundColor={checkboxBackgroundColor}
              />
              <CheckboxActionObjectDemo
                backgroundColor={checkboxBackgroundColor}
              />
            </div>

            <h2 id="checkbox-forms">3. Checkbox inside Form</h2>
            <div className="demo-grid">
              <CheckboxFormControlledErrorDemo
                backgroundColor={checkboxBackgroundColor}
              />
            </div>
          </>
        );
      };

      const CheckboxDemo = ({ backgroundColor }) => {
        const [result, setResult] = useState("");
        const [status] = useState("idle");
        const ref = useRef();

        return (
          <div className="demo-card">
            <h3 className="demo-title">
              Basic Checkbox
              <button
                onClick={() => {
                  ref.current.dispatchEvent(new CustomEvent("resetuistate"));
                }}
              >
                Reset
              </button>
            </h3>
            <div className="control-group">
              <div className="checkbox-group">
                <label>
                  <Input
                    ref={ref}
                    type="checkbox"
                    name="enabled"
                    accentColor={backgroundColor}
                    onUIStateChange={(checked) => {
                      setResult(checked ? "checked" : "unchecked");
                    }}
                  />
                  Enable feature
                </label>
              </div>
            </div>
            <div
              className={`result-display ${status === "loading" ? "result-loading" : status === "success" ? "result-success" : status === "error" ? "result-error" : ""}`}
            >
              {result || "Check or uncheck to see action..."}
            </div>
          </div>
        );
      };

      const CheckboxDefaultCheckedDemo = ({ backgroundColor }) => {
        const [result, setResult] = useState("");
        const [status] = useState("idle");
        const ref = useRef();

        return (
          <div className="demo-card">
            <h3 className="demo-title">
              Basic Checkbox (Default Checked)
              <button
                onClick={() => {
                  ref.current.dispatchEvent(new CustomEvent("resetuistate"));
                }}
              >
                Reset
              </button>
            </h3>
            <div className="control-group">
              <div className="checkbox-group">
                <label>
                  <Input
                    ref={ref}
                    type="checkbox"
                    name="enabled"
                    defaultChecked
                    accentColor={backgroundColor}
                    onUIStateChange={(checked) => {
                      setResult(checked ? "checked" : "unchecked");
                    }}
                  />
                  Enable feature
                </label>
              </div>
            </div>
            <div
              className={`result-display ${status === "loading" ? "result-loading" : status === "success" ? "result-success" : status === "error" ? "result-error" : ""}`}
            >
              {result || "Check or uncheck to see action..."}
            </div>
          </div>
        );
      };

      const CheckboxActionDemo = ({ backgroundColor }) => {
        const [result, setResult] = useState("");
        const [status, setStatus] = useState("idle");

        return (
          <div className="demo-card">
            <h3 className="demo-title">Checkbox with Action</h3>
            <div className="control-group">
              <div className="checkbox-group">
                <label>
                  <Input
                    type="checkbox"
                    name="enabled"
                    accentColor={backgroundColor}
                    action={async (enabled) => {
                      setStatus("loading");
                      setResult("Processing...");
                      try {
                        await delay(1000);
                        const response = `${enabled ? "✅" : "☐"} Checkbox ${enabled ? "checked" : "unchecked"}`;
                        setResult(response);
                        setStatus("success");
                        return response;
                      } catch (error) {
                        setResult(`❌ Error: ${error.message}`);
                        setStatus("error");
                        throw error;
                      }
                    }}
                  />
                  <span className={`status-indicator status-${status}`}></span>
                  Enable feature
                </label>
              </div>
            </div>
            <div
              className={`result-display ${status === "loading" ? "result-loading" : status === "success" ? "result-success" : status === "error" ? "result-error" : ""}`}
            >
              {result || "Check or uncheck to see action..."}
            </div>
          </div>
        );
      };

      const CheckboxActionDefaultCheckedDemo = ({ backgroundColor }) => {
        const [result, setResult] = useState("");

        return (
          <div className="demo-card">
            <h3 className="demo-title">
              Checkbox with Action (Default Checked)
            </h3>
            <div className="control-group">
              <div className="checkbox-group">
                <label>
                  <Input
                    type="checkbox"
                    name="agreed"
                    defaultChecked
                    accentColor={backgroundColor}
                    action={async (agreed) => {
                      setResult("Processing...");
                      await delay(800);
                      const response = `${agreed ? "✅" : "☐"} Agreement: ${agreed ? "accepted" : "declined"}`;
                      setResult(response);
                      return response;
                    }}
                  />
                  I agree to the terms and conditions
                </label>
              </div>
            </div>
            <div
              className={`result-display ${result.startsWith("✅") || result.startsWith("☐") ? "result-success" : ""}`}
            >
              {result || "Change checkbox to see action..."}
            </div>
          </div>
        );
      };

      const CheckboxActionErrorDemo = ({ backgroundColor }) => {
        const [result, setResult] = useState("");
        const [status, setStatus] = useState("idle");

        return (
          <div className="demo-card">
            <h3 className="demo-title">Checkbox with Action (Always Fails)</h3>
            <div className="control-group">
              <div className="checkbox-group">
                <label>
                  <Input
                    type="checkbox"
                    name="dangerous"
                    accentColor={backgroundColor}
                    action={async (dangerous) => {
                      setStatus("loading");
                      setResult("Processing...");
                      try {
                        await delay(1500);
                        throw new Error(
                          `Action failed for ${dangerous ? "checked" : "unchecked"} state`,
                        );
                      } catch (error) {
                        setResult(`❌ ${error.message}`);
                        setStatus("error");
                        throw error;
                      }
                    }}
                  />
                  <span className={`status-indicator status-${status}`}></span>
                  Dangerous operation (always fails)
                </label>
              </div>
            </div>
            <div
              className={`result-display ${status === "loading" ? "result-loading" : status === "error" ? "result-error" : ""}`}
            >
              {result || "This checkbox will always trigger an error..."}
            </div>
          </div>
        );
      };

      const CheckboxActionErrorDefaultCheckedDemo = ({ backgroundColor }) => {
        const [result, setResult] = useState("");
        const [status, setStatus] = useState("idle");

        return (
          <div className="demo-card">
            <h3 className="demo-title">
              Checkbox with Action (Default Checked, Always Fails)
            </h3>
            <div className="control-group">
              <div className="checkbox-group">
                <Input
                  id="error-initial-checkbox"
                  type="checkbox"
                  name="risky"
                  defaultChecked
                  accentColor={backgroundColor}
                  action={async (risky) => {
                    setStatus("loading");
                    setResult("Processing...");
                    try {
                      await delay(1200);
                      throw new Error(
                        `Operation failed for ${risky ? "enabled" : "disabled"} risky feature`,
                      );
                    } catch (error) {
                      setResult(`❌ ${error.message}`);
                      setStatus("error");
                      throw error;
                    }
                  }}
                />
                <label htmlFor="error-initial-checkbox">
                  <span className={`status-indicator status-${status}`}></span>
                  Enable risky feature (starts checked, always fails)
                </label>
              </div>
            </div>
            <div
              className={`result-display ${status === "loading" ? "result-loading" : status === "error" ? "result-error" : ""}`}
            >
              {result ||
                "This checkbox starts checked and will always trigger an error..."}
            </div>
          </div>
        );
      };

      const CheckboxActionErrorOnUncheckedDemo = ({ backgroundColor }) => {
        // for this example the checkbox is going to be controlled because that's how you would
        // implement it in a real world scenario:
        // the fact checkbox is checked comes from a backend so when the operation succeeds
        // the component is re-rendered as checked

        const [result, setResult] = useState("");
        const [status, setStatus] = useState("idle");
        const [checked, setChecked] = useState(false);

        return (
          <div className="demo-card">
            <h3 className="demo-title">
              Checkbox with Action (Fails When Unchecked)
            </h3>
            <div className="control-group">
              <div className="checkbox-group">
                <label>
                  <Input
                    type="checkbox"
                    name="protection"
                    checked={checked}
                    accentColor={backgroundColor}
                    action={async (protection) => {
                      setStatus("loading");
                      setResult("Processing...");
                      await delay(1000);
                      try {
                        if (!protection) {
                          throw new Error(
                            "Protection must be enabled for security",
                          );
                        }
                        const response = `✅ Protection ${protection ? "enabled" : "disabled"}`;
                        setResult(response);
                        setStatus("success");
                        setChecked(true);
                        return response;
                      } catch (error) {
                        setResult(`❌ ${error.message}`);
                        setStatus("error");
                        throw error;
                      }
                    }}
                  />
                  <span className={`status-indicator status-${status}`}></span>
                  Enable security protection (fails when unchecked)
                </label>
              </div>
            </div>
            <div
              className={`result-display ${status === "loading" ? "result-loading" : status === "success" ? "result-success" : status === "error" ? "result-error" : ""}`}
            >
              {result ||
                "Toggle checkbox - succeeds when checked, fails when unchecked..."}
            </div>
          </div>
        );
      };

      const toggleAction = createAction(async ({ notifications }) => {
        await delay(600);
        return `${notifications ? "✅" : "☐"} Notifications ${notifications ? "enabled" : "disabled"}`;
      });

      const CheckboxActionObjectDemo = ({ backgroundColor }) => {
        const [result, setResult] = useState("");

        return (
          <div className="demo-card">
            <h3 className="demo-title">Checkbox with Action Object</h3>
            <div className="control-group">
              <div className="checkbox-group">
                <label>
                  <Input
                    type="checkbox"
                    name="notifications"
                    accentColor={backgroundColor}
                    action={(notifications) => {
                      return toggleAction({ notifications });
                    }}
                    onActionStart={() => {
                      setResult("Processing...");
                    }}
                    onActionEnd={(e) => {
                      setResult(e.detail.data);
                    }}
                  />
                  Enable notifications (with action object)
                </label>
              </div>
            </div>
            <div
              className={`result-display ${result.startsWith("✅") || result.startsWith("☐") ? "result-success" : ""}`}
            >
              {result || "Toggle checkbox to trigger action object..."}
            </div>
          </div>
        );
      };

      const CheckboxFormControlledErrorDemo = ({ backgroundColor }) => {
        const [checked, setChecked] = useState(true);
        const [result, setResult] = useState("");
        const [status, setStatus] = useState("idle");
        const ref = useRef();

        return (
          <div className="demo-card">
            <h3 className="demo-title">
              Form with Controlled Checkbox (Fails When Submit Without Check)
            </h3>
            <p
              style={{ fontSize: "14px", color: "#666", marginBottom: "15px" }}
            >
              This demonstrates backend validation when frontend forgets to add
              "required" - the server throws an error during form submission if
              terms aren't agreed.
            </p>
            <Form
              action={async ({ terms }) => {
                setStatus("loading");
                setResult("Processing form...");
                try {
                  await delay(1000);
                  if (!terms) {
                    throw new Error(
                      "You must agree to the terms and conditions to proceed",
                    );
                  }
                  setChecked(Boolean(terms));
                  const response = "✅ Form submitted successfully!";
                  setResult(response);
                  setStatus("success");
                  return response;
                } catch (error) {
                  setResult(`❌ ${error.message}`);
                  setStatus("error");
                  throw error;
                }
              }}
            >
              <div className="control-group">
                <div className="checkbox-group">
                  <label>
                    <Input
                      ref={ref}
                      type="checkbox"
                      name="terms"
                      checked={checked}
                      accentColor={backgroundColor}
                    />
                    <span
                      className={`status-indicator status-${status}`}
                    ></span>
                    I agree to the terms and conditions
                  </label>
                </div>
              </div>
              <div className="button-group">
                <Button type="submit">Submit Form</Button>
                <button
                  type="button"
                  onClick={() => {
                    ref.current.dispatchEvent(
                      new CustomEvent("setuistate", {
                        detail: { value: true },
                      }),
                    );
                  }}
                >
                  Accept Terms
                </button>
                <button
                  type="button"
                  onClick={() => {
                    ref.current.dispatchEvent(
                      new CustomEvent("setuistate", {
                        detail: { value: false },
                      }),
                    );
                  }}
                >
                  Decline Terms
                </button>
              </div>
            </Form>
            <div
              className={`result-display ${status === "loading" ? "result-loading" : status === "success" ? "result-success" : status === "error" ? "result-error" : ""}`}
            >
              Terms agreed: {checked ? "Yes" : "No"}
              <br />
              {result ||
                "Fill out the form - frontend will simulate backend submission rejected when terms not agreed..."}
            </div>
          </div>
        );
      };

      render(<App />, document.querySelector("#root"));
    </script>
  </body>
</html>
