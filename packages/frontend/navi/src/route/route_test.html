<!doctype html>
<html>
  <head>
    <title>Route Test</title>
    <meta charset="utf-8" />
    <link rel="icon" href="data:," />
    <style>
      body { font-family: Arial, sans-serif; padding: 20px; }
      .nav { margin-bottom: 20px; }
      .nav a { margin-right: 10px; padding: 5px 10px; background: #f0f0f0; text-decoration: none; border-radius: 3px; }
      .nav a.active { background: #007acc; color: white; }
      .route-wrapper { border: 1px solid #ccc; padding: 10px; margin: 10px 0; border-radius: 5px; }
      .debug { background: #f9f9f9; padding: 10px; margin: 10px 0; border-left: 3px solid #333; }
    </style>
  </head>

  <body>
    <div id="app"></div>
    <script type="module" jsenv-type="module/jsx">
      import { render } from "preact";
      import { useState, useContext } from "preact/hooks";
      import { createContext } from "preact";

      // Mock simplified version of route system for testing
      const RouteComponentContext = createContext();

      // Mock current URL state
      const [currentUrl, setCurrentUrl] = useState(window.location.hash || "#/");

      // Mock route objects
      const HOME_ROUTE = { path: "/", matches: () => currentUrl === "#/" };
      const LOGIN_ROUTE = { path: "/login", matches: () => currentUrl === "#/login" };
      const FORGOT_PASSWORD_ROUTE = { path: "/forgot", matches: () => currentUrl === "#/forgot" };
      const PROFILE_ROUTE = { path: "/profile", matches: () => currentUrl === "#/profile" };

      // Mock useRouteStatus hook
      const useRouteStatus = (route) => {
        return { 
          active: route.matches(), 
          url: route.matches() ? currentUrl : null 
        };
      };

      // Route component implementation
      const Route = ({ route, children }) => {
        if (!route) {
          return <WithoutRoute>{children}</WithoutRoute>;
        }
        return <WithRoute route={route}>{children}</WithRoute>;
      };

      const WithRoute = ({ route, children }) => {
        const RouteComponent = useContext(RouteComponentContext);

        if (RouteComponent && route) {
          RouteComponent.registerChildRoute(route);
        }

        const { active } = useRouteStatus(route);

        return (
          <RouteComponentContext.Provider value={route}>
            {active ? children : null}
          </RouteComponentContext.Provider>
        );
      };

      const WithoutRoute = ({ children }) => {
        const [discoveredRoutes, setDiscoveredRoutes] = useState(new Set());
        
        const registerChildRoute = (route) => {
          setDiscoveredRoutes((prevRoutes) => {
            const newRoutes = new Set(prevRoutes);
            if (!newRoutes.has(route)) {
              newRoutes.add(route);
            }
            return newRoutes;
          });
        };

        // Check if any discovered route is currently active
        const activeRoutes = Array.from(discoveredRoutes).filter(route => {
          const { active } = useRouteStatus(route);
          return active;
        });

        const shouldRender = discoveredRoutes.size === 0 || activeRoutes.length > 0;

        return (
          <RouteComponentContext.Provider value={{ registerChildRoute }}>
            {shouldRender ? children : null}
          </RouteComponentContext.Provider>
        );
      };

      // Test App
      const App = () => {
        const [url, setUrl] = useState(currentUrl);

        const navigate = (newUrl) => {
          setUrl(newUrl);
          setCurrentUrl(newUrl);
          window.location.hash = newUrl;
        };

        return (
          <div>
            <h1>Route System Test</h1>
            
            {/* Navigation */}
            <div className="nav">
              <a 
                href="#" 
                className={url === "#/" ? "active" : ""}
                onClick={(e) => { e.preventDefault(); navigate("#/"); }}
              >
                Home
              </a>
              <a 
                href="#" 
                className={url === "#/login" ? "active" : ""}
                onClick={(e) => { e.preventDefault(); navigate("#/login"); }}
              >
                Login
              </a>
              <a 
                href="#" 
                className={url === "#/forgot" ? "active" : ""}
                onClick={(e) => { e.preventDefault(); navigate("#/forgot"); }}
              >
                Forgot Password
              </a>
              <a 
                href="#" 
                className={url === "#/profile" ? "active" : ""}
                onClick={(e) => { e.preventDefault(); navigate("#/profile"); }}
              >
                Profile
              </a>
            </div>

            <div className="debug">
              <strong>Current URL:</strong> {url}
            </div>

            {/* Test Cases */}
            <h2>Test Case 1: Simple Routes</h2>
            <div className="route-wrapper">
              <Route route={HOME_ROUTE}>
                <h3>üè† Homepage Content</h3>
                <p>This is the homepage!</p>
              </Route>
              
              <Route route={PROFILE_ROUTE}>
                <h3>üë§ Profile Content</h3>
                <p>This is the profile page!</p>
              </Route>
            </div>

            <h2>Test Case 2: Route Without Route Prop (Wrapper)</h2>
            <div className="route-wrapper">
              <Route>
                <div style="background: #e6f3ff; padding: 15px; border-radius: 5px;">
                  <h3>üîê Auth Section</h3>
                  <p>This wrapper should only render when one of the auth routes is active:</p>
                  
                  <Route route={LOGIN_ROUTE}>
                    <div style="background: #fff; padding: 10px; margin: 10px 0; border: 1px solid #ddd;">
                      <h4>Login Form</h4>
                      <p>Enter your credentials here</p>
                    </div>
                  </Route>
                  
                  <Route route={FORGOT_PASSWORD_ROUTE}>
                    <div style="background: #fff; padding: 10px; margin: 10px 0; border: 1px solid #ddd;">
                      <h4>Password Reset</h4>
                      <p>Reset your password here</p>
                    </div>
                  </Route>
                  
                  <p><em>End of auth section</em></p>
                </div>
              </Route>
            </div>

            <h2>Expected Behavior</h2>
            <ul>
              <li><strong>Home (#/):</strong> Only homepage content visible</li>
              <li><strong>Login (#/login):</strong> Auth section wrapper + login form visible</li>
              <li><strong>Forgot (#/forgot):</strong> Auth section wrapper + forgot password form visible</li>
              <li><strong>Profile (#/profile):</strong> Only profile content visible</li>
            </ul>
          </div>
        );
      };

      render(<App />, document.getElementById("app"));
    </script>
  </body>
</html>