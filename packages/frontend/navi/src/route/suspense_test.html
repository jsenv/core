<!doctype html>
<html>
  <head>
    <title>Suspense test</title>
    <meta charset="utf-8" />
    <link rel="icon" href="data:," />
  </head>

  <body>
    <div id="app"></div>
    <script type="module" jsenv-type="module/jsx">
      /* eslint-disable no-unused-vars */
      import { render } from "preact";
      import { Suspense } from "preact/compat";
      import { useState, useRef } from "preact/hooks";

      const App = () => {
        return (
          <div>
            <h1>Suspense Test</h1>
            <Suspense fallback={<div>Loading...</div>}>
              <Child />
              <p>Content below Suspense.</p>
            </Suspense>
          </div>
        );
      };

      // This pattern is based on Preact's official test examples
      const Child = () => {
        const promiseRef = useRef(null);

        // Create the promise only once and store it in ref
        if (!promiseRef.current) {
          promiseRef.current = new Promise((resolve) => {
            setTimeout(() => {
              resolve();
            }, 300);
          });
        }

        use(promiseRef.current);

        // If resolved, render the content
        return <div>This is content inside Suspense.</div>;
      };

      const use = (promise) => {
        let prom;
        let settled;
        let rejected;
        let rejectReason;

        const promiseRef = useRef(null);
        if (!promiseRef.current) {
          promise.then(
            (v) => {
              settled = true;
            },
            (e) => {
              rejectReason = e;
              settled = true;
              rejected = true;
            },
          );

          if (rejected) {
            throw rejectReason;
          }
          if (!settled) {
            throw promise;
          }
        }
      };

      render(<App />, document.getElementById("app"));
    </script>
  </body>
</html>
