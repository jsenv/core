<!doctype html>
<html>
  <head>
    <title>Suspense test</title>
    <meta charset="utf-8" />
    <link rel="icon" href="data:," />
  </head>

  <body>
    <div id="app"></div>
    <script type="module" jsenv-type="module/jsx">
      /* eslint-disable no-unused-vars */
      import { render } from "preact";
      import { Suspense } from "preact/compat";
      import { useState, useRef } from "preact/hooks";

      const App = () => {
        return (
          <div>
            <h1>Suspense Test</h1>
            <Suspense fallback={<div>Loading...</div>}>
              <Child />
              <p>Content below Suspense.</p>
            </Suspense>
          </div>
        );
      };

      const promise = new Promise((r) => {
        setTimeout(r, 300);
      });

      // This pattern is based on Preact's official test examples
      const Child = () => {
        console.debug("Child component rendering");

        console.debug("About to call use()");
        const result = use(promise);
        console.debug("use() returned:", result);

        // If resolved, render the content
        console.debug("Rendering content");
        return <div>This is content inside Suspense.</div>;
      };
      const use = (promise) => {
        console.debug("use() called");

        const settledRef = useRef(false);
        const rejectedRef = useRef(false);
        const valueRef = useRef(null);
        const reasonRef = useRef(null);
        const promiseTrackedRef = useRef(null);

        if (!promiseTrackedRef.current) {
          promiseTrackedRef.current = true;
          console.debug("Creating new promise tracking");
          promise.then(
            (v) => {
              console.debug("Promise resolved with value:", v);
              settledRef.current = true;
              valueRef.current = true;
            },
            (e) => {
              console.debug("Promise rejected with error:", e);
              reasonRef.current = e;
              settledRef.current = true;
              rejectedRef.current = true;
            },
          );
        }

        if (!settledRef.current) {
          throw promise;
        }

        if (!rejectedRef.current) {
          console.debug("Promise not settled, throwing promise");
          throw reasonRef.current;
        }

        console.debug("Promise settled, returning value:", valueRef.current);
        return valueRef.current;
      };

      render(<App />, document.getElementById("app"));
    </script>
  </body>
</html>
