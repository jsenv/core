<!doctype html>
<html>
  <head>
    <title>Suspense test</title>
    <meta charset="utf-8" />
    <link rel="icon" href="data:," />
  </head>

  <body>
    <div id="app"></div>
    <script type="module" jsenv-type="module/jsx">
      /* eslint-disable no-unused-vars */
      import { render } from "preact";
      import { Suspense } from "preact/compat";
      import { useState, useRef } from "preact/hooks";

      const App = () => {
        return (
          <div>
            <h1>Suspense Test</h1>
            <Suspense fallback={<div>Loading...</div>}>
              <Child />
              <p>Content below Suspense.</p>
            </Suspense>
          </div>
        );
      };

      // Create a use(promise) hook following the official Preact pattern
      function use(promise) {
        // We need to track promise state per promise instance
        // Use a WeakMap to associate state with each promise
        if (!use._promiseStates) {
          use._promiseStates = new WeakMap();
        }

        let state = use._promiseStates.get(promise);

        if (!state) {
          // Initialize state for this promise
          state = { data: null, error: null, settled: false };
          use._promiseStates.set(promise, state);

          // Set up promise resolution
          promise.then(
            (data) => {
              state.data = data;
              state.settled = true;
            },
            (error) => {
              state.error = error;
              state.settled = true;
            },
          );
        }

        if (state.error) {
          throw state.error;
        }

        if (!state.settled) {
          throw promise;
        }

        return state.data;
      }

      // Create the second promise OUTSIDE the component to avoid recreating it
      const promise2 = new Promise((resolve) => {
        setTimeout(() => {
          resolve("Hook data loaded!");
        }, 500);
      });

      // Test both approaches
      const Child = () => {
        // Test 2: Using the use(promise) hook
        const result2 = use(promise2);

        // If both resolved, render the content
        return (
          <div>
            <div>Use Hook: {result2}</div>
          </div>
        );
      };
      render(<App />, document.getElementById("app"));
    </script>
  </body>
</html>
