<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <link rel="icon" href="data:," />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Action demo 2</title>
  </head>
  <body>
    <div id="root" style="position: relative; width: 400px"></div>

    <script type="module" jsenv-type="module/jsx">
      /**
       * Ici on test une action ayant un param qui est lu dans le local storage
       * On peut utiliser deux actions dérivées pour charger deux users différents
       * on peut aussi savoir qui est l'utilisateur courant
       */

      import { render } from "preact";
      import { effect } from "@preact/signals";
      import {
        useActionStatus,
        resource,
        getItemAction,
        // eslint-disable-next-line no-unused-vars
        ActionRenderer,
      } from "@jsenv/navi";
      import {
        // eslint-disable-next-line no-unused-vars
        ActionStatus,
      } from "./action_status.jsx";

      const user = resource("user", { idKey: "name" });
      // const useActiveUser = user.useActiveItem;
      const loadUsersAction = user.getAll(() => {
        return [{ name: "dam" }, { name: "seb" }, { name: "john" }];
      });

      const loadUserActionTemplate = user.get(({ name }) => {
        return { name, greeting: `Hello ${name}` };
      });

      const [activeUserSignal, setActiveUser] = user.useItemSignal(
        localStorage.getItem("active_user_name"),
      );
      effect(() => {
        const activeUser = activeUserSignal.value;
        if (activeUser) {
          localStorage.setItem("active_user_name", activeUser.name);
        } else {
          localStorage.removeItem("active_user_name");
        }
      });

      const activeUserActionSignal =
        loadUserActionTemplate.actionSignalFromItemSignal(activeUserSignal, {
          autoload: true,
        });

      loadUsersAction.load();

      // eslint-disable-next-line no-unused-vars
      const App = () => {
        const { data: users } = useActionStatus(loadUsersAction);

        const [dam, seb, john] = users;
        const damUserAction = getItemAction(dam, loadUserActionTemplate);
        const sebUserAction = getItemAction(seb, loadUserActionTemplate);
        const johnUserAction = getItemAction(john, loadUserActionTemplate);
        const activeUserAction = activeUserActionSignal.value;

        return (
          <div>
            <button
              onClick={() => {
                setActiveUser(dam);
                damUserAction.reload();
              }}
            >
              Load dam
            </button>
            <button
              onClick={() => {
                damUserAction.unload();
              }}
            >
              Unload dam
            </button>
            <button
              onClick={() => {
                damUserAction.preload();
              }}
            >
              Preload dam
            </button>
            <br />
            <button
              onClick={() => {
                setActiveUser(seb);
                sebUserAction.reload();
              }}
            >
              Load seb
            </button>
            <button
              onClick={() => {
                sebUserAction.unload();
              }}
            >
              Unload seb
            </button>
            <button
              onClick={() => {
                sebUserAction.preload();
              }}
            >
              Preload seb
            </button>
            <br />
            <button
              onClick={() => {
                setActiveUser(john);
                johnUserAction.reload();
              }}
            >
              Load john
            </button>
            <button
              onClick={() => {
                johnUserAction.unload();
              }}
            >
              Unload john
            </button>
            <button
              onClick={() => {
                johnUserAction.preload();
              }}
            >
              Preload john
            </button>

            <ActionStatus action={damUserAction} />
            <ActionStatus action={sebUserAction} />
            <ActionStatus action={johnUserAction} />
            <ActionStatus action={activeUserAction} name="get user: active" />

            <ActionRenderer action={activeUserAction}>
              {{
                loading: () => <div>Loading user...</div>,
                error: (error) => <div>Error: {error.message}</div>,
                unloaded: () => <div>User not loaded</div>,
                loaded: (user) => {
                  return <div>{user.greeting}</div>;
                },
              }}
            </ActionRenderer>
          </div>
        );
      };

      render(<App />, document.querySelector("#root"));
    </script>
  </body>
</html>
