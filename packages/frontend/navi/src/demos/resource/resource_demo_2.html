<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <link rel="icon" href="data:," />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Action demo 2</title>
  </head>
  <body>
    <div id="root" style="position: relative; width: 400px"></div>

    <script type="module" jsenv-type="module/jsx">
      /**
       * Ici on test une action ayant un param qui est lu dans le local storage
       * On peut utiliser deux actions dérivées pour charger deux users différents
       * on peut aussi savoir qui est l'utilisateur courant
       */

      import { render } from "preact";
      import { useActionStatus, resource, getItemAction } from "@jsenv/navi";
      import {
        // eslint-disable-next-line no-unused-vars
        ActionStatus,
      } from "./action_status.jsx";

      const user = resource("user", { idKey: "name" });
      const loadUsersAction = user.getAll(() => {
        return [{ name: "dam" }, { name: "seb" }, { name: "john" }];
      });
      const loadUserAction = user.get(
        ({ name }) => {
          return { name, greeting: `Hello ${name}` };
        },
        {
          sideEffect: ({ name }) => {
            localStorage.setItem("current_user_name", name);
            return () => {
              localStorage.removeItem("current_user_name");
            };
          },
          autoload: () => {
            const currentUserName = localStorage.getItem("current_user_name");
            if (currentUserName) {
              return { name: currentUserName };
            }
            return null;
          },
        },
      );

      loadUsersAction.load();

      // eslint-disable-next-line no-unused-vars
      const App = () => {
        const { data: user } = useActionStatus(loadUserAction);
        const { data: users } = useActionStatus(loadUsersAction);

        const [dam, seb, john] = users;
        const damUserAction = getItemAction(dam, loadUserAction);
        const sebUserAction = getItemAction(seb, loadUserAction);
        const johnUserAction = getItemAction(john, loadUserAction);

        return (
          <div>
            <button
              onClick={() => {
                damUserAction.load();
              }}
            >
              Load dam
            </button>
            <button
              onClick={() => {
                damUserAction.unload();
              }}
            >
              Unload dam
            </button>
            <button
              onClick={() => {
                damUserAction.preload();
              }}
            >
              Preload dam
            </button>
            <br />
            <button
              onClick={() => {
                sebUserAction.load();
              }}
            >
              Load seb
            </button>
            <button
              onClick={() => {
                sebUserAction.unload();
              }}
            >
              Unload seb
            </button>
            <button
              onClick={() => {
                sebUserAction.preload();
              }}
            >
              Preload seb
            </button>
            <br />
            <button
              onClick={() => {
                johnUserAction.load();
              }}
            >
              Load john
            </button>
            <button
              onClick={() => {
                johnUserAction.unload();
              }}
            >
              Unload john
            </button>
            <button
              onClick={() => {
                johnUserAction.preload();
              }}
            >
              Preload john
            </button>

            <ActionStatus action={loadUserAction} />
            <ActionStatus action={damUserAction} />
            <ActionStatus action={sebUserAction} />
            <ActionStatus action={johnUserAction} />

            <div>User: {JSON.stringify(user)}</div>
          </div>
        );
      };

      render(<App />, document.querySelector("#root"));
    </script>
  </body>
</html>
