<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <link rel="icon" href="data:," />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Resource demo describe one</title>
  </head>
  <body>
    <div id="root" style="position: relative; width: 600px"></div>

    <script type="module" jsenv-type="module/jsx">
      import { render } from "preact";
      import { useState, useEffect, useRef } from "preact/hooks";
      import {
        resource,
        // eslint-disable-next-line no-unused-vars
        ActionRenderer,
      } from "@jsenv/navi";
      import {
        // eslint-disable-next-line no-unused-vars
        ActionStatus,
      } from "./action_status.jsx";
      import { localStorageSignal } from "../../local_storage_signal.js";

      const tables = [
        { id: 1, name: "table_1", owner: { id: 1 } },
        { id: 2, name: "table_2", owner: { id: 2 } },
      ];
      const users = [
        { id: 1, name: "User 1" },
        { id: 2, name: "User 2" },
      ];

      const user = resource("user", { idKey: "id", mutableIdKey: "name" });
      const table = resource("table", { idKey: "id", mutableIdKey: "name" });
      const { owner: tableOwner } = table.describe({
        owner: user,
      });

      // Actions pour récupérer les données
      const getTableAction = table.get(({ name }) => {
        return tables.find((table) => table.name === name) || null;
      });
      const getManyTableAction = table.getMany(() => {
        return tables;
      });
      const getManyUserAction = user.getMany(() => {
        return users;
      });
      const renameUserAction = user.put(({ name, newName }) => {
        let userToUpdate = users.find((u) => u.name === name);
        const id = userToUpdate.id;
        userToUpdate.name = newName;
        return { id, name: newName };
      });

      // ✅ NEW: Action to update table owner
      const updateTableOwnerAction = table.put(({ tableId, newOwnerId }) => {
        const newOwner = users.find((u) => u.id === newOwnerId);
        const tableToUpdate = tables.find((t) => t.id === tableId);
        tableToUpdate.owner = newOwner;
        return {
          id: tableId,
          owner: newOwner,
        };
      });

      const getTableOwnerAction = tableOwner.get(async ({ owner }) => {
        const user = users.find((user) => user.id === owner.id) || null;
        return user;
      });

      // Signal pour la table courante
      const currentTableNameSignal = localStorageSignal("current_table_name");
      const currentTableAction = getTableAction.bindParams({
        name: currentTableNameSignal,
      });
      if (currentTableNameSignal.value) {
        currentTableAction.load();
      }

      // Load initial data
      getManyTableAction.load();
      getManyUserAction.load();

      // eslint-disable-next-line no-unused-vars
      const App = () => {
        return (
          <div style={{ display: "flex", gap: "20px" }}>
            <div style={{ flex: 1 }}>
              <h2>Tables</h2>
              <TablesList />

              <h2>Current Table</h2>
              <CurrentTable />
            </div>

            <div style={{ flex: 1 }}>
              <h2>Users</h2>
              <UsersList />
            </div>
          </div>
        );
      };

      // eslint-disable-next-line no-unused-vars
      const TablesList = () => {
        return (
          <ActionRenderer action={getManyTableAction}>
            {(tables) => (
              <div>
                {tables.map((table) => (
                  <TableItem key={table.id} table={table} />
                ))}
              </div>
            )}
          </ActionRenderer>
        );
      };

      // eslint-disable-next-line no-unused-vars
      const TableItem = ({ table }) => {
        const [isEditing, setIsEditing] = useState(false);
        const [editName, setEditName] = useState(table.name);
        // ✅ NEW: State for editing owner
        const [isEditingOwner, setIsEditingOwner] = useState(false);
        const [editOwnerId, setEditOwnerId] = useState(table.owner.id);

        const handleSave = () => {
          table.name = editName;
          setIsEditing(false);
        };

        const handleCancel = () => {
          setEditName(table.name);
          setIsEditing(false);
        };

        // ✅ NEW: Handle owner update
        const handleOwnerSave = async () => {
          await updateTableOwnerAction
            .bindParams({ tableId: table.id, newOwnerId: editOwnerId })
            .reload();
          setIsEditingOwner(false);
        };

        const handleOwnerCancel = () => {
          setEditOwnerId(table.owner.id);
          setIsEditingOwner(false);
        };

        const inputRef = useRef();
        useEffect(() => {
          if (isEditing) {
            inputRef.current.focus();
            inputRef.current.select();
          }
        }, [isEditing]);

        // ✅ Get current owner name for display
        const currentOwner = users.find((u) => u.id === table.owner.id);

        return (
          <div
            style={{
              border: "1px solid #ccc",
              padding: "10px",
              margin: "5px 0",
              backgroundColor:
                currentTableNameSignal.value === table.name
                  ? "#e6f3ff"
                  : "white",
            }}
          >
            <div style={{ display: "flex", alignItems: "center", gap: "10px" }}>
              {isEditing ? (
                <>
                  <input
                    ref={inputRef}
                    value={editName}
                    onChange={(e) => setEditName(e.target.value)}
                    style={{ flex: 1 }}
                  />
                  <button onClick={handleSave}>Save</button>
                  <button onClick={handleCancel}>Cancel</button>
                </>
              ) : (
                <>
                  <strong style={{ flex: 1 }}>{table.name}</strong>
                  <button onClick={() => setIsEditing(true)}>Rename</button>
                  <button
                    onClick={() => {
                      currentTableNameSignal.value = table.name;
                      currentTableAction.reload();
                    }}
                    disabled={currentTableNameSignal.value === table.name}
                  >
                    Select
                  </button>
                </>
              )}
            </div>

            {/* ✅ NEW: Owner editing section */}
            <div style={{ marginTop: "10px", fontSize: "12px", color: "#666" }}>
              <div
                style={{ display: "flex", alignItems: "center", gap: "10px" }}
              >
                {isEditingOwner ? (
                  <>
                    <span>Owner:</span>
                    <select
                      value={editOwnerId}
                      onChange={(e) => setEditOwnerId(parseInt(e.target.value))}
                      style={{ fontSize: "12px" }}
                    >
                      {users.map((user) => (
                        <option key={user.id} value={user.id}>
                          {user.name}
                        </option>
                      ))}
                    </select>
                    <button
                      onClick={handleOwnerSave}
                      style={{ fontSize: "10px", padding: "2px 6px" }}
                    >
                      Save
                    </button>
                    <button
                      onClick={handleOwnerCancel}
                      style={{ fontSize: "10px", padding: "2px 6px" }}
                    >
                      Cancel
                    </button>
                  </>
                ) : (
                  <>
                    <span>Owner: {currentOwner?.name || "Unknown"}</span>
                    <button
                      onClick={() => {
                        setEditOwnerId(table.owner.id);
                        setIsEditingOwner(true);
                      }}
                      style={{ fontSize: "10px", padding: "2px 6px" }}
                    >
                      Change Owner
                    </button>
                  </>
                )}
              </div>
            </div>
          </div>
        );
      };

      // eslint-disable-next-line no-unused-vars
      const CurrentTable = () => {
        if (!currentTableNameSignal.value) {
          return <p>No table selected</p>;
        }

        return (
          <div>
            <ActionStatus action={currentTableAction} />
            <ActionRenderer action={currentTableAction}>
              {(table) => <TableDetails table={table} />}
            </ActionRenderer>
          </div>
        );
      };

      // eslint-disable-next-line no-unused-vars
      const TableDetails = ({ table }) => {
        const getTableOwner = getTableOwnerAction.bindParams({
          owner: table.owner,
        });
        // const { idle } = useActionStatus(getTableOwner);

        return (
          <div style={{ border: "2px solid #007acc", padding: "15px" }}>
            <h3>{table.name}</h3>
            <p>ID: {table.id}</p>

            <details
              onToggle={(e) => {
                if (e.target.open) {
                  getTableOwner.load();
                } else {
                  getTableOwner.abort();
                }
              }}
            >
              <summary>Owner Details</summary>
              <ActionRenderer action={getTableOwner}>
                {(owner) => (
                  <div
                    style={{
                      marginTop: "10px",
                      padding: "10px",
                      backgroundColor: "#f0f0f0",
                    }}
                  >
                    <p>
                      <strong>Owner:</strong> {owner.name}
                    </p>
                    <p>
                      <strong>Owner ID:</strong> {owner.id}
                    </p>
                  </div>
                )}
              </ActionRenderer>
            </details>
          </div>
        );
      };

      // eslint-disable-next-line no-unused-vars
      const UsersList = () => {
        return (
          <ActionRenderer action={getManyUserAction}>
            {(users) => (
              <div>
                {users.map((user) => (
                  <UserItem key={user.id} user={user} />
                ))}
              </div>
            )}
          </ActionRenderer>
        );
      };

      // eslint-disable-next-line no-unused-vars
      const UserItem = ({ user }) => {
        const [isEditing, setIsEditing] = useState(false);
        const [editName, setEditName] = useState(user.name);

        const handleSave = async () => {
          await renameUserAction
            .bindParams({ name: user.name, newName: editName })
            .load();
          setIsEditing(false);
        };

        const handleCancel = () => {
          setEditName(user.name);
          setIsEditing(false);
        };

        const inputRef = useRef();
        useEffect(() => {
          if (isEditing) {
            inputRef.current.focus();
            inputRef.current.select();
          }
        }, [isEditing]);

        // Compter combien de tables appartiennent à cet utilisateur
        const userTables = tables.filter((table) => table.owner.id === user.id);

        return (
          <div
            style={{
              border: "1px solid #ccc",
              padding: "10px",
              margin: "5px 0",
              backgroundColor: "#f9f9f9",
            }}
          >
            <div style={{ display: "flex", alignItems: "center", gap: "10px" }}>
              {isEditing ? (
                <>
                  <input
                    ref={inputRef}
                    value={editName}
                    onChange={(e) => setEditName(e.target.value)}
                    style={{ flex: 1 }}
                  />
                  <button onClick={handleSave}>Save</button>
                  <button onClick={handleCancel}>Cancel</button>
                </>
              ) : (
                <>
                  <strong style={{ flex: 1 }}>{user.name}</strong>
                  <button onClick={() => setIsEditing(true)}>Rename</button>
                </>
              )}
            </div>

            <div style={{ marginTop: "10px", fontSize: "12px", color: "#666" }}>
              ID: {user.id} | Tables owned: {userTables.length}
              {userTables.length > 0 && (
                <span> ({userTables.map((t) => t.name).join(", ")})</span>
              )}
            </div>
          </div>
        );
      };

      render(<App />, document.querySelector("#root"));
    </script>
  </body>
</html>
