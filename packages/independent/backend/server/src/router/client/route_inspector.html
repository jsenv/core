<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Route inspector</title>
    <script type="importmap">
      {
        "imports": {
          "preact": "https://esm.sh/preact@10.23.1",
          "preact/": "https://esm.sh/preact@10.23.1/",
          "@preact/signals": "https://esm.sh/@preact/signals@1.3.0?external=preact",
          "htm/preact": "https://esm.sh/htm@3.1.1/preact?external=preact"
        }
      }
    </script>
  </head>
  <body>
    <div id="app"></div>
    <script type="module">
      import { render } from "preact";
      import { html } from "htm/preact";

      export function App() {
        return html`<h1>Hello, World!</h1>`;
      }

      render(html`<${App} />`, document.getElementById("app"));
    </script>

    <script>
      const autoreloadOnServerReconnect = async () => {
        const connect = () => {
          const websocket = new WebSocket(websocketUrl, ["jsenv_server"]);
          const connectedPromise = new Promise((resolve) => {
            websocket.onerror = () => {
              resolve(null);
            };
            websocket.onopen = () => {
              resolve(websocket);
            };
          });
          return connectedPromise;
        };

        const websocketScheme =
          self.location.protocol === "https:" ? "wss" : "ws";
        const websocketUrl = `${websocketScheme}://${self.location.host}${self.location.pathname}${self.location.search}`;
        const initialWebSocket = await connect();
        initialWebSocket.onclose = async () => {
          console.info("connection to server lost, trying to reconnect");
          let attemptCount = 0;
          const tryToReconnect = async () => {
            const newWebsocket = await connect();
            if (newWebsocket) {
              console.info("reconnected to server, reloading the page...");
              window.location.reload(true);
              return;
            }
            attemptCount++;
            if (attemptCount === 5) {
              console.info("failed to reconnect to server");
              return;
            }
            // retry after a delay
            await new Promise((resolve) => setTimeout(resolve, 200));
            await tryToReconnect();
          };
          await tryToReconnect();
        };
      };
      autoreloadOnServerReconnect();
    </script>
  </body>
</html>
