<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Route inspector</title>
    <script type="importmap">
      {
        "imports": {
          "preact": "https://esm.sh/preact@10.23.1",
          "preact/": "https://esm.sh/preact@10.23.1/",
          "@preact/signals": "https://esm.sh/@preact/signals@1.3.0?external=preact",
          "htm/preact": "https://esm.sh/htm@3.1.1/preact?external=preact"
        }
      }
    </script>
    <script src="/@jsenv/server/src/services/route_inspector/client/code_block.js?inline"></script>
    <script src="/@jsenv/server/src/services/autoreload_on_server_restart/client/autoreload_on_server_restart.js?inline"></script>
  </head>
  <body>
    <div class="container">
      <div class="header-row">
        <h1 style="margin: 0">Route inspector</h1>
        <div class="theme-toggle">
          <button id="theme-toggle-btn" aria-label="Toggle dark/light mode">
            <svg
              class="sun-icon"
              xmlns="http://www.w3.org/2000/svg"
              height="24"
              viewBox="0 -960 960 960"
              width="24"
            >
              <path
                d="M480-360q50 0 85-35t35-85q0-50-35-85t-85-35q-50 0-85 35t-35 85q0 50 35 85t85 35Zm0 80q-83 0-141.5-58.5T280-480q0-83 58.5-141.5T480-680q83 0 141.5 58.5T680-480q0 83-58.5 141.5T480-280ZM80-440q0 17 11.5 28.5T120-400h80q17 0 28.5-11.5T240-440q0-17-11.5-28.5T200-480h-80q-17 0-28.5 11.5T80-440Zm680 0q0 17 11.5 28.5T800-400h80q17 0 28.5-11.5T920-440q0-17-11.5-28.5T880-480h-80q-17 0-28.5 11.5T760-440ZM440-760q0 17 11.5 28.5T480-720q17 0 28.5-11.5T520-760v-80q0-17-11.5-28.5T480-880q-17 0-28.5 11.5T440-840v80Zm0 680q0 17 11.5 28.5T480-40q17 0 28.5-11.5T520-80v-80q0-17-11.5-28.5T480-200q-17 0-28.5 11.5T440-160v80ZM226-678l56 56q12 12 28.5 12t28.5-12q12-12 12-28.5T339-679l-56-56q-12-12-28.5-12T226-735q-12 12-12 28.5t12 28.5Zm452 452 56 56q12 12 28.5 12t28.5-12q12-12 12-28.5T791-227l-56-56q-12-12-28.5-12T678-283q-12 12-12 28.5t12 28.5ZM791-678q12 12 28.5 12t28.5-12q12-12 12-28.5T848-735l-56-56q-12-12-28.5-12T735-791q-12 12-12 28.5t12 28.5l56 56Zm-508 452q12 12 28.5 12t28.5-12q12-12 12-28.5T340-283l-56-56q-12-12-28.5-12T227-339q-12 12-12 28.5t12 28.5l56 56Z"
              />
            </svg>
            <svg
              class="moon-icon"
              xmlns="http://www.w3.org/2000/svg"
              height="24"
              viewBox="0 -960 960 960"
              width="24"
            >
              <path
                d="M480-120q-150 0-255-105T120-480q0-150 105-255t255-105q8 0 17 .5t23 1.5q-36 32-56 79t-20 99q0 83 58.5 141.5T643-460q52 0 99-20t79-56q1 14 1.5 23t.5 17q0 150-105 255T480-120Zm0-80q88 0 158-48.5T740-375q-20 5-40 8t-40 3q-123 0-209.5-86.5T364-660q0-20 3-40t8-40q-78 32-126.5 102T200-480q0 116 82 198t198 82Zm-10-270Z"
              />
            </svg>
          </button>
        </div>
      </div>
      <div class="note">
        <strong>Note:</strong> This page displays all routes configured in your
        server. Every GET route also automatically supports HEAD requests
        without additional configuration.
      </div>
      <div id="app"></div>
    </div>
    <style>
      :root {
        --background-color: #fff;
        --text-color: #333;
        --border-color: #e0e0e0;
        --primary-color: #1976d2;
        --secondary-color: #f5f5f5;
        --success-color: #4caf50;
        --warning-color: #ff9800;
        --method-get-color: #61affe;
        --method-post-color: #49cc90;
        --method-put-color: #ff9800;
        --method-delete-color: #f44336;
        --method-patch-color: #9c27b0;
        --method-options-color: #607d8b;
        --method-head-color: #00bcd4;
      }

      :root[data-theme="light"] {
        --background-color: #fff;
        --text-color: #333;
        --border-color: #e0e0e0;
        --primary-color: #1976d2;
        --secondary-color: #f5f5f5;
      }
      :root[data-theme="dark"] {
        --background-color: #121212;
        --text-color: #e0e0e0;
        --border-color: #333;
        --primary-color: #4f9eff;
        --secondary-color: #1e1e1e;
      }

      body {
        font-family:
          system-ui,
          -apple-system,
          BlinkMacSystemFont,
          "Segoe UI",
          Roboto,
          Arial,
          sans-serif;
        line-height: 1.5;
        color: var(--text-color);
        background-color: var(--background-color);
        margin: 0;
        padding: 20px;
        transition:
          background-color 0.3s ease,
          color 0.3s ease;
      }

      .container {
        max-width: 1200px;
        margin: 0 auto;
      }

      .header-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
      }

      .theme-toggle {
        display: flex;
        align-items: center;
      }

      #theme-toggle-btn {
        background: none;
        border: none;
        cursor: pointer;
        width: 40px;
        height: 40px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: background-color 0.2s;
        background-color: var(--secondary-color);
      }

      #theme-toggle-btn:hover {
        background-color: color-mix(
          in srgb,
          var(--primary-color) 15%,
          transparent
        );
      }

      #theme-toggle-btn svg {
        fill: var(--text-color);
      }

      .sun-icon {
        display: none;
      }
      .moon-icon {
        display: none;
      }
      :root[data-theme="dark"] .sun-icon {
        display: block;
      }
      :root[data-theme="light"] .moon-icon {
        display: block;
      }

      .progress-container {
        width: 100%;
        height: 100%;
        background-color: rgba(25, 118, 210, 0.2);
        border-radius: 4px;
        overflow: hidden;
        position: relative;
        margin: 20px 0;
      }
      .progress-indeterminate .progress-bar-long,
      .progress-indeterminate .progress-bar-short {
        position: absolute;
        top: 0;
        height: 100%;
        background-color: var(--primary-color);
        border-radius: 4px;
        animation-duration: 2.2s;
        animation-iteration-count: infinite;
      }

      .progress-indeterminate .progress-bar-long {
        animation-name: indeterminate-ltr;
        width: 75%;
      }

      .progress-indeterminate .progress-bar-short {
        animation-name: indeterminate-short-ltr;
        width: 20%;
      }

      @keyframes indeterminate-ltr {
        0% {
          left: -90%;
          right: 100%;
        }
        60% {
          left: -90%;
          right: 100%;
        }
        100% {
          left: 100%;
          right: -35%;
        }
      }

      @keyframes indeterminate-short-ltr {
        0% {
          left: -200%;
          right: 100%;
        }
        60% {
          left: 107%;
          right: -8%;
        }
        100% {
          left: 107%;
          right: -8%;
        }
      }

      /* Styles pour les routes */
      .auto_head_note {
        margin-top: 10px;
        font-size: 14px;
        color: var(--method-head-color);
        display: flex;
        align-items: center;
      }
      .note {
        background-color: rgba(255, 152, 0, 0.1);
        border-left: 4px solid var(--warning-color);
        padding: 12px;
        margin-bottom: 20px;
        border-radius: 4px;
      }
      .info_pill {
        display: inline-flex;
        align-items: center;
        background-color: rgba(0, 0, 0, 0.05);
        border-radius: 14px;
        padding: 4px 10px;
        font-size: 13px;
        margin-left: 10px;
      }

      .route_list {
        margin-top: 20px;
      }
      .route_details {
        margin-bottom: 8px;
        box-shadow: 0 0 3px rgba(0, 0, 0, 0.19);
        border: 1px solid #000;
        border-radius: 4px;
        margin: 0 0 15px;
        border-color: var(--method-color);
        background: color-mix(in srgb, var(--method-color), transparent 90%);
      }
      .route_details > summary {
        cursor: pointer;
        list-style: none;
      }
      .route_details > summary::marker {
        display: none;
      }
      .route_summary_container {
        display: flex;
        align-items: center;
        padding: 5px;
      }
      .route_method {
        border-radius: 3px;
        color: #fff;
        font-family: sans-serif;
        font-size: 14px;
        font-weight: 700;
        min-width: 80px;
        padding: 6px 0;
        text-align: center;
        text-shadow: 0 1px 0 rgba(0, 0, 0, 0.1);
        background: var(--method-color);
      }
      .route_resource {
        margin-left: 8px;
        font-family: monospace;
        font-size: 16px;
        font-weight: 600;
        word-break: break-word;
        margin-top: 0;
        margin-bottom: 0;
      }
      .route_details[data-method="HEAD"] {
        --method-color: var(--method-head-color);
      }
      .route_details[data-method="OPTIONS"] {
        --method-color: var(--method-options-color);
      }
      .route_details[data-method="GET"] {
        --method-color: var(--method-get-color);
      }
      .route_details[data-method="POST"] {
        --method-color: var(--method-post-color);
      }
      .route_details[data-method="PUT"] {
        --method-color: var(--method-put-color);
      }
      .route_details[data-method="PATCH"] {
        --method-color: var(--method-patch-color);
      }
      .route_details[data-method="DELETE"] {
        --method-color: var(--method-delete-color);
      }

      .route_details_content {
        border-top: 1px solid var(--method-color);
        padding: 10px;
      }
      .route_description {
        margin: 0;
      }
      .route_content_nego_title {
        font-weight: bold;
      }
    </style>
    <script>
      // Theme toggling functionality
      const toggleThemeButton = document.getElementById("theme-toggle-btn");

      // Check for saved theme preference or use system preference
      const savedTheme = localStorage.getItem("theme");
      const prefersDark = window.matchMedia(
        "(prefers-color-scheme: dark)",
      ).matches;

      // Apply theme based on saved preference or system preference
      if (savedTheme === "dark" || (savedTheme === null && prefersDark)) {
        document.documentElement.setAttribute("data-theme", "dark");
      } else {
        document.documentElement.setAttribute("data-theme", "light");
      }

      // Toggle theme when button is clicked
      toggleThemeButton.addEventListener("click", () => {
        if (document.documentElement.getAttribute("data-theme") === "dark") {
          document.documentElement.setAttribute("data-theme", "light");
          localStorage.setItem("theme", "light");
        } else {
          document.documentElement.setAttribute("data-theme", "dark");
          localStorage.setItem("theme", "dark");
        }
      });
    </script>
    <script type="module">
      // https://preactjs.com/guide/v10/no-build-workflows/
      import { render } from "preact";
      import { html } from "htm/preact";
      import { signal } from "@preact/signals";
      import { useState } from "preact/hooks";

      const routesLoadingSignal = signal(false);
      const routeLoadingError = signal(null);
      const routesSignal = signal([]);

      const loadRoutes = async () => {
        routesLoadingSignal.value = true;
        try {
          const response = await fetch("/.internal/routes.json");
          const routes = await response.json();
          routesLoadingSignal.value = false;
          routesSignal.value = routes;
        } catch (e) {
          routesLoadingSignal.value = false;
          routeLoadingError.value = e;
          throw e;
        }
      };
      loadRoutes();

      const ProgressBar = ({ width = "100%", height = 6, loading }) => {
        if (!loading) {
          return null;
        }
        return html`
          <div
            class="progress-bar"
            style=${{
              width: typeof Number(width) === "number" ? `${width}px` : width,
              height:
                typeof Number(height) === "number" ? `${height}px` : height,
            }}
          >
            <div class="progress-container progress-indeterminate">
              <div class="progress-bar-long"></div>
              <div class="progress-bar-short"></div>
            </div>
          </div>
        `;
      };

      const App = () => {
        const routes = routesSignal.value;
        const loading = routesLoadingSignal.value;

        return html`
          ${loading ? html`<p>Loading...</p>` : null}
          <${ProgressBar} width="150" loading=${loading} />
          <${RouteList} routes=${routes} />
        `;
      };
      const RouteList = ({ routes }) => {
        if (!routes || routes.length === 0) {
          return html`<p>No routes configured.</p>`;
        }

        return html`<div class="route_list">
          ${routes.map((route) => html`<${RouteDetails} ...${route} />`)}
        </div>`;
      };
      const RouteDetails = ({
        method,
        resource,
        description,
        availableContentTypes,
        availableLanguages,
        availableVersions,
        availableEncodings,
        acceptedContentTypes,
        websocket,
        clientCodeExample,
      }) => {
        const [opened, setOpened] = useState(false);

        return html`<details
          class="route_details"
          onToggle=${(e) => {
            setOpened(e.newState === "open");
          }}
          data-method=${method}
        >
          <summary>
            <div class="route_summary_container">
              <span class="route_method">${method}</span>
              <p class="route_resource">${resource}</p>
              <span style="flex:1"></span>
              ${opened ? html`<${ArrowUp} />` : html`<${ArrowDown} />`}
            </div>
          </summary>
          <${RouteDetailsContent}
            method=${method}
            resource=${resource}
            description=${description}
            availableContentTypes=${availableContentTypes}
            availableLanguages=${availableLanguages}
            availableVersions=${availableVersions}
            availableEncodings=${availableEncodings}
            acceptedContentTypes=${acceptedContentTypes}
            websocket=${websocket}
            clientCodeExample=${clientCodeExample}
          />
        </details>`;
      };

      const RouteDetailsContent = ({
        method,
        resource,
        description,
        availableContentTypes,
        availableLanguages,
        availableVersions,
        availableEncodings,
        acceptedContentTypes,
        websocket,
        clientCodeExample,
      }) => {
        return html`<div class="route_details_content">
          <p style="margin-top: 0"><strong>Description:</strong></p>
          <p class="route_description">
            ${description || "No description available"}
          </p>
          ${availableContentTypes.length > 0 &&
          html`<${RouteContentNegotiationSection}
            type="content-type"
            title="Available content types"
            availableValues=${availableContentTypes}
          />`}
          ${availableLanguages.length > 0 &&
          html`<${RouteContentNegotiationSection}
            type="language"
            title="Available languages"
            availableValues=${availableLanguages}
          />`}
          ${availableVersions.length > 0 &&
          html`<${RouteContentNegotiationSection}
            type="version"
            title="Available versions"
            availableValues=${availableVersions}
          />`}
          ${availableEncodings.length > 0 &&
          html`<${RouteContentNegotiationSection}
            type="encoding"
            title="Available encodings"
            availableValues=${availableEncodings}
          />`}
          ${acceptedContentTypes.length > 0 &&
          html`<${RouteAcceptableContentSection}
            acceptedContentTypes=${acceptedContentTypes}
          />`}
          <p style="margin-bottom:0; font-weight:bold">Example:</p>
          <${RouteCodeExample}
            method=${method}
            resource=${resource}
            availableContentTypes=${availableContentTypes}
            websocket=${websocket}
            clientCodeExample=${clientCodeExample}
          />
        </div>`;
      };
      const RouteContentNegotiationSection = ({
        type,
        title,
        availableValues,
      }) => {
        return html`<div class="route_content_nego" data-nego-type="${type}">
          <p class="route_content_nego_title">${title}:</p>
          <ul>
            ${availableValues.map(
              (availableValue) => html`<li>${availableValue}</li>`,
            )}
          </ul>
        </div>`;
      };
      const RouteAcceptableContentSection = ({ acceptedContentTypes }) => {
        return html`<div class="route_accepted_content_type">
          <p><strong>Accepted content types:</strong></p>
          <ul>
            ${acceptedContentTypes.map(
              (acceptedContentType) => html`<li>${acceptedContentType}</li>`,
            )}
          </ul>
        </div>`;
      };

      const RouteCodeExample = ({
        method,
        resource,
        availableContentTypes,
        websocket,
        clientCodeExample,
      }) => {
        let jsSource;
        if (clientCodeExample) {
          jsSource = clientCodeExample;
        } else if (websocket) {
          const websocketScheme =
            self.location.protocol === "https:" ? "wss" : "ws";
          const websocketOrigin = `${websocketScheme}://${self.location.host}`;
          jsSource = /*js */ `
const websocket = new WebSocket("${websocketOrigin}${resource}");
websocket.onerror = () => {
  console.error("Failed to connect to websocket endpoint");
};
websocket.onopen = () => {
  console.info("Connected to websocket endpoint")
};
websocket.onmessage = (event) => {
  console.log("Received message", event.data);
};
`;
        } else {
          let fetchLine;
          if (method === "GET") {
            fetchLine = `const response = await window.fetch("${resource}");`;
          } else {
            fetchLine = `const response = await window.fetch("${resource}", {
  method: "${method}",
}`;
          }
          let readResponseLine;
          if (availableContentTypes.includes("application/json")) {
            readResponseLine = `const json = await response.json();`;
          } else {
            readResponseLine = `const text = await response.text();`;
          }

          jsSource = /*js */ `
${fetchLine}
${readResponseLine}
`;
        }

        return html`<code-block lang="js" data-escaped data-copy-button
          >${jsSource}</code-block
        >`;
      };

      const ArrowDown = () => {
        return html`<svg
          xmlns="http://www.w3.org/2000/svg"
          viewBox="0 -960 960 960"
          width="24"
          height="24"
          fill="currentColor"
        >
          <path d="M480-345 240-585l56-56 184 184 184-184 56 56-240 240Z" />
        </svg>`;
      };
      const ArrowUp = () => {
        return html`<svg
          xmlns="http://www.w3.org/2000/svg"
          viewBox="0 -960 960 960"
          width="24"
          height="24"
          fill="currentColor"
        >
          <path d="M480-528 296-344l-56-56 240-240 240 240-56 56-184-184Z" />
        </svg>`;
      };

      render(html`<${App} />`, document.getElementById("app"));
    </script>
  </body>
</html>
