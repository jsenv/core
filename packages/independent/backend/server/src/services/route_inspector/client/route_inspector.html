<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Route inspector</title>
    <script type="importmap">
      {
        "imports": {
          "preact": "https://esm.sh/preact@10.23.1",
          "preact/": "https://esm.sh/preact@10.23.1/",
          "@preact/signals": "https://esm.sh/@preact/signals@1.3.0?external=preact",
          "htm/preact": "https://esm.sh/htm@3.1.1/preact?external=preact"
        }
      }
    </script>
    <script src="/@jsenv/server/src/services/route_inspector/client/code_block.js?inlin"></script>
    <script src="/@jsenv/server/src/services/autoreload_on_server_restart/client/autoreload_on_server_restart.js?inline"></script>
  </head>
  <body>
    <div id="app"></div>
    <style>
      .progress-container {
        width: 100%;
        height: 100%;
        background-color: rgba(25, 118, 210, 0.2);
        border-radius: 4px;
        overflow: hidden;
        position: relative;
        margin: 20px 0;
      }
      .progress-indeterminate .progress-bar-long,
      .progress-indeterminate .progress-bar-short {
        position: absolute;
        top: 0;
        height: 100%;
        background-color: #1976d2;
        border-radius: 4px;
        animation-duration: 2.2s;
        animation-iteration-count: infinite;
      }

      .progress-indeterminate .progress-bar-long {
        animation-name: indeterminate-ltr;
        width: 75%;
      }

      .progress-indeterminate .progress-bar-short {
        animation-name: indeterminate-short-ltr;
        width: 20%;
      }

      @keyframes indeterminate-ltr {
        0% {
          left: -90%;
          right: 100%;
        }
        60% {
          left: -90%;
          right: 100%;
        }
        100% {
          left: 100%;
          right: -35%;
        }
      }

      @keyframes indeterminate-short-ltr {
        0% {
          left: -200%;
          right: 100%;
        }
        60% {
          left: 107%;
          right: -8%;
        }
        100% {
          left: 107%;
          right: -8%;
        }
      }

      /* Styles pour les routes */
      .route_list {
        margin-top: 20px;
      }
      .route_details {
        margin-bottom: 8px;
        box-shadow: 0 0 3px rgba(0, 0, 0, 0.19);
        border: 1px solid #000;
        border-radius: 4px;
        margin: 0 0 15px;
        border-color: var(--method-color);
        background: color-mix(in srgb, var(--method-color), transparent 90%);
      }
      .route_details > summary {
        cursor: pointer;
        list-style: none;
      }
      .route_details > summary::marker {
        display: none;
      }
      .route_summary_container {
        display: flex;
        align-items: center;
        padding: 5px;
      }
      .route_method {
        border-radius: 3px;
        color: #fff;
        font-family: sans-serif;
        font-size: 14px;
        font-weight: 700;
        min-width: 80px;
        padding: 6px 0;
        text-align: center;
        text-shadow: 0 1px 0 rgba(0, 0, 0, 0.1);
        background: var(--method-color);
      }
      .route_resource {
        margin-left: 8px;
        font-family: monospace;
        font-size: 16px;
        font-weight: 600;
        word-break: break-word;
        margin-top: 0;
        margin-bottom: 0;
      }
      .route_details[data-method="GET"] {
        --method-color: #61affe;
      }
      .route_details[data-method="POST"] {
        --method-color: #49cc90;
      }
      .route_details[data-method="PUT"] {
        --method-color: #fca130;
      }
      .route_details[data-method="PATCH"] {
        --method-color: #50e3c2;
      }
      .route_details[data-method="DELETE"] {
        --method-color: #f93e3e;
      }

      .route_details_content {
        border-top: 1px solid var(--method-color);
        padding: 10px;
      }
      .route_description {
        margin: 0;
      }
      .route_content_nego_title {
        font-weight: bold;
      }
    </style>
    <script type="module">
      // https://preactjs.com/guide/v10/no-build-workflows/
      import { render } from "preact";
      import { html } from "htm/preact";
      import { signal } from "@preact/signals";
      import { useState } from "preact/hooks";

      const routesLoadingSignal = signal(false);
      const routeLoadingError = signal(null);
      const routesSignal = signal([]);

      const loadRoutes = async () => {
        routesLoadingSignal.value = true;
        try {
          const response = await fetch("/.internal/routes.json");
          const routes = await response.json();
          routesLoadingSignal.value = false;
          routesSignal.value = routes;
        } catch (e) {
          routesLoadingSignal.value = false;
          routeLoadingError.value = e;
          throw e;
        }
      };
      loadRoutes();

      const ProgressBar = ({ width = "100%", height = 6, loading }) => {
        if (!loading) {
          return null;
        }
        return html`
          <div
            class="progress-bar"
            style=${{
              width: typeof Number(width) === "number" ? `${width}px` : width,
              height:
                typeof Number(height) === "number" ? `${height}px` : height,
            }}
          >
            <div class="progress-container progress-indeterminate">
              <div class="progress-bar-long"></div>
              <div class="progress-bar-short"></div>
            </div>
          </div>
        `;
      };

      const App = () => {
        const routes = routesSignal.value;
        const loading = routesLoadingSignal.value;

        return html`
          <h1>Route inspector</h1>
          ${loading ? html`<p>Loading...</p>` : null}
          <${ProgressBar} width="150" loading=${loading} />
          <${RouteList} routes=${routes} />
        `;
      };
      const RouteList = ({ routes }) => {
        return html`<div class="route_list">
          ${routes.map((route) => html`<${RouteDetails} ...${route} />`)}
        </div>`;
      };
      const RouteDetails = ({
        method,
        resource,
        description,
        availableContentTypes,
        availableLanguages,
        availableVersions,
        availableEncodings,
        acceptedContentTypes,
        websocket,
      }) => {
        const [opened, setOpened] = useState(false);

        return html`<details
          class="route_details"
          onToggle=${(e) => {
            setOpened(e.newState === "open");
          }}
          data-method=${method}
        >
          <summary>
            <div class="route_summary_container">
              <span class="route_method">${method}</span>
              <p class="route_resource">${resource}</p>
              <span style="flex:1"></span>
              ${opened ? html`<${ArrowUp} />` : html`<${ArrowDown} />`}
            </div>
          </summary>
          <${RouteDetailsContent}
            method=${method}
            resource=${resource}
            description=${description}
            availableContentTypes=${availableContentTypes}
            availableLanguages=${availableLanguages}
            availableVersions=${availableVersions}
            availableEncodings=${availableEncodings}
            acceptedContentTypes=${acceptedContentTypes}
            websocket=${websocket}
          />
        </details>`;
      };

      const RouteDetailsContent = ({
        method,
        resource,
        description,
        availableContentTypes,
        availableLanguages,
        availableVersions,
        availableEncodings,
        acceptedContentTypes,
        websocket,
      }) => {
        return html`<div class="route_details_content">
          <p style="margin-top: 0"><strong>Description:</strong></p>
          <p class="route_description">
            ${description || "No description available"}
          </p>
          ${availableContentTypes.length > 0 &&
          html`<${RouteContentNegotiationSection}
            type="content-type"
            title="Available content types"
            availableValues=${availableContentTypes}
          />`}
          ${availableLanguages.length > 0 &&
          html`<${RouteContentNegotiationSection}
            type="language"
            title="Available languages"
            availableValues=${availableLanguages}
          />`}
          ${availableVersions.length > 0 &&
          html`<${RouteContentNegotiationSection}
            type="version"
            title="Available versions"
            availableValues=${availableVersions}
          />`}
          ${availableEncodings.length > 0 &&
          html`<${RouteContentNegotiationSection}
            type="encoding"
            title="Available encodings"
            availableValues=${availableEncodings}
          />`}
          ${acceptedContentTypes.length > 0 &&
          html`<${RouteAcceptableContentSection}
            acceptedContentTypes=${acceptedContentTypes}
          />`}
          <p style="margin-bottom:0; font-weight:bold">Example:</p>
          <${RouteCodeExample}
            method=${method}
            resource=${resource}
            availableContentTypes=${availableContentTypes}
            websocket=${websocket}
          />
        </div>`;
      };
      const RouteContentNegotiationSection = ({
        type,
        title,
        availableValues,
      }) => {
        return html`<div class="route_content_nego" data-nego-type="${type}">
          <p class="route_content_nego_title">${title}:</p>
          <ul>
            ${availableValues.map(
              (availableValue) => html`<li>${availableValue}</li>`,
            )}
          </ul>
        </div>`;
      };
      const RouteAcceptableContentSection = ({ acceptedContentTypes }) => {
        return html`<div class="route_accepted_content_type">
          <p><strong>Accepted content types:</strong></p>
          <ul>
            ${acceptedContentTypes.map(
              (acceptedContentType) => html`<li>${acceptedContentType}</li>`,
            )}
          </ul>
        </div>`;
      };

      const RouteCodeExample = ({
        method,
        resource,
        availableContentTypes,
        websocket,
      }) => {
        let jsSource;
        if (websocket) {
          const websocketScheme =
            self.location.protocol === "https:" ? "wss" : "ws";
          const websocketOrigin = `${websocketScheme}://${self.location.host}`;
          jsSource = /*js */ `
const websocket = new WebSocket("${websocketOrigin}${resource}");
websocket.onerror = () => {
  console.error("Failed to connect to websocket endpoint");
};
websocket.onopen = () => {
  console.info("Connected to websocket endpoint")
};
websocket.onmessage = (event) => {
  console.log("Received message", event.data);
};
`;
        } else {
          let fetchLine;
          if (method === "GET") {
            fetchLine = `const response = await window.fetch("${resource}");`;
          } else {
            fetchLine = `const response = await window.fetch("${resource}", {
  method: "${method}",
}`;
          }
          let readResponseLine;
          if (availableContentTypes.includes("application/json")) {
            readResponseLine = `const json = await response.json();`;
          } else {
            readResponseLine = `const text = await response.text();`;
          }

          jsSource = /*js */ `
${fetchLine}
${readResponseLine}
`;
        }

        return html`<code-block lang="js" data-escaped data-copy-button
          >${jsSource}</code-block
        >`;
      };

      const ArrowDown = () => {
        return html`<svg
          xmlns="http://www.w3.org/2000/svg"
          viewBox="0 -960 960 960"
          width="24"
          height="24"
        >
          <path d="M480-345 240-585l56-56 184 184 184-184 56 56-240 240Z" />
        </svg>`;
      };
      const ArrowUp = () => {
        return html`<svg
          xmlns="http://www.w3.org/2000/svg"
          viewBox="0 -960 960 960"
          width="24"
          height="24"
        >
          <path d="M480-528 296-344l-56-56 240-240 240 240-56 56-184-184Z" />
        </svg>`;
      };

      render(html`<${App} />`, document.getElementById("app"));
    </script>
  </body>
</html>
