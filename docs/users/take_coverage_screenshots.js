import { writeFileSync } from "@jsenv/filesystem";
import { chromium as playwrightChromium } from "playwright";

import { startFileServer } from "@jsenv/core/tests/start_file_server.js";

// take screenshot of coverage generated by istanbul
export const takeCoverageScreenshots = async (
  coverageHtmlDirectoryUrl,
  fileUrls,
  {
    // generate smaller screenshots
    width = 640,
    height = 670,
  } = {},
) => {
  const browser = await playwrightChromium.launch();
  const page = await browser.newPage();
  const fileServer = await startFileServer({
    rootDirectoryUrl: coverageHtmlDirectoryUrl,
  });
  for (const fileRelativeUrl of Object.keys(fileUrls)) {
    await page.goto(`${fileServer.origin}/${fileRelativeUrl}.html`);
    await page.setViewportSize({ width, height });
    const wrapperLocator = await page.locator(".wrapper");

    // screenshot
    const screenshotFileUrl = fileUrls[fileRelativeUrl];
    const screenshotBuffer = await wrapperLocator.screenshot();
    writeFileSync(screenshotFileUrl, screenshotBuffer);
  }

  browser.close();
  fileServer.stop();
};
