{
  "version": 3,
  "sources": [
    "../../../src/openServer/createNodeRequestHandler.js"
  ],
  "names": [
    "createRequestFromNodeRequest",
    "nodeRequest",
    "serverURL",
    "method",
    "url",
    "URL",
    "headers",
    "body",
    "undefined",
    "Object",
    "freeze",
    "populateNodeResponse",
    "nodeResponse",
    "status",
    "reason",
    "writeHead",
    "createResponse",
    "createNodeRequestHandler",
    "handler",
    "transform",
    "response",
    "closed",
    "smart",
    "once",
    "emit",
    "request",
    "console",
    "log",
    "toString",
    "on",
    "error",
    "Promise",
    "resolve",
    "then",
    "responseProperties",
    "catch",
    "stack",
    "finalResponse",
    "listen",
    "close",
    "enableCORS",
    "corsHeaders",
    "join"
  ],
  "mappings": "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",
  "sourcesContent": [
    "// https://github.com/jsenv/core/tree/master/src/util/rest\n\nimport { URL } from \"url\"\nimport { createBody, pipe } from \"./createConnection/index.js\"\nimport { headersFromString } from \"./headers.js\"\nimport { createSignal } from \"@dmail/signal\"\n\n// serverURL pourrait valoir par dÃ©faut `file:///${process.cwd()}` ?\nexport const createRequestFromNodeRequest = (nodeRequest, serverURL) => {\n  const { method } = nodeRequest\n  const url = new URL(nodeRequest.url, serverURL)\n  const headers = headersFromString(nodeRequest.headers)\n  const body = createBody(\n    method === \"POST\" || method === \"PUT\" || method === \"PATCH\" ? nodeRequest : undefined,\n  )\n\n  return Object.freeze({\n    method,\n    url,\n    headers,\n    body,\n  })\n}\n\nexport const populateNodeResponse = (nodeResponse, { status, reason = \"\", headers, body }) => {\n  nodeResponse.writeHead(status, reason, headers)\n  pipe(body, nodeResponse)\n}\n\nconst createResponse = (\n  { method }, // this is the request method\n  { status = 501, reason, headers = {}, body = createBody() } = {},\n) => {\n  if (method === \"HEAD\") {\n    // don't send body for HEAD requests\n    body = createBody()\n  }\n  if (body) {\n    body = createBody(body)\n  }\n\n  return Object.freeze({ status, reason, headers, body })\n}\n\nexport const createNodeRequestHandler = ({ handler, transform = (response) => response, url }) => {\n  return (nodeRequest, nodeResponse) => {\n    const closed = createSignal({ smart: true })\n    nodeResponse.once(\"close\", () => closed.emit())\n\n    // should have some kind of id for a request\n    // so that logs knows whichs request they belong to\n    const request = createRequestFromNodeRequest(nodeRequest, url)\n    console.log(request.method, request.url.toString())\n\n    nodeRequest.on(\"error\", (error) => {\n      console.log(\"error on\", request.url.toString(), error)\n    })\n\n    return Promise.resolve()\n      .then(() => {\n        return handler(request)\n      })\n      .then((responseProperties) => {\n        const response = createResponse(request, responseProperties)\n        return transform(response)\n      })\n      .catch((error) => {\n        return createResponse(request, {\n          status: 500,\n          reason: \"internal error\",\n          body: error && error.stack ? error.stack : error,\n        })\n      })\n      .then((finalResponse) => {\n        console.log(`${finalResponse.status} ${request.url}`)\n        // ensure body is closed when client is closed\n        closed.listen(() => {\n          finalResponse.body.close()\n        })\n        populateNodeResponse(nodeResponse, finalResponse)\n      })\n  }\n}\n\nexport const enableCORS = (response) => {\n  const corsHeaders = {\n    \"access-control-allow-origin\": \"*\",\n    \"access-control-allow-methods\": [\"GET\", \"POST\", \"PUT\", \"DELETE\", \"OPTIONS\"].join(\", \"),\n    \"access-control-allow-headers\": [\"x-requested-with\", \"content-type\", \"accept\"].join(\", \"),\n    \"access-control-max-age\": 1, // Seconds\n  }\n\n  return {\n    ...response,\n    headers: {\n      ...corsHeaders,\n      ...response.headers,\n    },\n  }\n}\n"
  ]
}