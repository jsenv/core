{"version":3,"sources":["../../../src/createFileService/createFileService.js"],"names":["mimetype","pathname","defaultMimetype","mimetypes","txt","html","css","appcache","js","json","map","xml","gz","zip","pdf","png","gif","jpg","mp3","suffix","extname","slice","isErrorWithCode","error","code","convertFileSystemErrorToResponseProperties","status","reason","headers","stat","location","Promise","resolve","reject","readFile","buffer","String","listDirectoryContent","readdir","ressourceNames","createFileService","include","locate","url","canReadDirectory","method","requestHeaders","body","promise","then","fileURL","fileLocation","platform","cachedModificationDate","has","Date","get","e","actualModificationDate","mtime","toUTCString","isDirectory","JSON","stringify","directoryListAsJSON","length","Number","size","cachedETag","content","eTag","ETag","createReadStream","responseStatus","responseReason","responseHeaders","responseBody","Object","assign"],"mappings":"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","file":"createFileService.js","sourcesContent":["import fs from \"fs\"\nimport os from \"os\"\nimport path from \"path\"\nimport { URL } from \"url\"\nimport { createETag } from \"../createCompileService/helpers.js\"\n\nconst mimetype = (pathname) => {\n  const defaultMimetype = \"application/octet-stream\"\n\n  const mimetypes = {\n    // text\n    txt: \"text/plain\",\n    html: \"text/html\",\n    css: \"text/css\",\n    appcache: \"text/cache-manifest\",\n    // application\n    js: \"application/javascript\",\n    json: \"application/json\",\n    map: \"application/json\",\n    xml: \"application/xml\",\n    gz: \"application/x-gzip\",\n    zip: \"application/zip\",\n    pdf: \"application/pdf\",\n    // image\n    png: \"image/png\",\n    gif: \"image/gif\",\n    jpg: \"image/jpeg\",\n    // audio\n    mp3: \"audio/mpeg\",\n  }\n\n  const suffix = path.extname(pathname).slice(1)\n  if (suffix in mimetypes) {\n    return mimetypes[suffix]\n  }\n\n  return defaultMimetype\n}\n\nconst isErrorWithCode = (error, code) => {\n  return typeof error === \"object\" && error.code === code\n}\n\nexport const convertFileSystemErrorToResponseProperties = (error) => {\n  // https://iojs.org/api/errors.html#errors_eacces_permission_denied\n  if (isErrorWithCode(error, \"EACCES\")) {\n    return {\n      status: 403,\n      reason: \"no permission to read file\",\n    }\n  }\n\n  if (isErrorWithCode(error, \"EPERM\")) {\n    return {\n      status: 403,\n      reason: \"no permission to read file\",\n    }\n  }\n\n  if (isErrorWithCode(error, \"ENOENT\")) {\n    return {\n      status: 404,\n      reason: \"file not found\",\n    }\n  }\n\n  // file access may be temporarily blocked\n  // (by an antivirus scanning it because recently modified for instance)\n  if (isErrorWithCode(error, \"EBUSY\")) {\n    return {\n      status: 503,\n      reason: \"file is busy\",\n      headers: {\n        \"retry-after\": 0.01, // retry in 10ms\n      },\n    }\n  }\n\n  // emfile means there is too many files currently opened\n  if (isErrorWithCode(error, \"EMFILE\")) {\n    return {\n      status: 503,\n      reason: \"too many file opened\",\n      headers: {\n        \"retry-after\": 0.1, // retry in 100ms\n      },\n    }\n  }\n\n  return {\n    status: 500,\n    reason: \"unknown file system error\",\n  }\n}\n\nconst stat = (location) => {\n  return new Promise((resolve, reject) => {\n    fs.stat(location, (error, stat) => {\n      if (error) {\n        reject(convertFileSystemErrorToResponseProperties(error))\n      } else {\n        resolve(stat)\n      }\n    })\n  })\n}\n\nconst readFile = (location) => {\n  return new Promise((resolve, reject) => {\n    fs.readFile(location, (error, buffer) => {\n      if (error) {\n        reject(convertFileSystemErrorToResponseProperties(error))\n      } else {\n        resolve(String(buffer))\n      }\n    })\n  })\n}\n\nconst listDirectoryContent = (location) => {\n  return new Promise((resolve, reject) => {\n    fs.readdir(location, (error, ressourceNames) => {\n      if (error) {\n        reject(error)\n      } else {\n        resolve(ressourceNames)\n      }\n    })\n  })\n}\n\nexport const createFileService = (\n  { include = () => true, locate = ({ url }) => url, canReadDirectory = false } = {},\n) => ({ method, url, headers: requestHeaders }) => {\n  if (!include(url)) {\n    return false\n  }\n\n  let status\n  let reason\n  const headers = {}\n  let body\n\n  headers[\"cache-control\"] = \"no-store\"\n\n  let promise\n\n  if (method === \"GET\" || method === \"HEAD\") {\n    promise = Promise.resolve(locate({ method, url })).then((fileURL) => {\n      fileURL = new URL(fileURL)\n      // since https://github.com/nodejs/node/pull/10739\n      // fs methods supports url as path\n      // otherwise keep in mind that\n      // new URL('file:///path/to/file.js').pathname returns 'path/to/file.js' on MAC\n      // new URL('file:///C:/path/to/file.js').pathname returns '/C:/path/to/file.js' on WINDOWS\n      // in order words you have to remove the leading '/' on windows\n      // it does not work let's go path removing leading '/' on windows\n      // const fileLocation = fileURL.toString()\n      const fileLocation = os.platform() === \"win32\" ? fileURL.pathname.slice(1) : fileURL.pathname\n\n      let cachedModificationDate\n      if (requestHeaders.has(\"if-modified-since\")) {\n        try {\n          cachedModificationDate = new Date(requestHeaders.get(\"if-modified-since\"))\n        } catch (e) {\n          status = 400\n          reason = \"if-modified-since header is not a valid date\"\n          return {\n            status,\n            reason,\n            headers,\n            body,\n          }\n        }\n      }\n\n      return stat(fileLocation).then(\n        (stat) => {\n          const actualModificationDate = stat.mtime\n\n          headers[\"last-modified\"] = actualModificationDate.toUTCString()\n\n          if (stat.isDirectory()) {\n            if (canReadDirectory === false) {\n              status = 403\n              reason = \"not allowed to read directory\"\n              return\n            }\n\n            return listDirectoryContent(fileLocation)\n              .then(JSON.stringify)\n              .then((directoryListAsJSON) => {\n                status = 200\n                headers[\"content-type\"] = \"application/json\"\n                headers[\"content-length\"] = directoryListAsJSON.length\n                body = directoryListAsJSON\n              })\n          }\n\n          if (\n            cachedModificationDate &&\n            Number(cachedModificationDate) < Number(actualModificationDate)\n          ) {\n            status = 304\n            return\n          }\n\n          headers[\"content-length\"] = stat.size\n\n          const cachedETag = requestHeaders.get(\"if-none-match\")\n          if (cachedETag) {\n            return readFile(fileLocation).then((content) => {\n              const eTag = createETag(content)\n              if (cachedETag === eTag) {\n                status = 304\n              } else {\n                status = 200\n                headers[\"content-type\"] = mimetype(url.pathname)\n                headers.ETag = eTag\n                body = content\n              }\n            })\n          }\n\n          status = 200\n          headers[\"content-type\"] = mimetype(url.pathname)\n          body = fs.createReadStream(fileLocation)\n        },\n        ({\n          status: responseStatus,\n          reason: responseReason,\n          headers: responseHeaders = {},\n          body: responseBody,\n        }) => {\n          status = responseStatus\n          reason = responseReason\n          Object.assign(headers, responseHeaders)\n          body = responseBody\n          return Promise.resolve()\n        },\n      )\n    })\n  } else {\n    status = 501\n    promise = Promise.resolve()\n  }\n\n  return promise.then(() => {\n    return {\n      status,\n      reason,\n      headers,\n      body,\n    }\n  })\n}\n"]}