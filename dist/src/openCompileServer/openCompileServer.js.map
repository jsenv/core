{
  "version": 3,
  "sources": [
    "../../../src/openCompileServer/openCompileServer.js"
  ],
  "names": [
    "guard",
    "fn",
    "shield",
    "args",
    "undefined",
    "getRequiredHelper",
    "rootLocation",
    "instrument",
    "root",
    "then",
    "getMetaForLocation",
    "instrumentPredicate",
    "inputRelativeLocation",
    "Boolean",
    "cover",
    "Promise",
    "resolve",
    "openCompileServer",
    "url",
    "autoCloseOnExit",
    "autoCloseOnCrash",
    "autoCloseOnError",
    "watch",
    "cacheFolderRelativeLocation",
    "abstractFolderRelativeLocation",
    "cors",
    "transpile",
    "sourceMap",
    "sourceURL",
    "minify",
    "optimize",
    "all",
    "helper",
    "server",
    "createWatchServices",
    "fileChangedSSE",
    "open",
    "watchedFiles",
    "Map",
    "closed",
    "listenOnce",
    "forEach",
    "closeWatcher",
    "clear",
    "close",
    "watchPredicate",
    "relativeFilename",
    "endsWith",
    "headers",
    "accept",
    "connect",
    "pathname",
    "slice",
    "dirname",
    "indexOf",
    "length",
    "filename",
    "has",
    "fileWatcher",
    "sendEvent",
    "type",
    "data",
    "set",
    "compileFileFromCompileService",
    "createCompileServiceCustom",
    "compile",
    "createOptions",
    "remap",
    "remapMethod",
    "identify",
    "identifyMethod",
    "service",
    "compileService",
    "compileFile",
    "trackHit",
    "method",
    "createFileServiceCustom",
    "fileService",
    "previousFileService",
    "props",
    "fileURL",
    "URL",
    "handler",
    "services",
    "addRequestHandler",
    "response",
    "compileURL"
  ],
  "mappings": "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",
  "sourcesContent": [
    "// https://github.com/jsenv/core/blob/master/src/api/util/transpiler.js\n\nimport { URL } from \"url\"\nimport { createCompile } from \"../createCompile/createCompile.js\"\nimport { createCompileService } from \"../createCompileService/index.js\"\nimport { createFileService } from \"../createFileService/index.js\"\nimport { createResponseGenerator } from \"../openServer/createResponseGenerator.js\"\nimport { enableCORS } from \"../openServer/createNodeRequestHandler.js\"\nimport { openServer } from \"../openServer/openServer.js\"\nimport { createSSERoom } from \"./createSSERoom.js\"\nimport { watchFile } from \"../watchFile.js\"\nimport { createRoot } from \"@dmail/project-structure\"\n\nconst guard = (fn, shield) => (...args) => {\n  return shield(...args) ? fn(...args) : undefined\n}\n\nconst getRequiredHelper = ({ rootLocation, instrument }) => {\n  if (instrument) {\n    return createRoot({\n      root: rootLocation,\n    }).then(({ getMetaForLocation }) => {\n      const instrumentPredicate = ({ inputRelativeLocation }) => {\n        return Boolean(getMetaForLocation(inputRelativeLocation).cover)\n      }\n\n      return { instrumentPredicate }\n    })\n  }\n  return Promise.resolve({})\n}\n\nexport const openCompileServer = ({\n  // server options\n  url,\n  autoCloseOnExit,\n  autoCloseOnCrash,\n  autoCloseOnError,\n  watch = false,\n  // compile options\n  rootLocation,\n  cacheFolderRelativeLocation = \"build\",\n  abstractFolderRelativeLocation = \"compiled\",\n  cors = true,\n  transpile = true,\n  sourceMap = \"comment\", // can be \"comment\", \"inline\", \"none\"\n  sourceURL = true,\n  minify = false,\n  optimize = false,\n  instrument = false,\n}) => {\n  return Promise.all([\n    getRequiredHelper({ rootLocation, instrument }),\n    openServer({\n      url,\n      autoCloseOnExit,\n      autoCloseOnCrash,\n      autoCloseOnError,\n    }),\n  ])\n    .then(([helper, server]) => {\n      return {\n        server,\n        ...helper,\n      }\n    })\n    .then(({ server, instrumentPredicate }) => {\n      const createWatchServices = () => {\n        // https://github.com/dmail-old/http-eventsource/tree/master/lib\n\n        const fileChangedSSE = createSSERoom()\n        fileChangedSSE.open()\n        const watchedFiles = new Map()\n        server.closed.listenOnce(() => {\n          watchedFiles.forEach((closeWatcher) => closeWatcher())\n          watchedFiles.clear()\n          fileChangedSSE.close()\n        })\n        const watchPredicate = (relativeFilename) => {\n          // for now watch only js files (0 not favicon or .map files)\n          return relativeFilename.endsWith(\".js\")\n        }\n\n        return [\n          ({ headers }) => {\n            if (headers.accept === \"text/event-stream\") {\n              return fileChangedSSE.connect(headers[\"last-event-id\"])\n            }\n            return null\n          },\n          ({ url }) => {\n            let relativeFilename = url.pathname.slice(1)\n            const dirname = relativeFilename.slice(0, relativeFilename.indexOf(\"/\"))\n            if (dirname === abstractFolderRelativeLocation) {\n              // when I ask for a compiled file, watch the corresponding file on filesystem\n              relativeFilename = relativeFilename.slice(abstractFolderRelativeLocation.length + 1)\n            }\n\n            const filename = `${rootLocation}/${relativeFilename}`\n\n            if (watchedFiles.has(filename) === false && watchPredicate(relativeFilename)) {\n              const fileWatcher = watchFile(filename, () => {\n                fileChangedSSE.sendEvent({\n                  type: \"file-changed\",\n                  data: relativeFilename,\n                })\n              })\n              watchedFiles.set(url, fileWatcher)\n            }\n          },\n        ]\n      }\n\n      let compileFileFromCompileService\n      const createCompileServiceCustom = () => {\n        const compile = createCompile({\n          instrumentPredicate,\n          createOptions: () => {\n            // we should use a token or something to prevent a browser from being taken for nodejs\n            // because will have security impact as we are going to trust this\n            // const isNodeClient =\n            //   request.headers.has(\"user-agent\") &&\n            //   request.headers.get(\"user-agent\").startsWith(\"node-fetch\")\n\n            const remap = sourceMap === \"comment\" || sourceMap === \"inline\"\n            const remapMethod = sourceMap\n\n            const identify = sourceURL\n            const identifyMethod = \"relative\"\n\n            return {\n              identify,\n              identifyMethod,\n              transpile,\n              instrument,\n              remap,\n              remapMethod,\n              minify,\n              optimize,\n            }\n          },\n        })\n        const { service: compileService, compileFile } = createCompileService({\n          rootLocation,\n          cacheFolderRelativeLocation,\n          abstractFolderRelativeLocation,\n          trackHit: true,\n          compile,\n        })\n        compileFileFromCompileService = compileFile\n\n        return guard(compileService, ({ method, url }) => {\n          if (method !== \"GET\" && method !== \"HEAD\") {\n            return false\n          }\n\n          const pathname = url.pathname\n          // '/compiled/folder/file.js' -> 'compiled/folder/file.js'\n          const filename = pathname.slice(1)\n          const dirname = filename.slice(0, filename.indexOf(\"/\"))\n\n          if (dirname !== abstractFolderRelativeLocation) {\n            return false\n          }\n\n          return true\n        })\n      }\n\n      const createFileServiceCustom = () => {\n        const fileService = createFileService()\n        const previousFileService = fileService\n        return ({ url, ...props }) => {\n          const fileURL = new URL(url.pathname.slice(1), `file:///${rootLocation}/`)\n\n          return previousFileService({\n            url: fileURL,\n            ...props,\n          })\n        }\n      }\n\n      const handler = createResponseGenerator({\n        services: [\n          ...(watch ? createWatchServices() : []),\n          createCompileServiceCustom(),\n          createFileServiceCustom(),\n        ],\n      })\n\n      server.addRequestHandler(handler, (response) => (cors ? enableCORS(response) : response))\n\n      return {\n        ...server,\n        compileURL: `${server.url}${abstractFolderRelativeLocation}`,\n        rootLocation,\n        abstractFolderRelativeLocation,\n        compileFile: compileFileFromCompileService,\n      }\n    })\n}\n\n// if we want to use react we must start a compileServer like that\n/*\nimport { startCompileServer, defaultTransformer, createBabelOptions } from \"@dmail/dev-server\"\n\nstartCompileServer({\n\ttransformer: (result, options, context) => {\n\t\tconst { inputRelativeLocation } = context\n\t\tif (inputRelativeLocation.endsWith('.jsx')) {\n\t\t\tconst babelOptions = createBabelOptions(result, options, context)\n\t\t\tconst babelOptionWithReact = {\n\t\t\t\t...babelOptions,\n\t\t\t\tplugins: [\n\t\t\t\t\t['babel-plugin-syntax-jsx', {}],\n\t\t\t\t\t['babel-plugin-transform-react-jsx', { \"pragma\": \"React.createElement\" }],\n\t\t\t\t\t...babelOptions.plugins\n\t\t\t\t],\n\t\t\t}\n\t\t\treturn babel.transform(result.code, babelOptionWithReact)\n\t\t]\n\t\treturn defaultTransformer(result, options, context)\n\t}\n})\n*/\n\n// in order to support a build specific to a given browser we could\n/*\nstartCompileServer({\n\tcreateOptions: ({ request }) => {\n\t\t// we could run something client side to decide which\n\t\t// profile the client belongs to between a,b,c and send it by cookie or header\n\t\t// or decide this using user-agent\n\t\tconst profile = request.headers.get('x-client-feature-profile')\n\t\treturn {\n\t\t\tprofile\n\t\t}\n\t},\n\ttransformer: (result, options, context) => {\n\t\tif (options.profile === 'c') {\n\t\t\treturn transformFewThings(result, options, context)\n\t\t}\n\t\tif (options.profile === 'b') {\n\t\t\treturn transformSomeThings(result, options, context)\n\t\t}\n\t\treturn transformAllThings(result, options, context)\n\t}\n})\n*/\n\n// hot reloading https://github.com/dmail-old/es6-project/blob/master/lib/start.js#L62\n// and https://github.com/dmail-old/project/blob/master/lib/sse.js\n"
  ]
}