<!doctype html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Test Smooth Resize Transition</title>
    <style>
      body {
        margin: 40px;
        font-family: Arial, sans-serif;
        background: #f5f5f5;
      }

      .controls {
        display: flex;
        margin-bottom: 40px;
        gap: 10px;
      }

      button {
        padding: 10px 20px;
        color: white;
        font-size: 14px;
        background: #007acc;
        border: none;
        border-radius: 4px;
        cursor: pointer;
      }

      button:hover {
        background: #005a99;
      }

      button.active {
        background: #ff6b35;
      }

      /* Rectangles visibles pour cliquer */
      .rectangles-container {
        display: flex;
        margin-bottom: 40px;
        flex-wrap: wrap;
        gap: 20px;
      }

      .rectangle {
        display: flex;
        box-sizing: border-box;
        padding: 20px;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        border: 2px solid #ddd;
        border-radius: 8px;
        transition:
          transform 0.2s ease,
          box-shadow 0.2s ease;
        cursor: pointer;
      }

      .rectangle[data-state="a"] {
        width: 100px;
        height: 100px;
        color: white;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      }

      .rectangle[data-state="b"] {
        width: 300px;
        height: 150px;
        color: white;
        background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
      }

      .rectangle[data-state="c"] {
        width: 100px;
        height: 200px;
        color: white;
        background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);
      }

      .rectangle h3 {
        margin: 0 0 10px 0;
        font-size: 18px;
      }

      .rectangle p {
        margin: 0;
        font-size: 14px;
        text-align: center;
        line-height: 1.4;
      }

      /* Zone de transition */
      .transition-zone {
        margin-top: 40px;
      }

      .transition-zone h4 {
        margin-bottom: 20px;
        color: #333;
      }

      /* Structure de transition - NOUVELLE APPROCHE */
      .transition-container {
        position: relative;

        /* Pas de taille initiale fixe - sera définie dynamiquement */
        min-width: 100px;
        min-height: 50px;
        background: white;
        border: 2px dashed #ccc;
        border-radius: 8px;

        /* Transition sur les dimensions */
        transition:
          width 3s ease,
          height 3s ease;
      }

      .transition-container.empty {
        display: flex;
        width: 300px;
        height: 80px;
        align-items: center;
        justify-content: center;
        color: #999;
        font-style: italic;
      }

      .content-wrapper {
        display: flex;
        /* Simple wrapper, pas de positionnement absolu */
        width: 100%;
        height: 100%;
        align-items: center;
        justify-content: center;
      }

      .content {
        /* Le contenu garde sa taille naturelle - pas de contraintes */
        display: flex;
        box-sizing: border-box;

        /* Dimensions automatiques basées sur le contenu */
        max-width: 100%;
        max-height: 100%;
        padding: 20px;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        border-radius: 4px;
      }

      /* États des contenus - dimensions détectées automatiquement */
      .content.state-a {
        color: white;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      }

      .content.state-b {
        color: white;
        background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
      }

      .content.state-c {
        color: white;
        background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);
      }

      .content h3 {
        margin: 0 0 10px 0;
        font-size: 18px;
      }

      .content p {
        margin: 0;
        font-size: 14px;
        text-align: center;
        line-height: 1.4;
      }

      /* Debug info */
      .debug-info {
        margin-top: 30px;
        padding: 15px;
        font-size: 12px;
        font-family: monospace;
        background: #f9f9f9;
        border-radius: 4px;
      }

      .debug-info div {
        margin-bottom: 5px;
      }
    </style>
  </head>
  <body>
    <h1>Test de Transition Smooth de Redimensionnement</h1>

    <!-- Rectangles visibles - cliquer pour transitionner -->
    <div class="rectangles-container">
      <div class="rectangle" data-state="a" id="rect-a">
        <h3>État A</h3>
        <p>Du texte yep</p>
      </div>

      <div class="rectangle" data-state="b" id="rect-b">
        <h3>État B</h3>
        <p>
          Rectangle plus grand avec plus de contenu. Ce texte est plus long pour
          voir comment le contenu s'adapte dans un espace plus grand. La
          transition doit être fluide.
        </p>
      </div>

      <div class="rectangle" data-state="c" id="rect-c">
        <h3>État C</h3>
        <p>Format portrait</p>
      </div>
    </div>

    <!-- Zone de transition -->
    <div class="transition-zone">
      <h4>Zone de transition:</h4>
      <div class="transition-container empty" id="container">
        Cliquez sur un rectangle ci-dessus pour voir la transition
      </div>
    </div>

    <div class="debug-info" id="debug">
      <div><strong>Debug Info:</strong></div>
      <div id="container-size">Container: 200px × 100px</div>
      <div id="content-size">Content naturel: -</div>
      <div id="scale-info">Scale: 1</div>
      <div id="state-info">État: A</div>
    </div>

    <script>
      const container = document.getElementById("container");
      let content = null; // Sera créé dynamiquement
      let wrapper = null; // Sera créé dynamiquement

      const debug = {
        containerSize: document.getElementById("container-size"),
        contentSize: document.getElementById("content-size"),
        scaleInfo: document.getElementById("scale-info"),
        stateInfo: document.getElementById("state-info"),
      };

      const DURATION = 3000;
      const DEBUG_KEEP_CLONE = true;

      // États possibles - dimensions détectées automatiquement
      const states = {
        a: {
          contentClass: "state-a",
        },
        b: {
          contentClass: "state-b",
        },
        c: {
          contentClass: "state-c",
        },
      };

      let currentState = "empty";
      let isTransitioning = false;

      // Détection automatique des dimensions d'un rectangle
      function getRectangleDimensions(rectangleId) {
        const rectangle = document.getElementById(rectangleId);
        if (!rectangle) {
          console.warn(`Rectangle ${rectangleId} non trouvé`);
          return { width: 200, height: 100 }; // fallback
        }

        const rect = rectangle.getBoundingClientRect();
        const dimensions = {
          width: Math.round(rect.width),
          height: Math.round(rect.height),
        };

        console.log(`Dimensions détectées pour ${rectangleId}:`, dimensions);
        return dimensions;
      }

      // Créer la structure de contenu dynamiquement
      function createContentStructure() {
        // Nettoyer le container
        container.innerHTML = "";
        container.classList.remove("empty");

        // Ajouter la transition CSS si pas déjà présente
        container.style.transition = `width ${DURATION}ms ease, height ${DURATION}ms ease`;

        // Créer le wrapper
        wrapper = document.createElement("div");
        wrapper.className = "content-wrapper";
        wrapper.id = "wrapper";

        // Créer le contenu
        content = document.createElement("div");
        content.className = "content";
        content.id = "content";

        // Assembler
        wrapper.appendChild(content);
        container.appendChild(wrapper);

        console.log("Structure de contenu créée");
      }

      // Vider la zone de transition
      function clearTransitionZone() {
        container.innerHTML =
          "Cliquez sur un rectangle ci-dessus pour voir la transition";
        container.classList.add("empty");
        container.style.width = "";
        container.style.height = "";

        content = null;
        wrapper = null;
        currentState = "empty";

        console.log("Zone de transition vidée");
      }

      // Mise à jour du debug
      function updateDebugInfo() {
        const containerRect = container.getBoundingClientRect();
        const contentRect = content
          ? content.getBoundingClientRect()
          : { width: 0, height: 0 };

        debug.containerSize.textContent = `Container: ${containerRect.width.toFixed(0)}px × ${containerRect.height.toFixed(0)}px`;
        debug.contentSize.textContent = content
          ? `Content: ${contentRect.width.toFixed(0)}px × ${contentRect.height.toFixed(0)}px`
          : "Content: aucun";
        debug.scaleInfo.textContent = `Clone utilisé: ${isTransitioning ? "Oui" : "Non"}`;
        debug.stateInfo.textContent = `État: ${currentState.toUpperCase()}`;
      }

      // Fonction de clonage du rectangle source
      function cloneRectangle(sourceElement) {
        const clone = sourceElement.cloneNode(true);

        // Ajouter des styles pour identifier le clone
        clone.style.position = "absolute";
        clone.style.opacity = "0.8";
        clone.style.border = "3px solid #ff6b35";
        clone.style.zIndex = "1000";

        console.log("Clone créé:", {
          original: sourceElement.id,
          clone,
          dimensions: `${clone.offsetWidth}x${clone.offsetHeight}`,
        });

        return clone;
      }

      // Transition vers un nouvel état avec cloneNode
      function transitionTo(newState, sourceRectangle) {
        if (isTransitioning) {
          console.log("Transition déjà en cours, ignorée");
          return;
        }

        isTransitioning = true;
        const state = states[newState];

        // Détecter les dimensions du rectangle source
        const targetDimensions = getRectangleDimensions(sourceRectangle.id);

        console.log("Début transition:", {
          from: currentState,
          to: newState,
          targetDimensions,
          sourceElement: sourceRectangle.id,
        });

        // 1. Créer un clone du rectangle source
        const clone = cloneRectangle(sourceRectangle);

        // 2. Positionner le clone temporairement
        const containerRect = container.getBoundingClientRect();
        clone.style.left = `${containerRect.left}px`;
        clone.style.top = `${containerRect.top}px`;
        document.body.appendChild(clone);

        // 3. Créer la structure de contenu si nécessaire
        if (currentState === "empty") {
          createContentStructure();
          // Pour le premier clic, donner des dimensions initiales très petites
          container.style.width = "50px";
          container.style.height = "50px";
        }

        // 4. Mettre le contenu à sa taille finale AVANT l'animation du container
        content.className = `content ${state.contentClass}`;
        content.innerHTML = sourceRectangle.innerHTML;

        // Forcer un reflow pour que le contenu prenne sa taille naturelle
        const FORCE_REFLOW = content.offsetHeight;

        // 5. Démarrer l'animation du conteneur vers les dimensions cibles
        // Le contenu garde sa taille naturelle, le container s'adapte
        setTimeout(
          () => {
            container.style.width = `${targetDimensions.width}px`;
            container.style.height = `${targetDimensions.height}px`;
          },
          currentState === "empty" ? 100 : 50,
        ); // Plus de délai pour le premier clic

        // 6. Nettoyer le clone après la transition
        setTimeout(() => {
          if (!DEBUG_KEEP_CLONE && clone.parentNode) {
            clone.parentNode.removeChild(clone);
          }
          isTransitioning = false;
          console.log("Transition terminée");
        }, DURATION + 100);

        // 7. Mettre à jour l'état
        currentState = newState;
        updateDebugInfo();
      }

      // Gestion des clics sur les rectangles
      function setupRectangleClickHandlers() {
        const rectangles = document.querySelectorAll(".rectangle");

        rectangles.forEach((rectangle) => {
          rectangle.addEventListener("click", () => {
            const targetState = rectangle.dataset.state;
            console.log(`Clic sur rectangle ${targetState}:`, rectangle);

            // Déclencher la transition avec le rectangle source
            transitionTo(targetState, rectangle);
          });

          // Debug info au survol
          rectangle.addEventListener("mouseenter", () => {
            const state = rectangle.dataset.state;
            console.log(`Survol rectangle ${state}:`, {
              dimensions: `${rectangle.offsetWidth}x${rectangle.offsetHeight}`,
              element: rectangle,
            });
          });
        });
      }

      // Bouton de reset
      function addResetButton() {
        const resetButton = document.createElement("button");
        resetButton.textContent = "Vider la zone";
        resetButton.style.marginTop = "10px";
        resetButton.addEventListener("click", clearTransitionZone);

        const transitionZone = document.querySelector(".transition-zone");
        transitionZone.appendChild(resetButton);
      }

      // Initialisation
      function init() {
        setupRectangleClickHandlers();
        addResetButton();
        updateDebugInfo();

        // Mise à jour du debug en continu
        setInterval(updateDebugInfo, 200);

        console.log(
          "Interface initialisée - cliquez sur les rectangles pour transitionner",
        );
      }

      // Lancer l'initialisation quand le DOM est prêt
      if (document.readyState === "loading") {
        document.addEventListener("DOMContentLoaded", init);
      } else {
        init();
      }
    </script>
  </body>
</html>
